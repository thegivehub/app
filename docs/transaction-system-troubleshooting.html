<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>transaction-system-troubleshooting</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #232629;
        color: #7a7c7d;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
    div.sourceCode
      { color: #cfcfc2; background-color: #232629; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #cfcfc2; } /* Normal */
    code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
    code span.an { color: #3f8058; } /* Annotation */
    code span.at { color: #2980b9; } /* Attribute */
    code span.bn { color: #f67400; } /* BaseN */
    code span.bu { color: #7f8c8d; } /* BuiltIn */
    code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #3daee9; } /* Char */
    code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
    code span.co { color: #7a7c7d; } /* Comment */
    code span.cv { color: #7f8c8d; } /* CommentVar */
    code span.do { color: #a43340; } /* Documentation */
    code span.dt { color: #2980b9; } /* DataType */
    code span.dv { color: #f67400; } /* DecVal */
    code span.er { color: #da4453; text-decoration: underline; } /* Error */
    code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
    code span.fl { color: #f67400; } /* Float */
    code span.fu { color: #8e44ad; } /* Function */
    code span.im { color: #27ae60; } /* Import */
    code span.in { color: #c45b00; } /* Information */
    code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
    code span.op { color: #cfcfc2; } /* Operator */
    code span.ot { color: #27ae60; } /* Other */
    code span.pp { color: #27ae60; } /* Preprocessor */
    code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
    code span.sc { color: #3daee9; } /* SpecialChar */
    code span.ss { color: #da4453; } /* SpecialString */
    code span.st { color: #f44f4f; } /* String */
    code span.va { color: #27aeae; } /* Variable */
    code span.vs { color: #da4453; } /* VerbatimString */
    code span.wa { color: #da4453; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="https://cdr2.com/pandoc.css" />
</head>
<body>
<h1 id="the-give-hub-transaction-system-troubleshooting-guide">The Give
Hub Transaction System Troubleshooting Guide</h1>
<p>This guide provides solutions for common issues that may arise when
working with The Give Hub transaction system. It includes diagnostic
steps, common error codes, and recovery procedures.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#common-errors-and-solutions">Common Errors and
Solutions</a></li>
<li><a href="#diagnostic-tools">Diagnostic Tools</a></li>
<li><a href="#recovery-procedures">Recovery Procedures</a></li>
<li><a href="#monitoring-and-alerting">Monitoring and Alerting</a></li>
<li><a href="#faq">FAQ</a></li>
</ul>
<h2 id="common-errors-and-solutions">Common Errors and Solutions</h2>
<h3 id="stellar-transaction-errors">Stellar Transaction Errors</h3>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>Error Code</th>
<th>Description</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>tx_bad_seq</code></td>
<td>Transaction sequence number is incorrect</td>
<td>Reload the source account and recreate the transaction with the
updated sequence number</td>
</tr>
<tr class="even">
<td><code>tx_bad_auth</code></td>
<td>Transaction has an invalid signature</td>
<td>Verify the correct private key is being used to sign the
transaction</td>
</tr>
<tr class="odd">
<td><code>tx_insufficient_balance</code></td>
<td>Source account has insufficient funds</td>
<td>Ensure the source account has enough XLM (including reserve
requirements)</td>
</tr>
<tr class="even">
<td><code>tx_failed</code></td>
<td>Transaction failed during execution</td>
<td>Check operation-specific result codes for more details</td>
</tr>
<tr class="odd">
<td><code>tx_too_late</code></td>
<td>Transaction submitted past its time bounds</td>
<td>Create a new transaction with updated time bounds</td>
</tr>
<tr class="even">
<td><code>tx_fee_bump_inner_failed</code></td>
<td>Fee bump transaction’s inner transaction failed</td>
<td>Check inner transaction result codes</td>
</tr>
</tbody>
</table>
<h3 id="error-transaction-failed-with-op_underfunded">Error: Transaction
Failed with “op_underfunded”</h3>
<p><strong>Problem</strong>: When attempting to process a donation, the
transaction fails with <code>op_underfunded</code> error.</p>
<p><strong>Diagnosis</strong>: 1. Check the source account balance:
<code>javascript    async function checkAccountBalance(publicKey) {      try {        const account = await server.loadAccount(publicKey);        const balances = account.balances.map(b =&gt; ({          asset: b.asset_type === 'native' ? 'XLM' : b.asset_code,          balance: parseFloat(b.balance)        }));        return balances;      } catch (error) {        console.error(`Error checking account ${publicKey}:`, error);        throw error;      }    }</code></p>
<ol start="2" type="1">
<li>Verify Stellar reserve requirements:
<ul>
<li>Base reserve: 1 XLM</li>
<li>Additional reserve per entry: 0.5 XLM</li>
<li>Check total entries: <code>account.subentry_count</code></li>
</ul></li>
</ol>
<p><strong>Solutions</strong>: 1. Fund the source account with
additional XLM 2. Reduce the transaction amount 3. Notify users of
insufficient funds with clear instructions to add funds</p>
<h3 id="error-database-inconsistency">Error: Database Inconsistency</h3>
<p><strong>Problem</strong>: Transaction shows as completed in the
database but cannot be found on the Stellar network.</p>
<p><strong>Diagnosis</strong>: 1. Verify transaction hash against
Horizon API:
<code>javascript    async function verifyTransaction(txHash) {      try {        const tx = await server.transactions().transaction(txHash).call();        return {          exists: true,          successful: tx.successful        };      } catch (error) {        if (error.response &amp;&amp; error.response.status === 404) {          return { exists: false };        }        throw error;      }    }</code></p>
<p><strong>Solutions</strong>: 1. Mark transaction as failed in the
database 2. Implement a reconciliation job to periodically check
database against blockchain: ```javascript // Run as a scheduled job
async function reconcileTransactions(lastHours = 24) { const cutoffDate
= new Date(Date.now() - lastHours * 60 * 60 * 1000);</p>
<pre><code> const transactions = await db.collection(&#39;donations&#39;).find({
   &#39;transaction.timestamp&#39;: { $gte: cutoffDate }
 }).toArray();
 
 const discrepancies = [];
 
 for (const tx of transactions) {
   if (!tx.transaction.txHash) continue;
   
   try {
     const result = await verifyTransaction(tx.transaction.txHash);
     
     if (!result.exists &amp;&amp; tx.status === &#39;completed&#39;) {
       discrepancies.push({
         id: tx._id,
         hash: tx.transaction.txHash,
         issue: &#39;not_found_on_chain&#39;,
         dbStatus: tx.status
       });
       
       // Auto fix
       await db.collection(&#39;donations&#39;).updateOne(
         { _id: tx._id },
         { $set: { status: &#39;failed&#39;, lastReconciled: new Date() } }
       );
     } else if (result.exists &amp;&amp; !result.successful &amp;&amp; tx.status === &#39;completed&#39;) {
       discrepancies.push({
         id: tx._id,
         hash: tx.transaction.txHash,
         issue: &#39;failed_on_chain&#39;,
         dbStatus: tx.status
       });
       
       // Auto fix
       await db.collection(&#39;donations&#39;).updateOne(
         { _id: tx._id },
         { $set: { status: &#39;failed&#39;, lastReconciled: new Date() } }
       );
     } else if (result.exists &amp;&amp; result.successful &amp;&amp; tx.status !== &#39;completed&#39;) {
       discrepancies.push({
         id: tx._id,
         hash: tx.transaction.txHash,
         issue: &#39;completed_on_chain&#39;,
         dbStatus: tx.status
       });
       
       // Auto fix
       await db.collection(&#39;donations&#39;).updateOne(
         { _id: tx._id },
         { $set: { status: &#39;completed&#39;, lastReconciled: new Date() } }
       );
     }
   } catch (error) {
     console.error(`Error reconciling transaction ${tx._id}:`, error);
     continue;
   }
 }
 
 return {
   processed: transactions.length,
   discrepancies: discrepancies.length,
   details: discrepancies
 };</code></pre>
<p>} ```</p>
<h3 id="error-recurring-donation-processing-failures">Error: Recurring
Donation Processing Failures</h3>
<p><strong>Problem</strong>: Scheduled recurring donations are not being
processed.</p>
<p><strong>Diagnosis</strong>: 1. Check the cron job or scheduler logs:
```bash # Check system cron logs grep process-recurring
/var/log/syslog</p>
<p># Check PM2 logs for Node.js scheduled tasks pm2 logs
process-recurring ```</p>
<ol start="2" type="1">
<li><p>Verify database query for due donations:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Expected query</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>db<span class="op">.</span><span class="fu">collection</span>(<span class="st">&#39;donors&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;donationType&#39;</span><span class="op">:</span> <span class="st">&#39;recurring&#39;</span><span class="op">,</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;recurringDetails.status&#39;</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;recurringDetails.nextProcessing&#39;</span><span class="op">:</span> { <span class="dt">$lte</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>() }</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div></li>
</ol>
<p><strong>Solutions</strong>: 1. Ensure the scheduler is running with
correct permissions 2. Fix any database query issues 3. Implement a
catch-up mechanism for missed donations: ```javascript async function
processOverdueRecurringDonations() { const today = new Date(); const
oneWeekAgo = new Date(today); oneWeekAgo.setDate(oneWeekAgo.getDate() -
7);</p>
<pre><code> // Find donations that should have been processed in the last week
 const overdueRecurringDonations = await db.collection(&#39;donors&#39;).find({
   &#39;donationType&#39;: &#39;recurring&#39;,
   &#39;recurringDetails.status&#39;: &#39;active&#39;,
   &#39;recurringDetails.nextProcessing&#39;: { 
     $gte: oneWeekAgo,
     $lte: today
   }
 }).toArray();
 
 console.log(`Found ${overdueRecurringDonations.length} overdue recurring donations`);
 
 // Process them
 const results = await processRecurringDonationsBatch(overdueRecurringDonations);
 
 return results;</code></pre>
<p>} ```</p>
<h2 id="diagnostic-tools">Diagnostic Tools</h2>
<h3 id="transaction-inspector">Transaction Inspector</h3>
<p>A diagnostic tool to inspect transaction details:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// transaction-inspector.js</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> StellarSdk <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;stellar-sdk&#39;</span>)<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mongoose <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;mongoose&#39;</span>)<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="pp">require</span>(<span class="st">&#39;dotenv&#39;</span>)<span class="op">.</span><span class="fu">config</span>()<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Connect to database</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>mongoose<span class="op">.</span><span class="fu">connect</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">MONGODB_URI</span>)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize Stellar server</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="kw">new</span> StellarSdk<span class="op">.</span><span class="fu">Server</span>(</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">STELLAR_NETWORK</span> <span class="op">===</span> <span class="st">&#39;testnet&#39;</span> </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">?</span> <span class="st">&#39;https://horizon-testnet.stellar.org&#39;</span> </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span> <span class="st">&#39;https://horizon.stellar.org&#39;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Main inspection function</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">inspectTransaction</span>(txId) {</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get transaction from database</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(txId)<span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>tx) {</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Transaction not found in database&#39;</span>)<span class="op">;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;TRANSACTION INSPECTION REPORT&#39;</span>)<span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;ID:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">_id</span>)<span class="op">;</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Type:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">type</span>)<span class="op">;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Status:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">status</span>)<span class="op">;</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Amount:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span><span class="op">,</span> tx<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">currency</span>)<span class="op">;</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Created:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">created</span>)<span class="op">;</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get campaign details</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> campaign <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Campaign&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(tx<span class="op">.</span><span class="at">campaignId</span>)<span class="op">;</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">CAMPAIGN DETAILS:&#39;</span>)<span class="op">;</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;ID:&#39;</span><span class="op">,</span> campaign<span class="op">?.</span><span class="at">_id</span> <span class="op">||</span> <span class="st">&#39;Not found&#39;</span>)<span class="op">;</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Title:&#39;</span><span class="op">,</span> campaign<span class="op">?.</span><span class="at">title</span> <span class="op">||</span> <span class="st">&#39;N/A&#39;</span>)<span class="op">;</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Stellar Address:&#39;</span><span class="op">,</span> campaign<span class="op">?.</span><span class="at">stellarAddress</span> <span class="op">||</span> <span class="st">&#39;N/A&#39;</span>)<span class="op">;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get donor details (if not anonymous)</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tx<span class="op">.</span><span class="at">visibility</span> <span class="op">!==</span> <span class="st">&#39;anonymous&#39;</span>) {</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> donor <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donor&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(tx<span class="op">.</span><span class="at">userId</span>)<span class="op">;</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">DONOR DETAILS:&#39;</span>)<span class="op">;</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;ID:&#39;</span><span class="op">,</span> donor<span class="op">?.</span><span class="at">_id</span> <span class="op">||</span> <span class="st">&#39;Not found&#39;</span>)<span class="op">;</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Name:&#39;</span><span class="op">,</span> donor<span class="op">?.</span><span class="at">name</span> <span class="op">||</span> <span class="st">&#39;N/A&#39;</span>)<span class="op">;</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Email:&#39;</span><span class="op">,</span> donor<span class="op">?.</span><span class="at">email</span> <span class="op">||</span> <span class="st">&#39;N/A&#39;</span>)<span class="op">;</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">DONOR DETAILS: Anonymous&#39;</span>)<span class="op">;</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check blockchain status</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tx<span class="op">.</span><span class="at">transaction</span><span class="op">?.</span><span class="at">txHash</span>) {</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">BLOCKCHAIN DETAILS:&#39;</span>)<span class="op">;</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> stellarTx <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">transactions</span>()<span class="op">.</span><span class="fu">transaction</span>(tx<span class="op">.</span><span class="at">transaction</span><span class="op">.</span><span class="at">txHash</span>)<span class="op">.</span><span class="fu">call</span>()<span class="op">;</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Exists on blockchain: Yes&#39;</span>)<span class="op">;</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Successful:&#39;</span><span class="op">,</span> stellarTx<span class="op">.</span><span class="at">successful</span>)<span class="op">;</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Ledger:&#39;</span><span class="op">,</span> stellarTx<span class="op">.</span><span class="at">ledger</span>)<span class="op">;</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Created at:&#39;</span><span class="op">,</span> stellarTx<span class="op">.</span><span class="at">created_at</span>)<span class="op">;</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Source account:&#39;</span><span class="op">,</span> stellarTx<span class="op">.</span><span class="at">source_account</span>)<span class="op">;</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Fee charged:&#39;</span><span class="op">,</span> stellarTx<span class="op">.</span><span class="at">fee_charged</span><span class="op">,</span> <span class="st">&#39;stroops&#39;</span>)<span class="op">;</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get operations</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> operations <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">operations</span>()<span class="op">.</span><span class="fu">forTransaction</span>(tx<span class="op">.</span><span class="at">transaction</span><span class="op">.</span><span class="at">txHash</span>)<span class="op">.</span><span class="fu">call</span>()<span class="op">;</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">OPERATIONS:&#39;</span>)<span class="op">;</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        operations<span class="op">.</span><span class="at">records</span><span class="op">.</span><span class="fu">forEach</span>((op<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Operation </span><span class="sc">${</span>index <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="vs">:`</span>)<span class="op">;</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Type:&#39;</span><span class="op">,</span> op<span class="op">.</span><span class="at">type</span>)<span class="op">;</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (op<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&#39;payment&#39;</span>) {</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  From:&#39;</span><span class="op">,</span> op<span class="op">.</span><span class="at">from</span>)<span class="op">;</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  To:&#39;</span><span class="op">,</span> op<span class="op">.</span><span class="at">to</span>)<span class="op">;</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Amount:&#39;</span><span class="op">,</span> op<span class="op">.</span><span class="at">amount</span><span class="op">,</span> op<span class="op">.</span><span class="at">asset_type</span> <span class="op">===</span> <span class="st">&#39;native&#39;</span> <span class="op">?</span> <span class="st">&#39;XLM&#39;</span> <span class="op">:</span> op<span class="op">.</span><span class="at">asset_code</span>)<span class="op">;</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> <span class="cf">if</span> (op<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&#39;create_account&#39;</span>) {</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Funder:&#39;</span><span class="op">,</span> op<span class="op">.</span><span class="at">funder</span>)<span class="op">;</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Account:&#39;</span><span class="op">,</span> op<span class="op">.</span><span class="at">account</span>)<span class="op">;</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Starting balance:&#39;</span><span class="op">,</span> op<span class="op">.</span><span class="at">starting_balance</span><span class="op">,</span> <span class="st">&#39;XLM&#39;</span>)<span class="op">;</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Add other operation types as needed</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check for any transaction errors</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>stellarTx<span class="op">.</span><span class="at">successful</span>) {</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">TRANSACTION RESULT:&#39;</span>)<span class="op">;</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Failed on blockchain&#39;</span>)<span class="op">;</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Database status:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">status</span>)<span class="op">;</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  INCONSISTENCY DETECTED!&#39;</span>)<span class="op">;</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Exists on blockchain: No&#39;</span>)<span class="op">;</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Error retrieving transaction:&#39;</span><span class="op">,</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (tx<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="st">&#39;completed&#39;</span>) {</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">INCONSISTENCY DETECTED: Transaction marked as completed in database but not found on blockchain&#39;</span>)<span class="op">;</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">BLOCKCHAIN DETAILS: No transaction hash available&#39;</span>)<span class="op">;</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check recurring donation details if applicable</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tx<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&#39;recurring&#39;</span> <span class="op">&amp;&amp;</span> tx<span class="op">.</span><span class="at">recurringDetails</span>) {</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">RECURRING DONATION DETAILS:&#39;</span>)<span class="op">;</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Frequency:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">recurringDetails</span><span class="op">.</span><span class="at">frequency</span>)<span class="op">;</span></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Status:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">recurringDetails</span><span class="op">.</span><span class="at">status</span>)<span class="op">;</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Start date:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">recurringDetails</span><span class="op">.</span><span class="at">startDate</span>)<span class="op">;</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Next processing date:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">recurringDetails</span><span class="op">.</span><span class="at">nextProcessing</span>)<span class="op">;</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (tx<span class="op">.</span><span class="at">recurringDetails</span><span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="st">&#39;cancelled&#39;</span>) {</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Cancelled date:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">recurringDetails</span><span class="op">.</span><span class="at">cancelledDate</span>)<span class="op">;</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Cancelled by:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">recurringDetails</span><span class="op">.</span><span class="at">cancelledBy</span>)<span class="op">;</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check milestone details if applicable</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tx<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&#39;milestone&#39;</span> <span class="op">&amp;&amp;</span> tx<span class="op">.</span><span class="at">milestoneId</span>) {</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">MILESTONE DETAILS:&#39;</span>)<span class="op">;</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> milestone <span class="op">=</span> campaign<span class="op">?.</span><span class="at">timeline</span><span class="op">?.</span><span class="at">milestones</span><span class="op">?.</span><span class="fu">find</span>(m <span class="kw">=&gt;</span> m<span class="op">.</span><span class="at">_id</span><span class="op">.</span><span class="fu">toString</span>() <span class="op">===</span> tx<span class="op">.</span><span class="at">milestoneId</span><span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (milestone) {</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Title:&#39;</span><span class="op">,</span> milestone<span class="op">.</span><span class="at">title</span>)<span class="op">;</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Status:&#39;</span><span class="op">,</span> milestone<span class="op">.</span><span class="at">status</span>)<span class="op">;</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Funding target:&#39;</span><span class="op">,</span> milestone<span class="op">.</span><span class="at">fundingTarget</span>)<span class="op">;</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (milestone<span class="op">.</span><span class="at">completedDate</span>) {</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Completed date:&#39;</span><span class="op">,</span> milestone<span class="op">.</span><span class="at">completedDate</span>)<span class="op">;</span></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Milestone not found in campaign&#39;</span>)<span class="op">;</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error inspecting transaction:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">finally</span> {</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">disconnect</span>()<span class="op">;</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a><span class="co">// If run directly from command line</span></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (require<span class="op">.</span><span class="at">main</span> <span class="op">===</span> module) {</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> txId <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>txId) {</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Please provide a transaction ID&#39;</span>)<span class="op">;</span></span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>    <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inspectTransaction</span>(txId)</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">0</span>))</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> {</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Fatal error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>      <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> { inspectTransaction }<span class="op">;</span></span></code></pre></div>
<h3 id="wallet-diagnostic-tool">Wallet Diagnostic Tool</h3>
<p>A tool to diagnose issues with Stellar wallets:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// wallet-diagnostic.js</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> StellarSdk <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;stellar-sdk&#39;</span>)<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mongoose <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;mongoose&#39;</span>)<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="pp">require</span>(<span class="st">&#39;dotenv&#39;</span>)<span class="op">.</span><span class="fu">config</span>()<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>mongoose<span class="op">.</span><span class="fu">connect</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">MONGODB_URI</span>)<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="kw">new</span> StellarSdk<span class="op">.</span><span class="fu">Server</span>(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">STELLAR_NETWORK</span> <span class="op">===</span> <span class="st">&#39;testnet&#39;</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">?</span> <span class="st">&#39;https://horizon-testnet.stellar.org&#39;</span> </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span> <span class="st">&#39;https://horizon.stellar.org&#39;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">diagnosticWalletCheck</span>(userId) {</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get user wallet</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> wallet <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Wallet&#39;</span>)<span class="op">.</span><span class="fu">findOne</span>({ userId })<span class="op">;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>wallet) {</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Wallet not found for user:&#39;</span><span class="op">,</span> userId)<span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;WALLET DIAGNOSTIC REPORT&#39;</span>)<span class="op">;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User ID:&#39;</span><span class="op">,</span> userId)<span class="op">;</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Public Key:&#39;</span><span class="op">,</span> wallet<span class="op">.</span><span class="at">publicKey</span>)<span class="op">;</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if account exists on blockchain</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> account <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">loadAccount</span>(wallet<span class="op">.</span><span class="at">publicKey</span>)<span class="op">;</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">ACCOUNT EXISTS ON BLOCKCHAIN: Yes&#39;</span>)<span class="op">;</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Print balances</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">BALANCES:&#39;</span>)<span class="op">;</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      account<span class="op">.</span><span class="at">balances</span><span class="op">.</span><span class="fu">forEach</span>(balance <span class="kw">=&gt;</span> {</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (balance<span class="op">.</span><span class="at">asset_type</span> <span class="op">===</span> <span class="st">&#39;native&#39;</span>) {</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;XLM:&#39;</span><span class="op">,</span> balance<span class="op">.</span><span class="at">balance</span>)<span class="op">;</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>balance<span class="op">.</span><span class="at">asset_code</span><span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> balance<span class="op">.</span><span class="at">balance</span>)<span class="op">;</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Calculate minimum balance requirement</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> baseReserve <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// XLM</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> entryReserve <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span> <span class="co">// XLM per entry</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> minBalance <span class="op">=</span> baseReserve <span class="op">+</span> (account<span class="op">.</span><span class="at">subentry_count</span> <span class="op">*</span> entryReserve)<span class="op">;</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> xlmBalance <span class="op">=</span> account<span class="op">.</span><span class="at">balances</span><span class="op">.</span><span class="fu">find</span>(b <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">asset_type</span> <span class="op">===</span> <span class="st">&#39;native&#39;</span>)<span class="op">;</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> availableBalance <span class="op">=</span> xlmBalance <span class="op">?</span> <span class="pp">parseFloat</span>(xlmBalance<span class="op">.</span><span class="at">balance</span>) <span class="op">-</span> minBalance <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">ACCOUNT DETAILS:&#39;</span>)<span class="op">;</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Sequence number:&#39;</span><span class="op">,</span> account<span class="op">.</span><span class="at">sequence</span>)<span class="op">;</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Number of entries:&#39;</span><span class="op">,</span> account<span class="op">.</span><span class="at">subentry_count</span>)<span class="op">;</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Required minimum balance:&#39;</span><span class="op">,</span> minBalance<span class="op">,</span> <span class="st">&#39;XLM&#39;</span>)<span class="op">;</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Available balance (for transactions):&#39;</span><span class="op">,</span> availableBalance<span class="op">,</span> <span class="st">&#39;XLM&#39;</span>)<span class="op">;</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (availableBalance <span class="op">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">WARNING: Low available balance may cause transaction failures&#39;</span>)<span class="op">;</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check recent transactions</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> transactions <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">transactions</span>()</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forAccount</span>(wallet<span class="op">.</span><span class="at">publicKey</span>)</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">limit</span>(<span class="dv">5</span>)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">order</span>(<span class="st">&#39;desc&#39;</span>)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">call</span>()<span class="op">;</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">RECENT TRANSACTIONS:&#39;</span>)<span class="op">;</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> tx <span class="kw">of</span> transactions<span class="op">.</span><span class="at">records</span>) {</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;-&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Created:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">created_at</span>)<span class="op">;</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Successful:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">successful</span>)<span class="op">;</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (tx<span class="op">.</span><span class="at">memo_type</span> <span class="op">!==</span> <span class="st">&#39;none&#39;</span>) {</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Memo:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">memo</span><span class="op">,</span> <span class="vs">`(</span><span class="sc">${</span>tx<span class="op">.</span><span class="at">memo_type</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check if account is being used as expected</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> dbTransactions <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">find</span>({ <span class="st">&#39;userId&#39;</span><span class="op">:</span> userId })</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">sort</span>({ <span class="dt">created</span><span class="op">:</span> <span class="op">-</span><span class="dv">1</span> })</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">limit</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">DATABASE TRANSACTIONS:&#39;</span>)<span class="op">;</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> tx <span class="kw">of</span> dbTransactions) {</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;-&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">_id</span>)<span class="op">;</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Amount:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span><span class="op">,</span> tx<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">currency</span>)<span class="op">;</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Status:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">status</span>)<span class="op">;</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Created:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">created</span>)<span class="op">;</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (tx<span class="op">.</span><span class="at">transaction</span><span class="op">?.</span><span class="at">txHash</span>) {</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  Blockchain hash:&#39;</span><span class="op">,</span> tx<span class="op">.</span><span class="at">transaction</span><span class="op">.</span><span class="at">txHash</span>)<span class="op">;</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;  No blockchain hash found&#39;</span>)<span class="op">;</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error<span class="op">.</span><span class="at">response</span> <span class="op">&amp;&amp;</span> error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">404</span>) {</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">ACCOUNT EXISTS ON BLOCKCHAIN: No&#39;</span>)<span class="op">;</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;This account has not been created on the Stellar network.&#39;</span>)<span class="op">;</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;It needs to be funded with the minimum balance (1 XLM).&#39;</span>)<span class="op">;</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">Error checking account:&#39;</span><span class="op">,</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error running wallet diagnostic:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">finally</span> {</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">disconnect</span>()<span class="op">;</span></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a><span class="co">// If run directly from command line</span></span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (require<span class="op">.</span><span class="at">main</span> <span class="op">===</span> module) {</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> userId <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>userId) {</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Please provide a user ID&#39;</span>)<span class="op">;</span></span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">diagnosticWalletCheck</span>(userId)</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">0</span>))</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> {</span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Fatal error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>      <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> { diagnosticWalletCheck }<span class="op">;</span></span></code></pre></div>
<h3 id="database-consistency-checker">Database Consistency Checker</h3>
<p>A tool to check for database consistency issues:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// db-consistency-checker.js</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mongoose <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;mongoose&#39;</span>)<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="pp">require</span>(<span class="st">&#39;dotenv&#39;</span>)<span class="op">.</span><span class="fu">config</span>()<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>mongoose<span class="op">.</span><span class="fu">connect</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">MONGODB_URI</span>)<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">checkDatabaseConsistency</span>() {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;DATABASE CONSISTENCY REPORT&#39;</span>)<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for donations with completed status but no transaction hash</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> inconsistentCompletedDonations <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span><span class="op">,</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">$or</span><span class="op">:</span> [</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        { <span class="st">&#39;transaction.txHash&#39;</span><span class="op">:</span> { <span class="dt">$exists</span><span class="op">:</span> <span class="kw">false</span> } }<span class="op">,</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        { <span class="st">&#39;transaction.txHash&#39;</span><span class="op">:</span> <span class="kw">null</span> }</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">DONATIONS MARKED COMPLETED WITH NO TRANSACTION HASH:&#39;</span>)<span class="op">;</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Count:&#39;</span><span class="op">,</span> inconsistentCompletedDonations<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (inconsistentCompletedDonations<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Sample IDs:&#39;</span>)<span class="op">;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      inconsistentCompletedDonations<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">.</span><span class="fu">forEach</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;-&#39;</span><span class="op">,</span> d<span class="op">.</span><span class="at">_id</span><span class="op">,</span> <span class="st">&#39;(created:&#39;</span><span class="op">,</span> d<span class="op">.</span><span class="at">created</span><span class="op">,</span> <span class="st">&#39;)&#39;</span>)<span class="op">;</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for failed donations with excessive retries</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> failedWithRetries <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">retryCount</span><span class="op">:</span> { <span class="dt">$gt</span><span class="op">:</span> <span class="dv">3</span> }</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">FAILED DONATIONS WITH EXCESSIVE RETRIES:&#39;</span>)<span class="op">;</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Count:&#39;</span><span class="op">,</span> failedWithRetries<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for pending donations older than 1 hour</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> oneHourAgo <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">;</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    oneHourAgo<span class="op">.</span><span class="fu">setHours</span>(oneHourAgo<span class="op">.</span><span class="fu">getHours</span>() <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stalePendingDonations <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;pending&#39;</span><span class="op">,</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> { <span class="dt">$lt</span><span class="op">:</span> oneHourAgo }</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">STALE PENDING DONATIONS (&gt; 1 HOUR OLD):&#39;</span>)<span class="op">;</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Count:&#39;</span><span class="op">,</span> stalePendingDonations<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (stalePendingDonations<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Sample IDs:&#39;</span>)<span class="op">;</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>      stalePendingDonations<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">.</span><span class="fu">forEach</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;-&#39;</span><span class="op">,</span> d<span class="op">.</span><span class="at">_id</span><span class="op">,</span> <span class="st">&#39;(created:&#39;</span><span class="op">,</span> d<span class="op">.</span><span class="at">created</span><span class="op">,</span> <span class="st">&#39;)&#39;</span>)<span class="op">;</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for campaign funding discrepancies</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> campaigns <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Campaign&#39;</span>)<span class="op">.</span><span class="fu">find</span>()<span class="op">;</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">CAMPAIGN FUNDING CONSISTENCY CHECK:&#39;</span>)<span class="op">;</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> campaignsWithDiscrepancies <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> campaign <span class="kw">of</span> campaigns) {</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Calculate actual funding from donations</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> completedDonations <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>        <span class="dt">campaignId</span><span class="op">:</span> campaign<span class="op">.</span><span class="at">_id</span><span class="op">,</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>        <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> actualFunding <span class="op">=</span> completedDonations<span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> donation) <span class="kw">=&gt;</span> {</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sum <span class="op">+</span> donation<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check for refunds</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> refunds <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Refund&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>        <span class="dt">campaignId</span><span class="op">:</span> campaign<span class="op">.</span><span class="at">_id</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> refundAmount <span class="op">=</span> refunds<span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> refund) <span class="kw">=&gt;</span> {</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sum <span class="op">+</span> refund<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Calculate expected funding</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> expectedFunding <span class="op">=</span> actualFunding <span class="op">-</span> refundAmount<span class="op">;</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Compare with campaign&#39;s recorded funding</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> recordedFunding <span class="op">=</span> campaign<span class="op">.</span><span class="at">funding</span><span class="op">?.</span><span class="at">raisedAmount</span> <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Allow small floating-point differences (0.001 tolerance)</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(expectedFunding <span class="op">-</span> recordedFunding) <span class="op">&gt;</span> <span class="fl">0.001</span>) {</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        campaignsWithDiscrepancies<span class="op">++;</span></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">Discrepancy found for campaign:&#39;</span><span class="op">,</span> campaign<span class="op">.</span><span class="at">_id</span>)<span class="op">;</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Campaign title:&#39;</span><span class="op">,</span> campaign<span class="op">.</span><span class="at">title</span>)<span class="op">;</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Recorded funding:&#39;</span><span class="op">,</span> recordedFunding)<span class="op">;</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Expected funding:&#39;</span><span class="op">,</span> expectedFunding)<span class="op">;</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Difference:&#39;</span><span class="op">,</span> expectedFunding <span class="op">-</span> recordedFunding)<span class="op">;</span></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">Total campaigns with funding discrepancies:&#39;</span><span class="op">,</span> campaignsWithDiscrepancies)<span class="op">;</span></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check recurring donation next payment dates</span></span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> recurringDonorsWithPastDates <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donor&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;donationType&#39;</span><span class="op">:</span> <span class="st">&#39;recurring&#39;</span><span class="op">,</span></span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;recurringDetails.status&#39;</span><span class="op">:</span> <span class="st">&#39;active&#39;</span><span class="op">,</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;recurringDetails.nextProcessing&#39;</span><span class="op">:</span> { <span class="dt">$lt</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>() }</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">RECURRING DONATIONS WITH PAST DUE DATES:&#39;</span>)<span class="op">;</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Count:&#39;</span><span class="op">,</span> recurringDonorsWithPastDates<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">=============================================&#39;</span>)<span class="op">;</span></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error checking database consistency:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">finally</span> {</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">disconnect</span>()<span class="op">;</span></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a><span class="co">// If run directly from command line</span></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (require<span class="op">.</span><span class="at">main</span> <span class="op">===</span> module) {</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkDatabaseConsistency</span>()</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">0</span>))</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> {</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Fatal error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>      <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> { checkDatabaseConsistency }<span class="op">;</span></span></code></pre></div>
<h2 id="recovery-procedures">Recovery Procedures</h2>
<h3 id="resolving-stale-pending-transactions">Resolving Stale Pending
Transactions</h3>
<p>Script to resolve transactions stuck in pending state:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// resolve-stale-pending.js</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mongoose <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;mongoose&#39;</span>)<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> StellarSdk <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;stellar-sdk&#39;</span>)<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="pp">require</span>(<span class="st">&#39;dotenv&#39;</span>)<span class="op">.</span><span class="fu">config</span>()<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>mongoose<span class="op">.</span><span class="fu">connect</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">MONGODB_URI</span>)<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="kw">new</span> StellarSdk<span class="op">.</span><span class="fu">Server</span>(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">STELLAR_NETWORK</span> <span class="op">===</span> <span class="st">&#39;testnet&#39;</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">?</span> <span class="st">&#39;https://horizon-testnet.stellar.org&#39;</span> </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span> <span class="st">&#39;https://horizon.stellar.org&#39;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">resolveStalePendingTransactions</span>(hoursOld <span class="op">=</span> <span class="dv">1</span>) {</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cutoffDate <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    cutoffDate<span class="op">.</span><span class="fu">setHours</span>(cutoffDate<span class="op">.</span><span class="fu">getHours</span>() <span class="op">-</span> hoursOld)<span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Finding pending transactions older than </span><span class="sc">${</span>hoursOld<span class="sc">}</span><span class="vs"> hours...`</span>)<span class="op">;</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stalePendingTxs <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;pending&#39;</span><span class="op">,</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> { <span class="dt">$lt</span><span class="op">:</span> cutoffDate }</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Found </span><span class="sc">${</span>stalePendingTxs<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> stale pending transactions`</span>)<span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> resolved <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> failed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> tx <span class="kw">of</span> stalePendingTxs) {</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// If transaction has a hash, check its status on blockchain</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (tx<span class="op">.</span><span class="at">transaction</span><span class="op">?.</span><span class="at">txHash</span>) {</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>          <span class="cf">try</span> {</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> stellarTx <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">transactions</span>()<span class="op">.</span><span class="fu">transaction</span>(tx<span class="op">.</span><span class="at">transaction</span><span class="op">.</span><span class="at">txHash</span>)<span class="op">.</span><span class="fu">call</span>()<span class="op">;</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update status based on blockchain status</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (stellarTx<span class="op">.</span><span class="at">successful</span>) {</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>              <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>                { <span class="dt">_id</span><span class="op">:</span> tx<span class="op">.</span><span class="at">_id</span> }<span class="op">,</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                { </span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">$set</span><span class="op">:</span> { </span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span><span class="op">,</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;transaction.status&#39;</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span><span class="op">,</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>                  }</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>              )<span class="op">;</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>              <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Transaction </span><span class="sc">${</span>tx<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs"> marked as completed (found on blockchain)`</span>)<span class="op">;</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>              <span class="co">// Update campaign funding</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>              <span class="cf">await</span> <span class="fu">updateCampaignFunding</span>(tx<span class="op">.</span><span class="at">campaignId</span><span class="op">,</span> tx<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>              resolved<span class="op">++;</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>              <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>                { <span class="dt">_id</span><span class="op">:</span> tx<span class="op">.</span><span class="at">_id</span> }<span class="op">,</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>                { </span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">$set</span><span class="op">:</span> { </span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;transaction.status&#39;</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;transaction.error&#39;</span><span class="op">:</span> <span class="st">&#39;Transaction failed on blockchain&#39;</span><span class="op">,</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>                  }</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>              )<span class="op">;</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>              <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Transaction </span><span class="sc">${</span>tx<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs"> marked as failed (found failed on blockchain)`</span>)<span class="op">;</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>              resolved<span class="op">++;</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">catch</span> (error) {</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (error<span class="op">.</span><span class="at">response</span> <span class="op">&amp;&amp;</span> error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">404</span>) {</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>              <span class="co">// Transaction not found on blockchain</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>              <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>                { <span class="dt">_id</span><span class="op">:</span> tx<span class="op">.</span><span class="at">_id</span> }<span class="op">,</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>                { </span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">$set</span><span class="op">:</span> { </span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;transaction.status&#39;</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;transaction.error&#39;</span><span class="op">:</span> <span class="st">&#39;Transaction not found on blockchain&#39;</span><span class="op">,</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>                  }</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>              )<span class="op">;</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>              <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Transaction </span><span class="sc">${</span>tx<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs"> marked as failed (not found on blockchain)`</span>)<span class="op">;</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>              resolved<span class="op">++;</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>              <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Error checking transaction </span><span class="sc">${</span>tx<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>              failed<span class="op">++;</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>          <span class="co">// No transaction hash, mark as failed</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>            { <span class="dt">_id</span><span class="op">:</span> tx<span class="op">.</span><span class="at">_id</span> }<span class="op">,</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>            { </span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>              <span class="dt">$set</span><span class="op">:</span> { </span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>                <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;transaction.status&#39;</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;transaction.error&#39;</span><span class="op">:</span> <span class="st">&#39;No transaction hash available&#39;</span><span class="op">,</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>                <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>          )<span class="op">;</span></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Transaction </span><span class="sc">${</span>tx<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs"> marked as failed (no hash available)`</span>)<span class="op">;</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>          resolved<span class="op">++;</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Error processing transaction </span><span class="sc">${</span>tx<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>        failed<span class="op">++;</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">RESOLUTION SUMMARY:&#39;</span>)<span class="op">;</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Total stale transactions:&#39;</span><span class="op">,</span> stalePendingTxs<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Successfully resolved:&#39;</span><span class="op">,</span> resolved)<span class="op">;</span></span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Failed to resolve:&#39;</span><span class="op">,</span> failed)<span class="op">;</span></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error resolving stale pending transactions:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">finally</span> {</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">disconnect</span>()<span class="op">;</span></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a><span class="co">// Helper function to update campaign funding</span></span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">updateCampaignFunding</span>(campaignId<span class="op">,</span> amount) {</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Campaign&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">_id</span><span class="op">:</span> campaignId }<span class="op">,</span></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>    { </span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>      <span class="dt">$inc</span><span class="op">:</span> { </span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;funding.raisedAmount&#39;</span><span class="op">:</span> amount<span class="op">,</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;funding.donorCount&#39;</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>      <span class="dt">$set</span><span class="op">:</span> { </span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>        <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>() </span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a><span class="co">// If run directly from command line</span></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (require<span class="op">.</span><span class="at">main</span> <span class="op">===</span> module) {</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> hoursOld <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>] <span class="op">?</span> <span class="pp">parseInt</span>(<span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]) <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolveStalePendingTransactions</span>(hoursOld)</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">0</span>))</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> {</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Fatal error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>      <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> { resolveStalePendingTransactions }<span class="op">;</span></span></code></pre></div>
<h3 id="fixing-campaign-funding-discrepancies">Fixing Campaign Funding
Discrepancies</h3>
<p>Script to fix campaign funding discrepancies:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// fix-campaign-funding.js</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mongoose <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;mongoose&#39;</span>)<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="pp">require</span>(<span class="st">&#39;dotenv&#39;</span>)<span class="op">.</span><span class="fu">config</span>()<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>mongoose<span class="op">.</span><span class="fu">connect</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">MONGODB_URI</span>)<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">fixCampaignFunding</span>(campaignId <span class="op">=</span> <span class="kw">null</span>) {</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> campaignsQuery <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (campaignId) {</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      campaignsQuery<span class="op">.</span><span class="at">_id</span> <span class="op">=</span> mongoose<span class="op">.</span><span class="at">Types</span><span class="op">.</span><span class="fu">ObjectId</span>(campaignId)<span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> campaigns <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Campaign&#39;</span>)<span class="op">.</span><span class="fu">find</span>(campaignsQuery)<span class="op">;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Processing </span><span class="sc">${</span>campaigns<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> campaigns...`</span>)<span class="op">;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> fixed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> noDiscrepancy <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> failed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> campaign <span class="kw">of</span> campaigns) {</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate actual funding from donations</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> completedDonations <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>          <span class="dt">campaignId</span><span class="op">:</span> campaign<span class="op">.</span><span class="at">_id</span><span class="op">,</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>          <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> actualFunding <span class="op">=</span> completedDonations<span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> donation) <span class="kw">=&gt;</span> {</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> sum <span class="op">+</span> donation<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check for refunds</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> refunds <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Refund&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>          <span class="dt">campaignId</span><span class="op">:</span> campaign<span class="op">.</span><span class="at">_id</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> refundAmount <span class="op">=</span> refunds<span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> refund) <span class="kw">=&gt;</span> {</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> sum <span class="op">+</span> refund<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate correct funding</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> correctFunding <span class="op">=</span> actualFunding <span class="op">-</span> refundAmount<span class="op">;</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get current funding</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> currentFunding <span class="op">=</span> campaign<span class="op">.</span><span class="at">funding</span><span class="op">?.</span><span class="at">raisedAmount</span> <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Allow small floating-point differences (0.001 tolerance)</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(correctFunding <span class="op">-</span> currentFunding) <span class="op">&gt;</span> <span class="fl">0.001</span>) {</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">\n</span><span class="vs">Fixing campaign: </span><span class="sc">${</span>campaign<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>campaign<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Current funding:&#39;</span><span class="op">,</span> currentFunding)<span class="op">;</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Correct funding:&#39;</span><span class="op">,</span> correctFunding)<span class="op">;</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Difference:&#39;</span><span class="op">,</span> correctFunding <span class="op">-</span> currentFunding)<span class="op">;</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Update campaign funding</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Campaign&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>            { <span class="dt">_id</span><span class="op">:</span> campaign<span class="op">.</span><span class="at">_id</span> }<span class="op">,</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>            { </span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>              <span class="dt">$set</span><span class="op">:</span> { </span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;funding.raisedAmount&#39;</span><span class="op">:</span> correctFunding<span class="op">,</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;funding.lastReconciled&#39;</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">,</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>                <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>          )<span class="op">;</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Funding corrected successfully.&#39;</span>)<span class="op">;</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>          fixed<span class="op">++;</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>          noDiscrepancy<span class="op">++;</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Recalculate donor count</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> uniqueDonors <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">distinct</span>(<span class="st">&#39;userId&#39;</span><span class="op">,</span> {</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>          <span class="dt">campaignId</span><span class="op">:</span> campaign<span class="op">.</span><span class="at">_id</span><span class="op">,</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>          <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> correctDonorCount <span class="op">=</span> uniqueDonors<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> currentDonorCount <span class="op">=</span> campaign<span class="op">.</span><span class="at">funding</span><span class="op">?.</span><span class="at">donorCount</span> <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (correctDonorCount <span class="op">!==</span> currentDonorCount) {</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">\n</span><span class="vs">Fixing donor count for campaign: </span><span class="sc">${</span>campaign<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Current donor count:&#39;</span><span class="op">,</span> currentDonorCount)<span class="op">;</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Correct donor count:&#39;</span><span class="op">,</span> correctDonorCount)<span class="op">;</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Campaign&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>            { <span class="dt">_id</span><span class="op">:</span> campaign<span class="op">.</span><span class="at">_id</span> }<span class="op">,</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>            { </span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>              <span class="dt">$set</span><span class="op">:</span> { </span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;funding.donorCount&#39;</span><span class="op">:</span> correctDonorCount<span class="op">,</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>                <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>          )<span class="op">;</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Donor count corrected successfully.&#39;</span>)<span class="op">;</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Error processing campaign </span><span class="sc">${</span>campaign<span class="op">.</span><span class="at">_id</span><span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>        failed<span class="op">++;</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">SUMMARY:&#39;</span>)<span class="op">;</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Total campaigns processed:&#39;</span><span class="op">,</span> campaigns<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Campaigns fixed:&#39;</span><span class="op">,</span> fixed)<span class="op">;</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Campaigns with no discrepancy:&#39;</span><span class="op">,</span> noDiscrepancy)<span class="op">;</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Failed to process:&#39;</span><span class="op">,</span> failed)<span class="op">;</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error fixing campaign funding:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">finally</span> {</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">disconnect</span>()<span class="op">;</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a><span class="co">// If run directly from command line</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (require<span class="op">.</span><span class="at">main</span> <span class="op">===</span> module) {</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> campaignId <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>] <span class="op">||</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fixCampaignFunding</span>(campaignId)</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">0</span>))</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> {</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Fatal error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>      <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> { fixCampaignFunding }<span class="op">;</span></span></code></pre></div>
<h2 id="monitoring-and-alerting">Monitoring and Alerting</h2>
<h3 id="health-check-api">Health Check API</h3>
<p>Implement a health check API endpoint to monitor system status:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// health-check.js</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> router <span class="op">=</span> express<span class="op">.</span><span class="fu">Router</span>()<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mongoose <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;mongoose&#39;</span>)<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> StellarSdk <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;stellar-sdk&#39;</span>)<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Stellar server</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="kw">new</span> StellarSdk<span class="op">.</span><span class="fu">Server</span>(</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">STELLAR_NETWORK</span> <span class="op">===</span> <span class="st">&#39;testnet&#39;</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">?</span> <span class="st">&#39;https://horizon-testnet.stellar.org&#39;</span> </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span> <span class="st">&#39;https://horizon.stellar.org&#39;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">// MongoDB health check</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">checkMongoDB</span>() {</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mongoose<span class="op">.</span><span class="at">connection</span><span class="op">.</span><span class="at">readyState</span> <span class="op">!==</span> <span class="dv">1</span>) {</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> { <span class="dt">healthy</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;MongoDB not connected&#39;</span> }<span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try a simple query</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> mongoose<span class="op">.</span><span class="at">connection</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">admin</span>()<span class="op">.</span><span class="fu">ping</span>()<span class="op">;</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">healthy</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">;</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">healthy</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> }<span class="op">;</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Stellar health check</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">checkStellar</span>() {</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if Horizon is responsive</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">getHealth</span>()<span class="op">;</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">healthy</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">details</span><span class="op">:</span> {</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="dt">horizonVersion</span><span class="op">:</span> response<span class="op">.</span><span class="at">version</span><span class="op">,</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">coreVersion</span><span class="op">:</span> response<span class="op">.</span><span class="at">core_version</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">healthy</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> }<span class="op">;</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co">// Check transaction processing status</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">checkTransactionProcessing</span>() {</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> oneHourAgo <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">;</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    oneHourAgo<span class="op">.</span><span class="fu">setHours</span>(oneHourAgo<span class="op">.</span><span class="fu">getHours</span>() <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for stale pending transactions</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stalePendingCount <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">countDocuments</span>({</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;pending&#39;</span><span class="op">,</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> { <span class="dt">$lt</span><span class="op">:</span> oneHourAgo }</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for recent failed transactions</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> recentFailedCount <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">countDocuments</span>({</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> { <span class="dt">$gt</span><span class="op">:</span> oneHourAgo }</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for recent successful transactions</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> recentSuccessCount <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">countDocuments</span>({</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span><span class="op">,</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> { <span class="dt">$gt</span><span class="op">:</span> oneHourAgo }</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> healthy <span class="op">=</span> stalePendingCount <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> <span class="co">// Fewer than 5 stale pending transactions</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { </span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>      healthy<span class="op">,</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>      <span class="dt">details</span><span class="op">:</span> {</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stalePendingTransactions</span><span class="op">:</span> stalePendingCount<span class="op">,</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>        <span class="dt">recentFailedTransactions</span><span class="op">:</span> recentFailedCount<span class="op">,</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>        <span class="dt">recentSuccessfulTransactions</span><span class="op">:</span> recentSuccessCount<span class="op">,</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>        <span class="dt">successRate</span><span class="op">:</span> recentSuccessCount <span class="op">+</span> recentFailedCount <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> </span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>          (recentSuccessCount <span class="op">/</span> (recentSuccessCount <span class="op">+</span> recentFailedCount)) <span class="op">*</span> <span class="dv">100</span> <span class="op">:</span> <span class="dv">100</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">healthy</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> }<span class="op">;</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a><span class="co">// Health check endpoint</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Run all health checks in parallel</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> [</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>      mongoStatus<span class="op">,</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>      stellarStatus<span class="op">,</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>      transactionStatus</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    ] <span class="op">=</span> <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>([</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">checkMongoDB</span>()<span class="op">,</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>      <span class="fu">checkStellar</span>()<span class="op">,</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>      <span class="fu">checkTransactionProcessing</span>()</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>    ])<span class="op">;</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Overall status is healthy only if all checks are healthy</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> healthy <span class="op">=</span> mongoStatus<span class="op">.</span><span class="at">healthy</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>                    stellarStatus<span class="op">.</span><span class="at">healthy</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>                    transactionStatus<span class="op">.</span><span class="at">healthy</span><span class="op">;</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> {</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> healthy <span class="op">?</span> <span class="st">&#39;healthy&#39;</span> <span class="op">:</span> <span class="st">&#39;unhealthy&#39;</span><span class="op">,</span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">,</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>      <span class="dt">components</span><span class="op">:</span> {</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>        <span class="dt">mongodb</span><span class="op">:</span> mongoStatus<span class="op">,</span></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stellar</span><span class="op">:</span> stellarStatus<span class="op">,</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>        <span class="dt">transactions</span><span class="op">:</span> transactionStatus</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send appropriate status code</span></span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(healthy <span class="op">?</span> <span class="dv">200</span> <span class="op">:</span> <span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>(response)<span class="op">;</span></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></span></code></pre></div>
<h2 id="faq">FAQ</h2>
<h3 id="how-do-i-test-a-transaction-without-using-real-funds">How do I
test a transaction without using real funds?</h3>
<p>Use the Stellar testnet for development and testing:</p>
<ol type="1">
<li><p>Update configuration to use testnet:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> config <span class="op">=</span> {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">useTestnet</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">horizonUrl</span><span class="op">:</span> <span class="st">&#39;https://horizon-testnet.stellar.org&#39;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div></li>
<li><p>Get test XLM from Stellar’s Friendbot:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">fundTestAccount</span>(publicKey) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`https://friendbot.stellar.org?addr=</span><span class="sc">${</span><span class="pp">encodeURIComponent</span>(publicKey)<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div></li>
</ol>
<h3
id="why-does-a-transaction-show-as-completed-in-database-but-fails-to-appear-in-the-donors-history">Why
does a transaction show as completed in database but fails to appear in
the donor’s history?</h3>
<p>This could be due to:</p>
<ol type="1">
<li><strong>Database inconsistency</strong>: The transaction might be
marked as completed but the relationship to the donor might be
missing</li>
<li><strong>Incorrect donor ID</strong>: The transaction might be
associated with a different donor ID</li>
<li><strong>Visibility settings</strong>: If the donation was marked as
anonymous, it might be filtered out in certain views</li>
</ol>
<p>Solution: Use the transaction inspector tool to check the actual
donor association:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> scripts/transaction-inspector.js [transaction_id]</span></code></pre></div>
<h3 id="how-do-i-handle-chargebacks-or-disputed-transactions">How do I
handle chargebacks or disputed transactions?</h3>
<p>Stellar transactions cannot be reversed once confirmed, so you need
to implement a manual refund process:</p>
<ol type="1">
<li>Record the dispute in your system</li>
<li>Process a refund transaction from the campaign account to the donor
account</li>
<li>Mark the original transaction as refunded</li>
<li>Update campaign funding statistics</li>
<li>Notify all parties involved</li>
</ol>
<p>Use the refund procedure provided in this guide.</p>
<h3 id="how-can-i-add-support-for-a-new-stellar-asset">How can I add
support for a new Stellar asset?</h3>
<p>To add support for a new Stellar asset (token):</p>
<ol type="1">
<li><strong>Update Configuration</strong>: Add the new asset details to
your configuration:</li>
</ol>
<div class="sourceCode" id="cb13"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config/assets.js</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">supported_assets</span><span class="op">:</span> [</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;XLM&#39;</span><span class="op">,</span> <span class="dt">issuer</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;native&#39;</span> }<span class="op">,</span> <span class="co">// Native XLM</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;USDC&#39;</span><span class="op">,</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">issuer</span><span class="op">:</span> <span class="st">&#39;GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5&#39;</span><span class="op">,</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;credit_alphanum4&#39;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add new asset here</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;NEWTOKEN&#39;</span><span class="op">,</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">issuer</span><span class="op">:</span> <span class="st">&#39;GBCJSSWKGV...[issuer public key]&#39;</span><span class="op">,</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;credit_alphanum12&#39;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<ol start="2" type="1">
<li><strong>Update Transaction Builder</strong>: Modify the transaction
builder to handle the new asset:</li>
</ol>
<div class="sourceCode" id="cb14"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In StellarTransactionBuilder.js</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getAssetFromCode</span>(assetCode<span class="op">,</span> assetIssuer <span class="op">=</span> <span class="kw">null</span>) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>assetCode <span class="op">||</span> assetCode <span class="op">===</span> <span class="st">&#39;XLM&#39;</span>) {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> StellarSdk<span class="op">.</span><span class="at">Asset</span><span class="op">.</span><span class="fu">native</span>()<span class="op">;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get asset issuer from configuration if not provided</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>assetIssuer) {</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> assetConfig <span class="op">=</span> config<span class="op">.</span><span class="at">supported_assets</span><span class="op">.</span><span class="fu">find</span>(a <span class="kw">=&gt;</span> a<span class="op">.</span><span class="at">code</span> <span class="op">===</span> assetCode)<span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>assetConfig <span class="op">||</span> <span class="op">!</span>assetConfig<span class="op">.</span><span class="at">issuer</span>) {</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Unknown asset code: </span><span class="sc">${</span>assetCode<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    assetIssuer <span class="op">=</span> assetConfig<span class="op">.</span><span class="at">issuer</span><span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// For alphanumeric4 assets (up to 4 characters)</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (assetCode<span class="op">.</span><span class="at">length</span> <span class="op">&lt;=</span> <span class="dv">4</span>) {</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> StellarSdk<span class="op">.</span><span class="fu">Asset</span>(assetCode<span class="op">,</span> assetIssuer)<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// For alphanumeric12 assets (5-12 characters)</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">new</span> StellarSdk<span class="op">.</span><span class="fu">Asset</span>(assetCode<span class="op">,</span> assetIssuer)<span class="op">;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="3" type="1">
<li><strong>Update Database Schema</strong>: Modify your donation schema
to store asset information:</li>
</ol>
<div class="sourceCode" id="cb15"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// models/Donation.js</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DonationSchema <span class="op">=</span> <span class="kw">new</span> mongoose<span class="op">.</span><span class="fu">Schema</span>({</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... existing fields</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">amount</span><span class="op">:</span> {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="bu">Number</span><span class="op">,</span> <span class="dt">required</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">,</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">currency</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="bu">String</span><span class="op">,</span> <span class="dt">required</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="cf">default</span><span class="op">:</span> <span class="st">&#39;XLM&#39;</span> }<span class="op">,</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">issuer</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="bu">String</span><span class="op">,</span> <span class="cf">default</span><span class="op">:</span> <span class="kw">null</span> } <span class="co">// Add issuer field</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... other fields</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<ol start="4" type="1">
<li><p><strong>Update UI</strong>: Update user interface to include the
new asset in dropdown menus</p></li>
<li><p><strong>Test Thoroughly</strong>: Test all transaction types with
the new asset</p></li>
</ol>
<h3 id="how-do-i-handle-timeouts-during-transaction-submission">How do I
handle timeouts during transaction submission?</h3>
<p>Stellar transactions can sometimes time out during submission.
Implement a robust retry mechanism:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Submit transaction with automatic retry for timeout errors</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{Transaction}</span><span class="co"> transaction - Signed Stellar transaction</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{Object}</span><span class="co"> options - Options for submission</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise} - Resolves to transaction result</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">submitTransactionWithTimeout</span>(transaction<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> maxRetries <span class="op">=</span> options<span class="op">.</span><span class="at">maxRetries</span> <span class="op">||</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> initialTimeout <span class="op">=</span> options<span class="op">.</span><span class="at">initialTimeout</span> <span class="op">||</span> <span class="dv">30000</span><span class="op">;</span> <span class="co">// 30 seconds</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> lastError<span class="op">;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> attempt <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> attempt <span class="op">&lt;=</span> maxRetries<span class="op">;</span> attempt<span class="op">++</span>) {</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Submit transaction with specific timeout</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> timeout <span class="op">=</span> initialTimeout <span class="op">*</span> attempt<span class="op">;</span> <span class="co">// Increase timeout with each retry</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">race</span>([</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        server<span class="op">.</span><span class="fu">submitTransaction</span>(transaction)<span class="op">,</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Promise</span>((_<span class="op">,</span> reject) <span class="kw">=&gt;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>          <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="fu">reject</span>(<span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Submission timeout&#39;</span>))<span class="op">,</span> timeout)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>      ])<span class="op">;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>      lastError <span class="op">=</span> error<span class="op">;</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Only retry on timeout or specific recoverable errors</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        error<span class="op">.</span><span class="at">message</span> <span class="op">===</span> <span class="st">&#39;Submission timeout&#39;</span> <span class="op">||</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        (error<span class="op">.</span><span class="at">response</span> <span class="op">&amp;&amp;</span> error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">504</span>) <span class="op">||</span> <span class="co">// Gateway timeout</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>        (error<span class="op">.</span><span class="at">response</span> <span class="op">&amp;&amp;</span> error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">data</span> <span class="op">&amp;&amp;</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>         error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">extras</span> <span class="op">&amp;&amp;</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>         error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">extras</span><span class="op">.</span><span class="at">result_codes</span> <span class="op">&amp;&amp;</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>         error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">extras</span><span class="op">.</span><span class="at">result_codes</span><span class="op">.</span><span class="at">transaction</span> <span class="op">===</span> <span class="st">&#39;tx_too_late&#39;</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>      ) {</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Transaction retry </span><span class="sc">${</span>attempt<span class="sc">}</span><span class="vs">/</span><span class="sc">${</span>maxRetries<span class="sc">}</span><span class="vs"> after timeout`</span>)<span class="op">;</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (attempt <span class="op">&lt;</span> maxRetries) {</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Wait before retrying (exponential backoff)</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>            <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">1000</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> attempt <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>          )<span class="op">;</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>          <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Non-recoverable error or max retries reached</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> lastError<span class="op">;</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> lastError<span class="op">;</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3
id="how-do-i-verify-if-a-transaction-was-successful-when-my-application-crashes-mid-processing">How
do I verify if a transaction was successful when my application crashes
mid-processing?</h3>
<p>If your application crashes after submitting a transaction but before
updating the database, you can verify the transaction status:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Verify transaction status and update database</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> txHash - Transaction hash</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> donationId - Database donation ID</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise} - Resolves to updated donation</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">verifyAndUpdateTransaction</span>(txHash<span class="op">,</span> donationId) {</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get transaction from blockchain</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">transactions</span>()<span class="op">.</span><span class="fu">transaction</span>(txHash)<span class="op">.</span><span class="fu">call</span>()<span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get donation from database</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> donation <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(donationId)<span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>donation) {</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Donation not found: </span><span class="sc">${</span>donationId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if already processed</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (donation<span class="op">.</span><span class="at">status</span> <span class="op">!==</span> <span class="st">&#39;pending&#39;</span>) {</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Donation </span><span class="sc">${</span>donationId<span class="sc">}</span><span class="vs"> already processed with status: </span><span class="sc">${</span>donation<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> donation<span class="op">;</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update based on blockchain status</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tx<span class="op">.</span><span class="at">successful</span>) {</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update donation status to completed</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">_id</span><span class="op">:</span> donationId }<span class="op">,</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>          <span class="dt">$set</span><span class="op">:</span> {</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span><span class="op">,</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;transaction.status&#39;</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span><span class="op">,</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;transaction.timestamp&#39;</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>(tx<span class="op">.</span><span class="at">created_at</span>)<span class="op">,</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>            <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update campaign funding</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="fu">updateCampaignFunding</span>(donation<span class="op">.</span><span class="at">campaignId</span><span class="op">,</span> donation<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Donation </span><span class="sc">${</span>donationId<span class="sc">}</span><span class="vs"> verified and marked as completed`</span>)<span class="op">;</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update donation status to failed</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">_id</span><span class="op">:</span> donationId }<span class="op">,</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>          <span class="dt">$set</span><span class="op">:</span> {</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>            <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;transaction.status&#39;</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;transaction.error&#39;</span><span class="op">:</span> <span class="st">&#39;Transaction failed on blockchain&#39;</span><span class="op">,</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>            <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Donation </span><span class="sc">${</span>donationId<span class="sc">}</span><span class="vs"> verified and marked as failed`</span>)<span class="op">;</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return updated donation</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(donationId)<span class="op">;</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error<span class="op">.</span><span class="at">response</span> <span class="op">&amp;&amp;</span> error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">404</span>) {</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Transaction not found on blockchain</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Transaction </span><span class="sc">${</span>txHash<span class="sc">}</span><span class="vs"> not found on blockchain`</span>)<span class="op">;</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check how old the donation is</span></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> donation <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(donationId)<span class="op">;</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> thirtyMinutesAgo <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> <span class="dv">30</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If donation is older than 30 minutes, mark as failed</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (donation <span class="op">&amp;&amp;</span> donation<span class="op">.</span><span class="at">created</span> <span class="op">&lt;</span> thirtyMinutesAgo) {</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>          { <span class="dt">_id</span><span class="op">:</span> donationId }<span class="op">,</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>          {</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>            <span class="dt">$set</span><span class="op">:</span> {</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>              <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>              <span class="st">&#39;transaction.status&#39;</span><span class="op">:</span> <span class="st">&#39;failed&#39;</span><span class="op">,</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>              <span class="st">&#39;transaction.error&#39;</span><span class="op">:</span> <span class="st">&#39;Transaction not found on blockchain after 30 minutes&#39;</span><span class="op">,</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>              <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Donation </span><span class="sc">${</span>donationId<span class="sc">}</span><span class="vs"> marked as failed (not found on blockchain after 30 minutes)`</span>)<span class="op">;</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Less than 30 minutes old, wait longer</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Donation </span><span class="sc">${</span>donationId<span class="sc">}</span><span class="vs"> is recent, keeping as pending`</span>)<span class="op">;</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Error verifying transaction </span><span class="sc">${</span>txHash<span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3
id="how-do-i-handle-ledger-full-errors-during-high-volume-donation-periods">How
do I handle ledger full errors during high volume donation periods?</h3>
<p>During high network traffic, Stellar may return “tx_insufficient_fee”
errors. Implement a dynamic fee strategy:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Get recommended fee based on network conditions</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise</span><span class="kw">&lt;number&gt;</span><span class="co">} - Stellar transaction fee in stroops</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">getDynamicFee</span>() {</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get fee stats from Horizon</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> feeStats <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">feeStats</span>()<span class="op">;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get fee percentiles</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> p10 <span class="op">=</span> <span class="pp">parseInt</span>(feeStats<span class="op">.</span><span class="at">fee_charged</span><span class="op">.</span><span class="at">p10</span>)<span class="op">;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> p50 <span class="op">=</span> <span class="pp">parseInt</span>(feeStats<span class="op">.</span><span class="at">fee_charged</span><span class="op">.</span><span class="at">p50</span>)<span class="op">;</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> p90 <span class="op">=</span> <span class="pp">parseInt</span>(feeStats<span class="op">.</span><span class="at">fee_charged</span><span class="op">.</span><span class="at">p90</span>)<span class="op">;</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate recommended fee based on network congestion</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> recommendedFee<span class="op">;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// If network is congested (p90 significantly higher than p10)</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (p90 <span class="op">&gt;</span> p10 <span class="op">*</span> <span class="dv">5</span>) {</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Network is congested, use p90 for faster processing</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>      recommendedFee <span class="op">=</span> p90<span class="op">;</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Normal network conditions, use median (p50)</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>      recommendedFee <span class="op">=</span> p50<span class="op">;</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add 20% buffer and ensure minimum BASE_FEE</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    recommendedFee <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>      StellarSdk<span class="op">.</span><span class="at">BASE_FEE</span><span class="op">,</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Math</span><span class="op">.</span><span class="fu">ceil</span>(recommendedFee <span class="op">*</span> <span class="fl">1.2</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Dynamic fee: </span><span class="sc">${</span>recommendedFee<span class="sc">}</span><span class="vs"> stroops`</span>)<span class="op">;</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> recommendedFee<span class="op">;</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error getting fee stats:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback to 2x BASE_FEE</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> StellarSdk<span class="op">.</span><span class="at">BASE_FEE</span> <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="co"> * Retry transaction with increased fee</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{Transaction}</span><span class="co"> transaction - Original transaction that failed</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> sourceSecret - Source account secret key</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise} - New transaction result</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">retryWithHigherFee</span>(transaction<span class="op">,</span> sourceSecret) {</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create fee bump transaction</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sourceKeypair <span class="op">=</span> StellarSdk<span class="op">.</span><span class="at">Keypair</span><span class="op">.</span><span class="fu">fromSecret</span>(sourceSecret)<span class="op">;</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get a higher fee (3x the original or based on network conditions)</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dynamicFee <span class="op">=</span> <span class="cf">await</span> <span class="fu">getDynamicFee</span>()<span class="op">;</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> higherFee <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>      <span class="pp">parseInt</span>(transaction<span class="op">.</span><span class="at">fee</span>) <span class="op">*</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>      dynamicFee</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create fee bump transaction</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> feeBumpTransaction <span class="op">=</span> StellarSdk<span class="op">.</span><span class="at">TransactionBuilder</span><span class="op">.</span><span class="fu">buildFeeBumpTransaction</span>(</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>      sourceKeypair<span class="op">,</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>      higherFee<span class="op">,</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>      transaction<span class="op">,</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>      StellarSdk<span class="op">.</span><span class="at">Networks</span><span class="op">.</span><span class="at">PUBLIC</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sign and submit</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    feeBumpTransaction<span class="op">.</span><span class="fu">sign</span>(sourceKeypair)<span class="op">;</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">submitTransaction</span>(feeBumpTransaction)<span class="op">;</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error retrying with higher fee:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="how-do-i-debug-a-transaction-that-has-a-tx_bad_auth-error">How
do I debug a transaction that has a tx_bad_auth error?</h3>
<p>The “tx_bad_auth” error indicates an authentication problem with the
transaction:</p>
<ol type="1">
<li><p><strong>Check the signing keys</strong>: Ensure the correct
account is signing the transaction</p></li>
<li><p><strong>Verify the key has proper permissions</strong>:</p></li>
</ol>
<div class="sourceCode" id="cb19"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Verify signing permissions</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> publicKey - Account public key</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise</span><span class="kw">&lt;Object&gt;</span><span class="co">} - Account signers and thresholds</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">verifySigningPermissions</span>(publicKey) {</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load account</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> account <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">loadAccount</span>(publicKey)<span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get signers and thresholds</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> signers <span class="op">=</span> account<span class="op">.</span><span class="at">signers</span><span class="op">;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> thresholds <span class="op">=</span> {</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">low</span><span class="op">:</span> account<span class="op">.</span><span class="at">thresholds</span><span class="op">.</span><span class="at">low_threshold</span><span class="op">,</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">medium</span><span class="op">:</span> account<span class="op">.</span><span class="at">thresholds</span><span class="op">.</span><span class="at">med_threshold</span><span class="op">,</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">high</span><span class="op">:</span> account<span class="op">.</span><span class="at">thresholds</span><span class="op">.</span><span class="at">high_threshold</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Account signers:&#39;</span>)<span class="op">;</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    signers<span class="op">.</span><span class="fu">forEach</span>(signer <span class="kw">=&gt;</span> {</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`- </span><span class="sc">${</span>signer<span class="op">.</span><span class="at">key</span><span class="sc">}</span><span class="vs"> (weight: </span><span class="sc">${</span>signer<span class="op">.</span><span class="at">weight</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Account thresholds:&#39;</span>)<span class="op">;</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(thresholds)<span class="op">;</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { signers<span class="op">,</span> thresholds }<span class="op">;</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error verifying signing permissions:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="3" type="1">
<li><p><strong>Check for multi-signature requirements</strong>: Some
accounts may require multiple signatures</p></li>
<li><p><strong>Verify transaction source account</strong>: Ensure the
transaction is using the correct source account</p></li>
</ol>
<h3 id="how-do-i-monitor-the-health-of-the-transaction-system">How do I
monitor the health of the transaction system?</h3>
<p>Implement a comprehensive monitoring system:</p>
<ol type="1">
<li><strong>Transaction Success Rate Alert</strong>:</li>
</ol>
<div class="sourceCode" id="cb20"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Check transaction success rate</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{number}</span><span class="co"> timeWindowMinutes - Time window in minutes</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{number}</span><span class="co"> alertThreshold - Alert threshold percentage</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise</span><span class="kw">&lt;Object&gt;</span><span class="co">} - Success rate report</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">monitorTransactionSuccessRate</span>(timeWindowMinutes <span class="op">=</span> <span class="dv">60</span><span class="op">,</span> alertThreshold <span class="op">=</span> <span class="dv">90</span>) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> timeWindow <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    timeWindow<span class="op">.</span><span class="fu">setMinutes</span>(timeWindow<span class="op">.</span><span class="fu">getMinutes</span>() <span class="op">-</span> timeWindowMinutes)<span class="op">;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Count total transactions</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> totalTx <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">countDocuments</span>({</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> { <span class="dt">$gte</span><span class="op">:</span> timeWindow }<span class="op">,</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> { <span class="dt">$in</span><span class="op">:</span> [<span class="st">&#39;completed&#39;</span><span class="op">,</span> <span class="st">&#39;failed&#39;</span>] }</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Count successful transactions</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> successfulTx <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">countDocuments</span>({</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> { <span class="dt">$gte</span><span class="op">:</span> timeWindow }<span class="op">,</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate success rate</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> successRate <span class="op">=</span> totalTx <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> (successfulTx <span class="op">/</span> totalTx) <span class="op">*</span> <span class="dv">100</span> <span class="op">:</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> status <span class="op">=</span> successRate <span class="op">&gt;=</span> alertThreshold <span class="op">?</span> <span class="st">&#39;healthy&#39;</span> <span class="op">:</span> <span class="st">&#39;warning&#39;</span><span class="op">;</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send alert if below threshold</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (successRate <span class="op">&lt;</span> alertThreshold) {</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="fu">sendAlert</span>({</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;transaction_success_rate&#39;</span><span class="op">,</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">level</span><span class="op">:</span> <span class="st">&#39;warning&#39;</span><span class="op">,</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="vs">`Transaction success rate (</span><span class="sc">${</span>successRate<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">%) below threshold (</span><span class="sc">${</span>alertThreshold<span class="sc">}</span><span class="vs">%)`</span><span class="op">,</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">details</span><span class="op">:</span> {</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>          <span class="dt">timeWindow</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>timeWindowMinutes<span class="sc">}</span><span class="vs"> minutes`</span><span class="op">,</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>          <span class="dt">totalTransactions</span><span class="op">:</span> totalTx<span class="op">,</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>          <span class="dt">successfulTransactions</span><span class="op">:</span> successfulTx<span class="op">,</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>          <span class="dt">successRate</span><span class="op">:</span> successRate</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>      status<span class="op">,</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>      successRate<span class="op">,</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>      <span class="dt">totalTransactions</span><span class="op">:</span> totalTx<span class="op">,</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>      <span class="dt">successfulTransactions</span><span class="op">:</span> successfulTx<span class="op">,</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timeWindow</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>timeWindowMinutes<span class="sc">}</span><span class="vs"> minutes`</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error monitoring transaction success rate:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="2" type="1">
<li><strong>Stale Pending Transactions Monitor</strong>:</li>
</ol>
<div class="sourceCode" id="cb21"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Monitor for stale pending transactions</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{number}</span><span class="co"> staleThrMinutes - Stale threshold in minutes</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise</span><span class="kw">&lt;Object&gt;</span><span class="co">} - Stale transaction report</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">monitorStalePendingTransactions</span>(staleThrMinutes <span class="op">=</span> <span class="dv">30</span>) {</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> staleThreshold <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    staleThreshold<span class="op">.</span><span class="fu">setMinutes</span>(staleThreshold<span class="op">.</span><span class="fu">getMinutes</span>() <span class="op">-</span> staleThrMinutes)<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find stale pending transactions</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> staleTx <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">find</span>({</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;pending&#39;</span><span class="op">,</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> { <span class="dt">$lt</span><span class="op">:</span> staleThreshold }</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">sort</span>({ <span class="dt">created</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">.</span><span class="fu">limit</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send alert if stale transactions found</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (staleTx<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="fu">sendAlert</span>({</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;stale_pending_transactions&#39;</span><span class="op">,</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">level</span><span class="op">:</span> staleTx<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">10</span> <span class="op">?</span> <span class="st">&#39;critical&#39;</span> <span class="op">:</span> <span class="st">&#39;warning&#39;</span><span class="op">,</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>staleTx<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> transactions stuck in pending state for over </span><span class="sc">${</span>staleThrMinutes<span class="sc">}</span><span class="vs"> minutes`</span><span class="op">,</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">details</span><span class="op">:</span> {</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">count</span><span class="op">:</span> staleTx<span class="op">.</span><span class="at">length</span><span class="op">,</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>          <span class="dt">oldest</span><span class="op">:</span> staleTx[<span class="dv">0</span>]<span class="op">.</span><span class="at">created</span><span class="op">,</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>          <span class="dt">sampleIds</span><span class="op">:</span> staleTx<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">.</span><span class="fu">map</span>(tx <span class="kw">=&gt;</span> tx<span class="op">.</span><span class="at">_id</span><span class="op">.</span><span class="fu">toString</span>())</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> staleTx<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">10</span> <span class="op">?</span> <span class="st">&#39;critical&#39;</span> <span class="op">:</span> (staleTx<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">&#39;warning&#39;</span> <span class="op">:</span> <span class="st">&#39;healthy&#39;</span>)<span class="op">,</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">count</span><span class="op">:</span> staleTx<span class="op">.</span><span class="at">length</span><span class="op">,</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">oldest</span><span class="op">:</span> staleTx<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> staleTx[<span class="dv">0</span>]<span class="op">.</span><span class="at">created</span> <span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">threshold</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>staleThrMinutes<span class="sc">}</span><span class="vs"> minutes`</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error monitoring stale pending transactions:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="3" type="1">
<li><strong>Account Balance Monitor</strong>:</li>
</ol>
<div class="sourceCode" id="cb22"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Monitor critical account balances</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise</span><span class="kw">&lt;Object&gt;</span><span class="co">} - Account balance report</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">monitorAccountBalances</span>() {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get critical account public keys from configuration</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> criticalAccounts <span class="op">=</span> config<span class="op">.</span><span class="at">monitored_accounts</span> <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> results <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> account <span class="kw">of</span> criticalAccounts) {</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load account from Stellar</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> accountData <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">loadAccount</span>(account<span class="op">.</span><span class="at">publicKey</span>)<span class="op">;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get XLM balance</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xlmBalance <span class="op">=</span> accountData<span class="op">.</span><span class="at">balances</span><span class="op">.</span><span class="fu">find</span>(b <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">asset_type</span> <span class="op">===</span> <span class="st">&#39;native&#39;</span>)<span class="op">;</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> balance <span class="op">=</span> xlmBalance <span class="op">?</span> <span class="pp">parseFloat</span>(xlmBalance<span class="op">.</span><span class="at">balance</span>) <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate minimum balance requirement</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> baseReserve <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// XLM</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> entryReserve <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span> <span class="co">// XLM per entry</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> minBalance <span class="op">=</span> baseReserve <span class="op">+</span> (accountData<span class="op">.</span><span class="at">subentry_count</span> <span class="op">*</span> entryReserve)<span class="op">;</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate available balance</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> availableBalance <span class="op">=</span> balance <span class="op">-</span> minBalance<span class="op">;</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check against threshold</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> threshold <span class="op">=</span> account<span class="op">.</span><span class="at">threshold</span> <span class="op">||</span> <span class="dv">100</span><span class="op">;</span> <span class="co">// Default 100 XLM</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> status <span class="op">=</span> availableBalance <span class="op">&lt;</span> threshold <span class="op">?</span> <span class="st">&#39;warning&#39;</span> <span class="op">:</span> <span class="st">&#39;healthy&#39;</span><span class="op">;</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Send alert if below threshold</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (availableBalance <span class="op">&lt;</span> threshold) {</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> <span class="fu">sendAlert</span>({</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>            <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;low_account_balance&#39;</span><span class="op">,</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            <span class="dt">level</span><span class="op">:</span> availableBalance <span class="op">&lt;</span> threshold <span class="op">/</span> <span class="dv">2</span> <span class="op">?</span> <span class="st">&#39;critical&#39;</span> <span class="op">:</span> <span class="st">&#39;warning&#39;</span><span class="op">,</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>            <span class="dt">message</span><span class="op">:</span> <span class="vs">`Account </span><span class="sc">${</span>account<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>account<span class="op">.</span><span class="at">publicKey</span><span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>)<span class="sc">}</span><span class="vs">...</span><span class="sc">${</span>account<span class="op">.</span><span class="at">publicKey</span><span class="op">.</span><span class="fu">slice</span>(<span class="op">-</span><span class="dv">5</span>)<span class="sc">}</span><span class="vs">) has low balance: </span><span class="sc">${</span>availableBalance<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> XLM available`</span><span class="op">,</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>            <span class="dt">details</span><span class="op">:</span> {</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>              <span class="dt">account</span><span class="op">:</span> account<span class="op">.</span><span class="at">publicKey</span><span class="op">,</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>              <span class="dt">name</span><span class="op">:</span> account<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>              <span class="dt">balance</span><span class="op">:</span> balance<span class="op">,</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>              <span class="dt">minRequired</span><span class="op">:</span> minBalance<span class="op">,</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>              <span class="dt">available</span><span class="op">:</span> availableBalance<span class="op">,</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>              <span class="dt">threshold</span><span class="op">:</span> threshold</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        results<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>          <span class="dt">account</span><span class="op">:</span> account<span class="op">.</span><span class="at">publicKey</span><span class="op">,</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>          <span class="dt">name</span><span class="op">:</span> account<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>          status<span class="op">,</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>          balance<span class="op">,</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>          <span class="dt">minRequired</span><span class="op">:</span> minBalance<span class="op">,</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>          <span class="dt">available</span><span class="op">:</span> availableBalance<span class="op">,</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>          threshold</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Error checking account </span><span class="sc">${</span>account<span class="op">.</span><span class="at">publicKey</span><span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>        results<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>          <span class="dt">account</span><span class="op">:</span> account<span class="op">.</span><span class="at">publicKey</span><span class="op">,</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>          <span class="dt">name</span><span class="op">:</span> account<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>          <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>          <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>      <span class="dt">status</span><span class="op">:</span> results<span class="op">.</span><span class="fu">some</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="st">&#39;error&#39;</span>) <span class="op">?</span> <span class="st">&#39;error&#39;</span> <span class="op">:</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>             results<span class="op">.</span><span class="fu">some</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="st">&#39;warning&#39;</span>) <span class="op">?</span> <span class="st">&#39;warning&#39;</span> <span class="op">:</span> <span class="st">&#39;healthy&#39;</span><span class="op">,</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>      <span class="dt">accounts</span><span class="op">:</span> results</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error monitoring account balances:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3
id="what-should-i-do-if-a-donor-claims-they-never-received-a-refund">What
should I do if a donor claims they never received a refund?</h3>
<ol type="1">
<li><strong>Verify refund transaction status</strong>:</li>
</ol>
<div class="sourceCode" id="cb23"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Verify refund transaction status</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> refundId - Refund record ID</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise</span><span class="kw">&lt;Object&gt;</span><span class="co">} - Refund verification result</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">verifyRefundTransaction</span>(refundId) {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get refund record</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> refund <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Refund&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(refundId)<span class="op">;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>refund) {</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">success</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Refund record not found&#39;</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if transaction hash exists</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>refund<span class="op">.</span><span class="at">transaction</span> <span class="op">||</span> <span class="op">!</span>refund<span class="op">.</span><span class="at">transaction</span><span class="op">.</span><span class="at">txHash</span>) {</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">success</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;No transaction hash found&#39;</span><span class="op">,</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        refund</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify on blockchain</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> tx <span class="op">=</span> <span class="cf">await</span> server<span class="op">.</span><span class="fu">transactions</span>()<span class="op">.</span><span class="fu">transaction</span>(refund<span class="op">.</span><span class="at">transaction</span><span class="op">.</span><span class="at">txHash</span>)<span class="op">.</span><span class="fu">call</span>()<span class="op">;</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check transaction status</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (tx<span class="op">.</span><span class="at">successful</span>) {</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>          <span class="dt">success</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>          refund<span class="op">,</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>          <span class="dt">blockchain</span><span class="op">:</span> {</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>            <span class="dt">exists</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>            <span class="dt">successful</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ledger</span><span class="op">:</span> tx<span class="op">.</span><span class="at">ledger</span><span class="op">,</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>            <span class="dt">created_at</span><span class="op">:</span> tx<span class="op">.</span><span class="at">created_at</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>          <span class="dt">success</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>          <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Transaction failed on blockchain&#39;</span><span class="op">,</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>          refund<span class="op">,</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>          <span class="dt">blockchain</span><span class="op">:</span> {</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>            <span class="dt">exists</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>            <span class="dt">successful</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ledger</span><span class="op">:</span> tx<span class="op">.</span><span class="at">ledger</span><span class="op">,</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>            <span class="dt">created_at</span><span class="op">:</span> tx<span class="op">.</span><span class="at">created_at</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error<span class="op">.</span><span class="at">response</span> <span class="op">&amp;&amp;</span> error<span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">404</span>) {</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>          <span class="dt">success</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>          <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Transaction not found on blockchain&#39;</span><span class="op">,</span></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>          refund<span class="op">,</span></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>          <span class="dt">blockchain</span><span class="op">:</span> {</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>            <span class="dt">exists</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error verifying refund transaction:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>      <span class="dt">success</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="2" type="1">
<li><strong>Process a new refund if verification fails</strong>:</li>
</ol>
<div class="sourceCode" id="cb24"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Reprocess failed refund</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> refundId - Original refund ID</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{string}</span><span class="co"> adminId - Administrator processing the refund</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@returns</span><span class="co"> {Promise</span><span class="kw">&lt;Object&gt;</span><span class="co">} - Refund result</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">reprocessRefund</span>(refundId<span class="op">,</span> adminId) {</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get original refund</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> originalRefund <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Refund&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(refundId)<span class="op">;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>originalRefund) {</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Refund not found: </span><span class="sc">${</span>refundId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify original donation exists</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> donation <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Donation&#39;</span>)<span class="op">.</span><span class="fu">findById</span>(originalRefund<span class="op">.</span><span class="at">donationId</span>)<span class="op">;</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>donation) {</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Original donation not found: </span><span class="sc">${</span>originalRefund<span class="op">.</span><span class="at">donationId</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get campaign wallet</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> campaignWallet <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Wallet&#39;</span>)<span class="op">.</span><span class="fu">findOne</span>({</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">campaignId</span><span class="op">:</span> originalRefund<span class="op">.</span><span class="at">campaignId</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>campaignWallet) {</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Campaign wallet not found: </span><span class="sc">${</span>originalRefund<span class="op">.</span><span class="at">campaignId</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get donor wallet</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> donorWallet <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Wallet&#39;</span>)<span class="op">.</span><span class="fu">findOne</span>({</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">userId</span><span class="op">:</span> originalRefund<span class="op">.</span><span class="at">userId</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>donorWallet) {</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Donor wallet not found: </span><span class="sc">${</span>originalRefund<span class="op">.</span><span class="at">userId</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create new refund transaction</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stellarBuilder <span class="op">=</span> <span class="kw">new</span> <span class="fu">StellarTransactionBuilder</span>({</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">useTestnet</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">STELLAR_NETWORK</span> <span class="op">===</span> <span class="st">&#39;testnet&#39;</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> transaction <span class="op">=</span> <span class="cf">await</span> stellarBuilder<span class="op">.</span><span class="fu">createPayment</span>({</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>      <span class="dt">sourceSecret</span><span class="op">:</span> campaignWallet<span class="op">.</span><span class="at">secretKey</span><span class="op">,</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>      <span class="dt">destinationAddress</span><span class="op">:</span> donorWallet<span class="op">.</span><span class="at">publicKey</span><span class="op">,</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>      <span class="dt">amount</span><span class="op">:</span> originalRefund<span class="op">.</span><span class="at">amount</span><span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="fu">toString</span>()<span class="op">,</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>      <span class="dt">memo</span><span class="op">:</span> <span class="vs">`refund:</span><span class="sc">${</span>originalRefund<span class="op">.</span><span class="at">donationId</span><span class="sc">}</span><span class="vs">:retry`</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> stellarBuilder<span class="op">.</span><span class="fu">submitTransaction</span>(transaction)<span class="op">;</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>result<span class="op">.</span><span class="at">success</span>) {</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Failed to process refund: </span><span class="sc">${</span>result<span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create new refund record</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newRefund <span class="op">=</span> {</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>      <span class="dt">donationId</span><span class="op">:</span> originalRefund<span class="op">.</span><span class="at">donationId</span><span class="op">,</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>      <span class="dt">campaignId</span><span class="op">:</span> originalRefund<span class="op">.</span><span class="at">campaignId</span><span class="op">,</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>      <span class="dt">userId</span><span class="op">:</span> originalRefund<span class="op">.</span><span class="at">userId</span><span class="op">,</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>      <span class="dt">amount</span><span class="op">:</span> originalRefund<span class="op">.</span><span class="at">amount</span><span class="op">,</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>      <span class="dt">reason</span><span class="op">:</span> <span class="vs">`Reprocessed refund (Original: </span><span class="sc">${</span>refundId<span class="sc">}</span><span class="vs">)`</span><span class="op">,</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>      <span class="dt">processedBy</span><span class="op">:</span> <span class="kw">new</span> mongoose<span class="op">.</span><span class="at">Types</span><span class="op">.</span><span class="fu">ObjectId</span>(adminId)<span class="op">,</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>      <span class="dt">transaction</span><span class="op">:</span> {</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>        <span class="dt">txHash</span><span class="op">:</span> result<span class="op">.</span><span class="at">result</span><span class="op">.</span><span class="at">hash</span><span class="op">,</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stellarAddress</span><span class="op">:</span> donorWallet<span class="op">.</span><span class="at">publicKey</span><span class="op">,</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>        <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;completed&#39;</span><span class="op">,</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalRefundId</span><span class="op">:</span> refundId<span class="op">,</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>      <span class="dt">created</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> savedRefund <span class="op">=</span> <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Refund&#39;</span>)<span class="op">.</span><span class="fu">create</span>(newRefund)<span class="op">;</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update original refund</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> mongoose<span class="op">.</span><span class="fu">model</span>(<span class="st">&#39;Refund&#39;</span>)<span class="op">.</span><span class="fu">updateOne</span>(</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">_id</span><span class="op">:</span> refundId }<span class="op">,</span></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>        <span class="dt">$set</span><span class="op">:</span> {</span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>          <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;replaced&#39;</span><span class="op">,</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>          <span class="dt">replacedBy</span><span class="op">:</span> savedRefund<span class="op">.</span><span class="at">_id</span><span class="op">,</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>          <span class="dt">updated</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>      <span class="dt">success</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>      <span class="dt">originalRefundId</span><span class="op">:</span> refundId<span class="op">,</span></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>      <span class="dt">newRefundId</span><span class="op">:</span> savedRefund<span class="op">.</span><span class="at">_id</span><span class="op">,</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>      <span class="dt">transactionHash</span><span class="op">:</span> result<span class="op">.</span><span class="at">result</span><span class="op">.</span><span class="at">hash</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error reprocessing refund:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>      <span class="dt">success</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This troubleshooting guide aims to provide comprehensive solutions
for various issues you might encounter while working with The Give Hub
transaction system. Keep it handy when developing, testing, and
maintaining the platform.</p>
</body>
</html>
