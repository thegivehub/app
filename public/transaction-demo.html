<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transaction API Demo</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #f0f2f5; }
        .demo-container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ccc; padding: 30px; }
        h1 { color: #1a237e; }
        h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        form { margin-bottom: 30px; }
        label { display: block; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 2px; border-radius: 4px; border: 1px solid #ccc; }
        button { margin-top: 15px; padding: 10px 20px; background: #1a237e; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #3949ab; }
        .result, .error { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .result { background: #e8f5e9; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .section { margin-bottom: 40px; }
        .milestone-group { background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        pre { white-space: pre-wrap; word-break: break-all; }
        .instructions { color: #444; background: #f9f9fc; border-left: 4px solid #1a237e; padding: 10px 18px; margin: 10px 0 18px 0; border-radius: 4px; font-size: 15px; }
        .field-tip { color: #666; font-size: 13px; margin-left: 4px; }
        .tab-bar {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab-btn {
            background: none;
            border: none;
            outline: none;
            padding: 14px 28px;
            font-size: 16px;
            color: #1a237e;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            border-bottom: 2px solid transparent;
            transition: background 0.2s, border-bottom 0.2s;
            margin-bottom: -2px;
        }
        .tab-btn.active {
            background: #f0f2f5;
            border-bottom: 2px solid #1a237e;
            color: #222;
            font-weight: bold;
        }
        .tab-section { animation: fadein 0.2s; }
        @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
<div class="demo-container">
    <h1>Transaction API Demo</h1>
    <div class="instructions">
        <b>Welcome!</b> This page lets you test all major blockchain transaction types supported by the Give Hub API.<br>
        <ul>
            <li>All forms interact directly with the API.</li>
            <li><b>User</b> and <b>Campaign</b> dropdowns are auto-populated from the live database.</li>
            <li>If a dropdown fails to load, you can enter an ID manually.</li>
            <li>Use <b>testnet</b> keys and IDs for safety.</li>
            <li>Results and errors will be shown below each form.</li>
        </ul>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" data-tab="donation-tab">One-Time Donation</button>
        <button class="tab-btn" data-tab="recurring-tab">Recurring Donation</button>
        <button class="tab-btn" data-tab="escrow-tab">Milestone Escrow Creation</button>
        <button class="tab-btn" data-tab="release-tab">Milestone Fund Release</button>
        <button class="tab-btn" data-tab="debug-tab">Debug Tools</button>
    </div>

    <div id="donation-tab" class="tab-section">
        <div class="section">
            <h2>One-Time Donation</h2>
            <div class="instructions">
                <b>Send a one-time donation</b> from a user to a campaign. Select a user, a wallet that belongs to that user that has funds and a campaign, enter the amount (in XLM), <!--and provide the user's Stellar secret key to sign the transaction--> add any <code>memo</code> text and submit your donation.<br>
                <span class="field-tip">User ID: Select a user from the dropdown. If unavailable, enter the user's unique ID.</span><br>
                <span class="field-tip">Wallet: Select one of the user's wallets that has been funded.</span><br>
                <span class="field-tip">Campaign ID: Select a campaign from the dropdown. If unavailable, enter the campaign's unique ID.</span><br>
                <span class="field-tip">Anonymous: If checked, the donation will be recorded as anonymous.</span>
            </div>
            <form id="donation-form">
                <label>User ID: <select name="userId" id="donor-select-1" required><option value="">Loading...</option></select></label>
                <label>Wallet: <select name="walletId" id="wallet-select-1" required><option value="">Select user first...</option></select></label>
                <label>Campaign ID: <select name="campaignId" id="campaign-select-1" required><option value="">Loading...</option></select></label>
                <label>Amount (XLM): <input type="text" name="amount" required></label>
                <label>Anonymous? <input type="checkbox" name="isAnonymous"></label>
                <label>Message: <input type="text" name="message"></label>
                <!-- No longer need sourceSecret as we'll use walletId -->
                <button type="submit">Submit Donation</button>
            </form>
            <div id="donation-result"></div>
        </div>
    </div>

    <div id="recurring-tab" class="tab-section" style="display:none">
        <div class="section">
            <h2>Recurring Donation</h2>
            <div class="instructions">
                <b>Set up a recurring donation</b> from a user to a campaign. The donation will repeat at the selected frequency.<br>
                <span class="field-tip">Frequency: Choose how often the donation should repeat (monthly, weekly, etc.).</span>
            </div>
            <form id="recurring-form">
                <label>User ID: <select name="userId" id="donor-select-2" required><option value="">Loading...</option></select></label>
                <label>Wallet: <select name="walletId" id="wallet-select-2" required><option value="">Select user first...</option></select></label>
                <label>Campaign ID: <select name="campaignId" id="campaign-select-2" required><option value="">Loading...</option></select></label>
                <label>Amount (XLM): <input type="text" name="amount" required></label>
                <!-- No longer need sourceSecret as we'll use walletId -->
                <label>Anonymous? <input type="checkbox" name="isAnonymous"></label>
                <label>Message: <input type="text" name="message"></label>
                <label>Frequency:
                    <select name="frequency">
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="annually">Annually</option>
                    </select>
                </label>
                <button type="submit">Setup Recurring Donation</button>
            </form>
            <div id="recurring-result"></div>
        </div>
    </div>

    <div id="escrow-tab" class="tab-section" style="display:none">
        <div class="section">
            <h2>Milestone Escrow Creation</h2>
            <div class="instructions">
                <b>Create an escrow account</b> for milestone-based funding. The source account will fund a new escrow account, and you can define up to 3 milestones (each with a title, amount, and release schedule).<br>
                <span class="field-tip">Initial Funding: The total XLM to fund the escrow account (must cover all milestones and Stellar minimum balance).</span>
                <span class="field-tip">Milestone fields: You can leave unused milestones blank.</span>
            </div>
            <form id="escrow-form">
                <label>Campaign ID: <select name="campaignId" id="campaign-select-3" required><option value="">Loading...</option></select></label>
                <label>Source Secret: <input type="text" name="sourceSecret" required></label>
                <label>Initial Funding (XLM): <input type="text" name="initialFunding" value="1"></label>
                <div class="milestone-group">
                    <b>Milestone 1</b>
                    <label>Title: <input type="text" name="milestone1_title"></label>
                    <label>Amount (XLM): <input type="text" name="milestone1_amount"></label>
                    <label>Release Days from Now: <input type="number" name="milestone1_releaseDays"></label>
                </div>
                <div class="milestone-group">
                    <b>Milestone 2</b>
                    <label>Title: <input type="text" name="milestone2_title"></label>
                    <label>Amount (XLM): <input type="text" name="milestone2_amount"></label>
                    <label>Release Days from Now: <input type="number" name="milestone2_releaseDays"></label>
                </div>
                <div class="milestone-group">
                    <b>Milestone 3</b>
                    <label>Title: <input type="text" name="milestone3_title"></label>
                    <label>Amount (XLM): <input type="text" name="milestone3_amount"></label>
                    <label>Release Days from Now: <input type="number" name="milestone3_releaseDays"></label>
                </div>
                <button type="submit">Create Escrow</button>
            </form>
            <div id="escrow-result"></div>
        </div>
    </div>

    <div id="release-tab" class="tab-section" style="display:none">
        <div class="section">
            <h2>Milestone Fund Release</h2>
            <div class="instructions">
                <b>Release funds from an escrow account</b> for a specific milestone. Select the campaign and the authorized user (creator or admin), enter the milestone ID and amount to release.<br>
                <span class="field-tip">Milestone ID: You can find this in the campaign's milestone list or from the escrow creation result.</span>
                <span class="field-tip">Authorized By: Select the user who is authorized to release the funds (usually the campaign creator or an admin).</span>
            </div>
            <form id="release-form">
                <label>Campaign ID: <select name="campaignId" id="campaign-select-4" required><option value="">Loading...</option></select></label>
                <label>Milestone ID: <input type="text" name="milestoneId" required></label>
                <label>Authorized By: <select name="authorizedBy" id="donor-select-3" required><option value="">Loading...</option></select></label>
                <label>Amount (XLM): <input type="text" name="amount" required></label>
                <button type="submit">Release Funds</button>
            </form>
            <div id="release-result"></div>
        </div>
    </div>

    <div id="debug-tab" class="tab-section" style="display:none">
        <div class="section">
            <h2>Database Debug Tools</h2>
            <div class="instructions">
                <b>Use these tools to debug database issues</b> including campaign lookups and wallet problems.<br>
                <span class="field-tip">Enter the ID of a campaign or wallet to verify it exists and view its details.</span>
            </div>
            
            <h3>Campaign Lookup</h3>
            <form id="campaign-lookup-form">
                <label>Campaign ID: <input type="text" name="campaignId" required></label>
                <button type="submit">Lookup Campaign</button>
            </form>
            <div id="campaign-lookup-result"></div>
            
            <h3>Campaign Wallet Status</h3>
            <form id="campaign-wallet-form">
                <label>Campaign ID: <input type="text" name="campaignId" required></label>
                <button type="submit">Check Wallet Status</button>
            </form>
            <div id="campaign-wallet-result"></div>
            
            <h3>Wallet Lookup</h3>
            <form id="wallet-lookup-form">
                <label>Wallet ID: <input type="text" name="walletId" required></label>
                <button type="submit">Lookup Wallet</button>
            </form>
            <div id="wallet-lookup-result"></div>
        </div>
    </div>
</div>

<script>
async function fetchAndPopulateSelect(url, selectIds, labelField, valueField, fallbackLabel) {
    try {
        const response = await fetch(url);
        const json = await response.json();
        let items = [];
        if (json.success && Array.isArray(json.data)) {
            items = json.data;
        } else if (Array.isArray(json)) {
            items = json;
        } else if (json.success && Array.isArray(json.campaigns)) {
            items = json.campaigns;
        } else if (json.success && Array.isArray(json.donors)) {
            items = json.donors;
        }
        selectIds.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '';
            if (items.length === 0) {
                select.innerHTML = `<option value="">No options found</option>`;
                // Add fallback input if needed
                const fallback = document.createElement('input');
                fallback.type = 'text';
                fallback.name = select.name;
                fallback.placeholder = fallbackLabel;
                fallback.required = true;
                select.parentNode.replaceChild(fallback, select);
                return;
            }
            select.innerHTML = `<option value="">Select...</option>` +
                items.map(item => `<option value="${item[valueField]}">${item[labelField] || item[valueField]}</option>`).join('');
        });
    } catch (e) {
        selectIds.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = `<option value="">Error loading options</option>`;
            // Add fallback input if needed
            const fallback = document.createElement('input');
            fallback.type = 'text';
            fallback.name = select.name;
            fallback.placeholder = fallbackLabel;
            fallback.required = true;
            select.parentNode.replaceChild(fallback, select);
        });
    }
}

// Populate user and campaign selects on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load users with donor role instead of donors
    fetchAndPopulateSelect('/api.php/user', ['donor-select-1', 'donor-select-2', 'donor-select-3'], 'username', '_id', 'Enter User ID');
    fetchAndPopulateSelect('/api.php/campaign', ['campaign-select-1', 'campaign-select-2', 'campaign-select-3', 'campaign-select-4'], 'title', '_id', 'Enter Campaign ID');

    // Populate wallet select for the user
    function setupWalletSelection(userSelectId, walletSelectId) {
        const userSelect = document.getElementById(userSelectId);
        const walletSelect = document.getElementById(walletSelectId);
        
        if (!userSelect || !walletSelect) return;
        
        userSelect.addEventListener('change', async function() {
            const userId = userSelect.value;
            walletSelect.innerHTML = '<option value="">Loading wallets...</option>';
            
            if (!userId) {
                walletSelect.innerHTML = '<option value="">Select user first...</option>';
                return;
            }

            // Display diagnostic information in wallet dropdown
            walletSelect.innerHTML = '<option value="">Checking user wallets...</option>';
            
            try {
                // Directly fetch wallets for the user
                const walletsRes = await fetch(`/api.php/wallets/getUserWallets?userId=${encodeURIComponent(userId)}`);
                const walletsJson = await walletsRes.json();
                
                if (walletsJson.success && walletsJson.wallets && walletsJson.wallets.length > 0) {
                    walletSelect.innerHTML = '<option value="">Select wallet...</option>';
                    walletsJson.wallets.forEach(wallet => {
                        walletSelect.innerHTML += `<option value="${wallet.id}" data-secret="${wallet.secretKey || ''}">${wallet.label || wallet.publicKey.substr(0, 10)}... (Balance: ${wallet.balance} XLM)</option>`;
                    });
                    
                    // No need to set sourceSecret anymore as we'll use walletId directly
                } else {
                    walletSelect.innerHTML = '<option value="">No wallets found</option>';
                    // Add option to create a wallet
                    const createWalletOption = document.createElement('option');
                    createWalletOption.value = "create_new";
                    createWalletOption.textContent = "‚ûï Create new wallet";
                    walletSelect.appendChild(createWalletOption);
                    
                    walletSelect.onchange = function() {
                        if (walletSelect.value === "create_new") {
                            createNewWallet(userId, walletSelect);
                        }
                    };
                }
            } catch (e) {
                console.error("Error fetching wallet data:", e);
                walletSelect.innerHTML = '<option value="">Error loading wallets</option>';
                
                // Add retry option
                const retryOption = document.createElement('option');
                retryOption.value = "retry";
                retryOption.textContent = "üîÑ Retry";
                walletSelect.appendChild(retryOption);
                
                walletSelect.onchange = function() {
                    if (walletSelect.value === "retry") {
                        // Trigger the change event again to retry
                        userSelect.dispatchEvent(new Event('change'));
                    }
                };
            }
        });
        
        // Function to create a new wallet
        async function createNewWallet(userId, walletSelect) {
            try {
                walletSelect.disabled = true;
                walletSelect.innerHTML = '<option value="">Creating wallet...</option>';
                
                const createRes = await fetch(`/api.php/wallets/createWallet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId })
                });
                
                const createJson = await createRes.json();
                
                if (createJson.success && createJson.wallet) {
                    walletSelect.innerHTML = `<option value="${createJson.wallet.id}" selected>${createJson.wallet.label || createJson.wallet.publicKey.substr(0, 10)}... (New)</option>`;
                    
                    // Add funding status option
                    const fundingOption = document.createElement('option');
                    fundingOption.disabled = true;
                    fundingOption.textContent = "‚è≥ Funding wallet via testnet...";
                    walletSelect.appendChild(fundingOption);
                    
                    // Try to fund the wallet
                    try {
                        const fundRes = await fetch(`/api.php/wallets/fundTestnetAccount`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ publicKey: createJson.wallet.publicKey })
                        });
                        
                        const fundJson = await fundRes.json();
                        
                        if (fundJson.success) {
                            // Update the wallet option to show the funded balance
                            const balance = fundJson.account.balances[0].balance;
                            walletSelect.querySelector('option:first-child').textContent = 
                                `${createJson.wallet.label || createJson.wallet.publicKey.substr(0, 10)}... (Funded: ${balance} XLM)`;
                            
                            // Remove the funding status option
                            walletSelect.removeChild(fundingOption);
                        } else {
                            fundingOption.textContent = "‚ö†Ô∏è Funding failed - wallet may have 0 balance";
                        }
                    } catch (e) {
                        fundingOption.textContent = "‚ö†Ô∏è Funding error - wallet may have 0 balance";
                    }
                } else {
                    walletSelect.innerHTML = '<option value="">Failed to create wallet</option>';
                    // Add error details if available
                    if (createJson.error) {
                        const errorOption = document.createElement('option');
                        errorOption.disabled = true;
                        errorOption.textContent = `Error: ${createJson.error}`;
                        walletSelect.appendChild(errorOption);
                    }
                }
                
                walletSelect.disabled = false;
            } catch (e) {
                walletSelect.innerHTML = '<option value="">Error creating wallet</option>';
                walletSelect.disabled = false;
            }
        }
    }
    
    setupWalletSelection('donor-select-1', 'wallet-select-1');
    setupWalletSelection('donor-select-2', 'wallet-select-2');
});

async function postForm(url, data, resultDiv) {
    resultDiv.innerHTML = '';
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const json = await response.json();
        if (json.success) {
            resultDiv.innerHTML = '<div class="result"><h3>Result:</h3><pre>' + JSON.stringify(json, null, 2) + '</pre></div>';
        } else {
            resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + JSON.stringify(json, null, 2) + '</pre></div>';
        }
    } catch (e) {
        resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + e.message + '</pre></div>';
    }
}

// One-Time Donation
document.getElementById('donation-form').onsubmit = function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this).entries());
    data.isAnonymous = !!this.isAnonymous && this.isAnonymous.checked;
    data.recurring = false;
    
    // Add helpful message for debugging
    document.getElementById('donation-result').innerHTML = 
        '<div class="instructions">Processing donation... Please wait.</div>';
    
    // If the API expects donorId but we're passing userId, add a donorId parameter
    // This is for backwards compatibility with the existing API
    if (data.userId && !data.donorId) {
        data.donorId = data.userId;
    }
    
    // Log the data being sent to help with debugging
    console.log('Donation data being sent:', data);
    
    postForm('/api.php/transaction/processDonation', data, document.getElementById('donation-result'));
};

// Debug Tools - Campaign Lookup
document.getElementById('campaign-lookup-form').onsubmit = function(e) {
    e.preventDefault();
    const campaignId = this.campaignId.value.trim();
    const resultDiv = document.getElementById('campaign-lookup-result');
    
    resultDiv.innerHTML = '<div class="instructions">Looking up campaign... Please wait.</div>';
    
    fetch(`/api.php/campaign?id=${encodeURIComponent(campaignId)}`)
        .then(response => response.json())
        .then(data => {
            if (data && data._id) {
                resultDiv.innerHTML = '<div class="result"><h3>Campaign Found:</h3><pre>' + 
                    JSON.stringify(data, null, 2) + '</pre></div>';
            } else {
                resultDiv.innerHTML = '<div class="error"><h3>Campaign Not Found</h3><p>The campaign with ID ' + 
                    campaignId + ' could not be found. Try checking for leading/trailing spaces.</p></div>';
                
                // Try a broader search as fallback
                fetch('/api.php/campaign')
                    .then(response => response.json())
                    .then(allData => {
                        if (Array.isArray(allData) && allData.length > 0) {
                            resultDiv.innerHTML += '<div class="result"><h3>Available Campaigns:</h3><pre>' + 
                                JSON.stringify(allData.slice(0, 3).map(c => ({_id: c._id, title: c.title})), null, 2) + 
                                '</pre></div>';
                        }
                    })
                    .catch(err => console.error("Error fetching all campaigns:", err));
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + error.message + '</pre></div>';
        });
};

// Debug Tools - Campaign Wallet Status
document.getElementById('campaign-wallet-form').onsubmit = function(e) {
    e.preventDefault();
    const campaignId = this.campaignId.value.trim();
    const resultDiv = document.getElementById('campaign-wallet-result');
    
    resultDiv.innerHTML = '<div class="instructions">Checking campaign wallet status... Please wait.</div>';
    
    // Use our new Wallet API to get campaign wallet details
    fetch(`/api.php/wallet/getCampaignWallet?campaignId=${encodeURIComponent(campaignId)}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                let errorHtml = '<div class="error"><h3>Campaign Wallet Error</h3>';
                errorHtml += `<p>${data.error}</p>`;
                
                // If the campaign doesn't have a wallet, offer to create one
                if (data.error === 'Campaign does not have a wallet' && data.createUrl) {
                    errorHtml += `<p>Would you like to create a wallet for this campaign?</p>`;
                    errorHtml += `<button id="create-wallet-btn" data-campaign-id="${campaignId}">Create Wallet</button>`;
                } else if (data.error === 'Campaign not found') {
                    errorHtml += `<p>Check the campaign ID and try again.</p>`;
                }
                
                errorHtml += '</div>';
                resultDiv.innerHTML = errorHtml;
                
                // Add event listener for wallet creation button if present
                const createWalletBtn = document.getElementById('create-wallet-btn');
                if (createWalletBtn) {
                    createWalletBtn.addEventListener('click', function() {
                        createWalletBtn.disabled = true;
                        createWalletBtn.textContent = 'Creating wallet...';
                        
                        fetch(`/api.php/wallet/createCampaignWallet`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ campaignId: campaignId })
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                resultDiv.innerHTML = '<div class="result"><h3>Campaign Wallet Created Successfully</h3>' +
                                    `<p>Campaign now has a wallet with ID: ${result.wallet.id}</p>` +
                                    `<p>Public Key: ${result.wallet.publicKey}</p>` +
                                    `<p>Would you like to fund this wallet on the testnet?</p>` +
                                    `<button id="fund-wallet-btn" data-campaign-id="${campaignId}">Fund Wallet</button>` +
                                    '</div>';
                                
                                // Add event listener for funding button
                                const fundWalletBtn = document.getElementById('fund-wallet-btn');
                                if (fundWalletBtn) {
                                    fundWalletBtn.addEventListener('click', function() {
                                        fundWalletBtn.disabled = true;
                                        fundWalletBtn.textContent = 'Funding wallet...';
                                        
                                        fetch(`/api.php/wallet/fundCampaignWallet`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ campaignId: campaignId })
                                        })
                                        .then(response => response.json())
                                        .then(fundResult => {
                                            if (fundResult.success) {
                                                resultDiv.innerHTML = '<div class="result"><h3>Campaign Wallet Funded Successfully</h3>' +
                                                    `<p>Wallet balance: ${fundResult.wallet.balance} XLM</p>` +
                                                    `<pre>${JSON.stringify(fundResult, null, 2)}</pre>` +
                                                    '</div>';
                                            } else {
                                                resultDiv.innerHTML = '<div class="error"><h3>Error Funding Wallet</h3>' +
                                                    `<p>${fundResult.error}</p>` +
                                                    '</div>';
                                            }
                                        })
                                        .catch(error => {
                                            resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + error.message + '</pre></div>';
                                        });
                                    });
                                }
                            } else {
                                resultDiv.innerHTML = '<div class="error"><h3>Error Creating Wallet</h3>' +
                                    `<p>${result.error}</p>` +
                                    '</div>';
                            }
                        })
                        .catch(error => {
                            resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + error.message + '</pre></div>';
                        });
                    });
                }
            } else {
                // Show wallet details if successful
                let walletInfo = '<div class="result"><h3>Campaign Wallet Status:</h3>';
                walletInfo += `<p>‚úÖ Campaign has a wallet</p>`;
                walletInfo += `<p>Wallet ID: ${data.wallet.id}</p>`;
                walletInfo += `<p>Stellar Address: ${data.wallet.publicKey}</p>`;
                walletInfo += `<p>Balance: ${data.wallet.balance} XLM</p>`;
                walletInfo += `<p>Created: ${data.wallet.createdAt}</p>`;
                
                // Add additional wallet details
                walletInfo += `<h4>Full Wallet Details:</h4>`;
                walletInfo += `<pre>${JSON.stringify(data.wallet, null, 2)}</pre>`;
                
                // Add funding option if balance is 0
                if (data.wallet.balance === '0') {
                    walletInfo += `<p>The wallet has a zero balance. Would you like to fund it on the testnet?</p>`;
                    walletInfo += `<button id="fund-empty-wallet-btn" data-campaign-id="${campaignId}">Fund Wallet</button>`;
                }
                
                walletInfo += '</div>';
                resultDiv.innerHTML = walletInfo;
                
                // Add event listener for funding button if present
                const fundEmptyWalletBtn = document.getElementById('fund-empty-wallet-btn');
                if (fundEmptyWalletBtn) {
                    fundEmptyWalletBtn.addEventListener('click', function() {
                        fundEmptyWalletBtn.disabled = true;
                        fundEmptyWalletBtn.textContent = 'Funding wallet...';
                        
                        fetch(`/api.php/wallet/fundCampaignWallet`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ campaignId: campaignId })
                        })
                        .then(response => response.json())
                        .then(fundResult => {
                            if (fundResult.success) {
                                resultDiv.innerHTML = '<div class="result"><h3>Campaign Wallet Funded Successfully</h3>' +
                                    `<p>Wallet balance: ${fundResult.wallet.balance} XLM</p>` +
                                    `<pre>${JSON.stringify(fundResult, null, 2)}</pre>` +
                                    '</div>';
                            } else {
                                resultDiv.innerHTML = '<div class="error"><h3>Error Funding Wallet</h3>' +
                                    `<p>${fundResult.error}</p>` +
                                    '</div>';
                            }
                        })
                        .catch(error => {
                            resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + error.message + '</pre></div>';
                        });
                    });
                }
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + error.message + '</pre></div>';
        });
};

// Debug Tools - Wallet Lookup
document.getElementById('wallet-lookup-form').onsubmit = function(e) {
    e.preventDefault();
    const walletId = this.walletId.value.trim();
    const resultDiv = document.getElementById('wallet-lookup-result');
    
    resultDiv.innerHTML = '<div class="instructions">Looking up wallet... Please wait.</div>';
    
    fetch(`/api.php/wallet/getWalletDetails?walletId=${encodeURIComponent(walletId)}`)
        .then(response => response.json())
        .then(data => {
            if (data && data.success && data.wallet) {
                // For security, mask the secret key if present
                if (data.wallet.secretKey) {
                    data.wallet.secretKey = '*'.repeat(10) + data.wallet.secretKey.substring(data.wallet.secretKey.length - 5);
                }
                
                let walletInfo = '<div class="result"><h3>Wallet Found:</h3>';
                
                // Add basic info
                walletInfo += `<p>Wallet ID: ${data.wallet.id}</p>`;
                walletInfo += `<p>Public Key: ${data.wallet.publicKey}</p>`;
                walletInfo += `<p>Balance: ${data.wallet.balance} XLM</p>`;
                walletInfo += `<p>Type: ${data.wallet.type}</p>`;
                
                // If it's a campaign wallet, show campaign info
                if (data.wallet.campaignId) {
                    walletInfo += `<p>Campaign ID: ${data.wallet.campaignId}</p>`;
                    if (data.wallet.campaign) {
                        walletInfo += `<p>Campaign Title: ${data.wallet.campaign.title}</p>`;
                        walletInfo += `<p>Funding Status: ${data.wallet.campaign.fundingRaised} / ${data.wallet.campaign.fundingTarget}</p>`;
                    }
                }
                
                // If it's a user wallet, show user info
                if (data.wallet.userId) {
                    walletInfo += `<p>User ID: ${data.wallet.userId}</p>`;
                    if (data.wallet.user) {
                        walletInfo += `<p>User: ${data.wallet.user.username} (${data.wallet.user.email})</p>`;
                    }
                }
                
                // Add funding option if balance is 0 and it's a campaign wallet
                if (data.wallet.balance === '0' && data.wallet.type === 'campaign' && data.wallet.campaignId) {
                    walletInfo += `<p>This campaign wallet has a zero balance. Would you like to fund it on the testnet?</p>`;
                    walletInfo += `<button id="fund-lookup-wallet-btn" data-campaign-id="${data.wallet.campaignId}">Fund Wallet</button>`;
                }
                
                // Add full wallet details
                walletInfo += `<h4>Full Wallet Details:</h4>`;
                walletInfo += `<pre>${JSON.stringify(data.wallet, null, 2)}</pre>`;
                walletInfo += '</div>';
                
                resultDiv.innerHTML = walletInfo;
                
                // Add event listener for funding button if present
                const fundLookupWalletBtn = document.getElementById('fund-lookup-wallet-btn');
                if (fundLookupWalletBtn) {
                    fundLookupWalletBtn.addEventListener('click', function() {
                        fundLookupWalletBtn.disabled = true;
                        fundLookupWalletBtn.textContent = 'Funding wallet...';
                        
                        const campaignId = fundLookupWalletBtn.getAttribute('data-campaign-id');
                        fetch(`/api.php/wallet/fundCampaignWallet`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ campaignId: campaignId })
                        })
                        .then(response => response.json())
                        .then(fundResult => {
                            if (fundResult.success) {
                                resultDiv.innerHTML = '<div class="result"><h3>Campaign Wallet Funded Successfully</h3>' +
                                    `<p>Wallet balance: ${fundResult.wallet.balance} XLM</p>` +
                                    `<pre>${JSON.stringify(fundResult, null, 2)}</pre>` +
                                    '</div>';
                            } else {
                                resultDiv.innerHTML = '<div class="error"><h3>Error Funding Wallet</h3>' +
                                    `<p>${fundResult.error}</p>` +
                                    '</div>';
                            }
                        })
                        .catch(error => {
                            resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + error.message + '</pre></div>';
                        });
                    });
                }
            } else {
                resultDiv.innerHTML = '<div class="error"><h3>Wallet Not Found or Error</h3><pre>' + 
                    JSON.stringify(data, null, 2) + '</pre></div>';
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="error"><h3>Error:</h3><pre>' + error.message + '</pre></div>';
        });
};

// Recurring Donation
document.getElementById('recurring-form').onsubmit = function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this).entries());
    data.isAnonymous = !!this.isAnonymous && this.isAnonymous.checked;
    data.recurring = true;
    
    // Add helpful message for debugging
    document.getElementById('recurring-result').innerHTML = 
        '<div class="instructions">Processing recurring donation... Please wait.</div>';
    
    // If the API expects donorId but we're passing userId, add a donorId parameter
    // This is for backwards compatibility with the existing API
    if (data.userId && !data.donorId) {
        data.donorId = data.userId;
    }
    
    postForm('/api.php/transaction/processDonation', data, document.getElementById('recurring-result'));
};

// Milestone Escrow Creation
document.getElementById('escrow-form').onsubmit = function(e) {
    e.preventDefault();
    const form = this;
    const data = Object.fromEntries(new FormData(form).entries());
    // Build milestones array
    const milestones = [];
    for (let i = 1; i <= 3; i++) {
        if (data[`milestone${i}_title`] && data[`milestone${i}_amount`]) {
            milestones.push({
                title: data[`milestone${i}_title`],
                amount: data[`milestone${i}_amount`],
                releaseDays: data[`milestone${i}_releaseDays`] || null,
                id: `milestone-${i}-${Date.now()}`
            });
        }
        delete data[`milestone${i}_title`];
        delete data[`milestone${i}_amount`];
        delete data[`milestone${i}_releaseDays`];
    }
    data.milestones = milestones;
    postForm('/api.php/transaction/createMilestoneEscrow', data, document.getElementById('escrow-result'));
};

// Milestone Fund Release
document.getElementById('release-form').onsubmit = function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this).entries());
    postForm('/api.php/transaction/releaseMilestoneFunding', data, document.getElementById('release-result'));
};

// Tab switching logic
const tabButtons = document.querySelectorAll('.tab-btn');
const tabSections = document.querySelectorAll('.tab-section');
tabButtons.forEach(btn => {
    btn.addEventListener('click', function() {
        tabButtons.forEach(b => b.classList.remove('active'));
        tabSections.forEach(s => s.style.display = 'none');
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).style.display = '';
    });
});
</script>
</body>
</html> 
