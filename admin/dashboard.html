<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - The Give Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin-styles.css">
    <style>
        /* Dashboard specific styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .dashboard-card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .dashboard-card-action {
            font-size: 0.875rem;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .dashboard-card-content {
            padding: 1.5rem;
        }

        /* Stats overview row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .stat-card-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            opacity: 0.2;
        }

        .stat-card-content {
            position: relative;
            z-index: 1;
        }

        .stat-card-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .stat-card-value {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .stat-card-trend {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* Recent items tables */
        .recent-items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .recent-items-table th,
        .recent-items-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .recent-items-table th {
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .recent-items-table tr:last-child td {
            border-bottom: none;
        }

        .recent-items-table tr:hover {
            background-color: var(--gray-50);
        }

        /* Recent activity list */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .activity-icon {
            padding: 0.5rem;
            background-color: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .activity-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        /* Campaign status badges */
        .badge {
            display: inline-flex;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-pending {
            background-color: var(--warning-light);
            color: var(--warning);
        }

        .badge-active {
            background-color: var(--success-light);
            color: var(--success);
        }

        .badge-rejected {
            background-color: var(--danger-light);
            color: var(--danger);
        }

        /* Loading placeholders */
        .loading-placeholder {
            animation: pulse 1.5s infinite;
            background: linear-gradient(90deg, var(--gray-100) 0%, var(--gray-200) 50%, var(--gray-100) 100%);
            background-size: 200% 100%;
            height: 24px;
            border-radius: 4px;
        }

        @keyframes pulse {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: -200% 50%;
            }
        }

        /* Charts section */
        .chart-container {
            position: relative;
            height: 220px;
            margin-top: 1rem;
        }

        .mini-chart-container {
            position: relative;
            height: 100px;
            margin-top: 0.5rem;
        }

        .chart-legend {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--gray-700);
        }

        .legend-color {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <h1 class="admin-title">Dashboard</h1>
                <div class="admin-actions">
                    <button id="refresh-btn" class="btn btn-outline">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <polyline points="1 4 1 10 7 10"></polyline>
                            <polyline points="23 20 23 14 17 14"></polyline>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Main Dashboard Content -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-card-icon" style="background-color: var(--primary-light); color: var(--primary);">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <div class="stat-card-content">
                        <div class="stat-card-label">Total Users</div>
                        <div class="stat-card-value" id="total-users-count">0</div>
                        <div class="stat-card-trend trend-up">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            <span>8.2% from last month</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon" style="background-color: var(--success-light); color: var(--success);">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                    <div class="stat-card-content">
                        <div class="stat-card-label">Active Campaigns</div>
                        <div class="stat-card-value" id="active-campaigns-count">0</div>
                        <div class="stat-card-trend trend-up">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            <span>12.4% from last month</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon" style="background-color: var(--warning-light); color: var(--warning);">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                    </div>
                    <div class="stat-card-content">
                        <div class="stat-card-label">Pending Review</div>
                        <div class="stat-card-value" id="pending-count">0</div>
                        <div class="stat-card-trend trend-down">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                                <polyline points="17 18 23 18 23 12"></polyline>
                            </svg>
                            <span>3.1% from last month</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon" style="background-color: var(--primary-light); color: var(--primary);">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                    <div class="stat-card-content">
                        <div class="stat-card-label">Total Funding</div>
                        <div class="stat-card-value" id="total-funding">$0</div>
                        <div class="stat-card-trend trend-up">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            <span>18.3% from last month</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Left Column -->
                <div>
                    <!-- Campaigns Overview -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <h2 class="dashboard-card-title">Campaign Overview</h2>
                            <a href="campaigns.html" class="dashboard-card-action">
                                View All
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </a>
                        </div>
                        <div class="dashboard-card-content">
                            <div class="chart-container" id="campaigns-chart-container">
                                <!-- This will be populated by the chart JS -->
                                <canvas id="campaigns-chart"></canvas>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #10b981;"></div>
                                    <span>Approved</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f59e0b;"></div>
                                    <span>Pending</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #ef4444;"></div>
                                    <span>Rejected</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Campaigns -->
                    <div class="dashboard-card" style="margin-top: 1.5rem;">
                        <div class="dashboard-card-header">
                            <h2 class="dashboard-card-title">Recent Campaigns</h2>
                            <a href="campaigns.html" class="dashboard-card-action">
                                View All
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </a>
                        </div>
                        <div class="dashboard-card-content" style="padding: 0;">
                            <table class="recent-items-table">
                                <thead>
                                    <tr>
                                        <th>Campaign</th>
                                        <th>Creator</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-campaigns-table">
                                    <!-- This will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <!-- User Stats -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <h2 class="dashboard-card-title">User Growth</h2>
                            <a href="users.html" class="dashboard-card-action">
                                View All
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </a>
                        </div>
                        <div class="dashboard-card-content">
                            <div class="chart-container" id="users-chart-container">
                                <!-- This will be populated by the chart JS -->
                                <canvas id="users-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Users -->
                    <div class="dashboard-card" style="margin-top: 1.5rem;">
                        <div class="dashboard-card-header">
                            <h2 class="dashboard-card-title">Recent Users</h2>
                            <a href="users.html" class="dashboard-card-action">
                                View All
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </a>
                        </div>
                        <div class="dashboard-card-content" style="padding: 0;">
                            <table class="recent-items-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-users-table">
                                    <!-- This will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="dashboard-card" style="margin-top: 1.5rem;">
                        <div class="dashboard-card-header">
                            <h2 class="dashboard-card-title">Recent Activity</h2>
                        </div>
                        <div class="dashboard-card-content">
                            <div class="activity-list" id="recent-activity-list">
                                <!-- This will be populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notification-message"></span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Load Chart.js from CDN for the dashboard charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- Admin Authentication Check -->
    <script>
        // Check if admin is authenticated
        function checkAdminAuth() {
            const adminToken = localStorage.getItem('adminToken');
            
            if (!adminToken) {
                console.log(`No admin token.  sending to login...`, adminToken);
                // Redirect to login if no token
                window.location.href = '/admin/index.html';
                return false;
            }
            
            // Verify token with server
            fetch('/api.php/admin/verify', {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Invalid token');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error('Authentication failed');
                }
                
                // Update admin info
                /*
                if (data.user) {
                    document.getElementById('admin-name').textContent = data.user.displayName;
                    const initials = data.user.displayName
                        .split(' ')
                        .map(name => name[0])
                        .join('')
                        .toUpperCase();
                    document.getElementById('admin-initials').textContent = initials;
                }
                */
            })
            .catch(error => {
                console.error('Auth error:', error);
                // Clear token and redirect to login
                localStorage.removeItem('adminToken');
                window.location.href = '/admin/index.html';
            });
            
            return true;
        }

        // Check auth when page loads
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            // Initialize dashboard
            AdminDashboard.init();
        });
    </script>

    <!-- Dashboard JS -->
    <script>
        // Admin Dashboard Module
        const AdminDashboard = {
            // App state
            state: {
                users: {
                    total: 0,
                    active: 0,
                    pending: 0,
                    suspended: 0,
                    recentUsers: []
                },
                campaigns: {
                    total: 0,
                    active: 0,
                    pending: 0,
                    rejected: 0,
                    recentCampaigns: []
                },
                activity: [],
                charts: {}
            },

            // Configuration
            config: {
                apiBase: '/api.php',
                refreshInterval: 300000, // 5 minutes in milliseconds
                chartColors: {
                    primary: '#2563eb',
                    success: '#10b981',
                    warning: '#f59e0b',
                    danger: '#ef4444',
                    gray: '#9ca3af'
                }
            },

            // Initialize the dashboard
            init() {
                this.setupEventListeners();
                this.loadDashboardData();
                
                // Set up auto-refresh
                this.setupAutoRefresh();
            },
            
            // Set up auto-refresh of dashboard data
            setupAutoRefresh() {
                // Clear any existing interval
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                
                // Set up new refresh interval
                this.refreshInterval = setInterval(() => {
                    this.loadDashboardData(false); // false = don't show loading overlay
                }, this.config.refreshInterval);
            },
            
            // Set up event listeners
            setupEventListeners() {
                // Refresh button
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.loadDashboardData();
                });
            },

            // Show loading indicator
            showLoading(show = true) {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (show) {
                    loadingOverlay.classList.add('active');
                } else {
                    loadingOverlay.classList.remove('active');
                }
            },

            // Show notification
            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                
                notification.className = 'notification';
                notification.classList.add(type);
                notification.classList.add('show');
                
                notificationMessage.textContent = message;
                
                // Hide notification after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            },

            // Load dashboard data
            async loadDashboardData(showLoading = true) {
                try {
                    if (showLoading) {
                        this.showLoading(true);
                    }
                    
                    // Load users and campaigns data in parallel
                    const [usersData, campaignsData] = await Promise.all([
                        this.loadUsersData(),
                        this.loadCampaignsData()
                    ]);
                    
                    // Load activity data after we have users and campaigns
                    // This allows us to generate activity based on that data
                    await this.loadActivityData();
                    
                    // Render dashboard elements
                    this.renderDashboard();
                    
                    if (showLoading) {
                        this.showLoading(false);
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.showNotification('Failed to load dashboard data. Please try again.', 'error');
                    
                    if (showLoading) {
                        this.showLoading(false);
                    }
                }
            },

            // Load users data from the real API
            async loadUsersData() {
                try {
                    // Get the admin token for authorization
                    const adminToken = localStorage.getItem('adminToken');
                    
                    if (!adminToken) {
                        throw new Error('Admin authentication required');
                    }
                    
                    // Fetch users data from the API
                    const response = await fetch(`${this.config.apiBase}/admin/users`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to load users: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // Process the data for dashboard
                    const stats = data.stats || {
                        total: 0,
                        active: 0,
                        pending: 0,
                        suspended: 0
                    };
                    
                    // Get recent users from the data
                    const recentUsers = data.users || [];
                    
                    // Generate growth data if not provided
                    // In a real implementation, you might want to fetch this from a dedicated endpoint
                    const currentDate = new Date();
                    const months = [];
                    
                    for (let i = 5; i >= 0; i--) {
                        const month = new Date(currentDate);
                        month.setMonth(currentDate.getMonth() - i);
                        months.push(month.toLocaleString('default', { month: 'short' }));
                    }
                    
                    // Calculate a simple growth curve
                    const growth = months.map((month, index) => {
                        // Simple growth formula that ends at the total user count
                        const users = Math.round(stats.total * (0.6 + (index * 0.08)));
                        return { month, users };
                    });
                    
                    // Update state with the data
                    this.state.users = {
                        ...this.state.users,
                        ...stats,
                        recentUsers: recentUsers,
                        growth: growth
                    };
                    
                    return {
                        stats,
                        recentUsers,
                        growth
                    };
                } catch (error) {
                    console.error('Error loading users data:', error);
                    
                    // Fallback to initial state or empty data
                    this.state.users = {
                        ...this.state.users,
                        total: 0,
                        active: 0,
                        pending: 0,
                        suspended: 0,
                        recentUsers: [],
                        growth: []
                    };
                    
                    throw error;
                }
            },

            // Load campaigns data from the real API
            async loadCampaignsData() {
                try {
                    // Get the admin token for authorization
                    const adminToken = localStorage.getItem('adminToken');
                    
                    if (!adminToken) {
                        throw new Error('Admin authentication required');
                    }
                    
                    // Fetch campaigns data from the API
                    const response = await fetch(`${this.config.apiBase}/admin/campaigns`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to load campaigns: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // Process the campaigns data
                    const campaigns = Array.isArray(data) ? data : data.campaigns || [];
                    
                    // Count campaigns by status
                    const stats = {
                        total: campaigns.length,
                        active: campaigns.filter(c => c.status === 'active').length,
                        pending: campaigns.filter(c => c.status === 'pending').length,
                        rejected: campaigns.filter(c => c.status === 'rejected').length
                    };
                    
                    // Sort campaigns by creation date (newest first) for the recent list
                    const sortedCampaigns = [...campaigns].sort((a, b) => {
                        const dateA = new Date(a.createdAt || 0);
                        const dateB = new Date(b.createdAt || 0);
                        return dateB - dateA;
                    });
                    
                    // Get the 5 most recent campaigns
                    const recentCampaigns = sortedCampaigns.slice(0, 5);
                    
                    // Calculate total funding
                    // This assumes campaigns have a 'raised' or similar field
                    // Calculate total funding with better error handling
                    const totalFunding = campaigns.reduce((sum, campaign) => {
                        // Try different field names that might hold the funding amount
                        const amount = campaign.raised || campaign.funding || campaign.amountRaised || campaign.currentAmount || 0;
                        
                        // Make sure we're dealing with a valid number
                        const numericAmount = parseFloat(amount);
                        return sum + (isNaN(numericAmount) ? 0 : numericAmount);
                    }, 0);

                    // Generate monthly data for the chart
                    // This would ideally come from a dedicated endpoint in a real app
                    const currentDate = new Date();
                    const months = [];
                    
                    for (let i = 5; i >= 0; i--) {
                        const month = new Date(currentDate);
                        month.setMonth(currentDate.getMonth() - i);
                        months.push(month.toLocaleString('default', { month: 'short' }));
                    }
                    
                    // Create a simple distribution for the chart
                    const monthlyData = months.map((month, index) => {
                        // Use simple formulas that reflect the current counts
                        const activeCount = Math.round(stats.active * (0.5 + (index * 0.1)));
                        const pendingCount = Math.round(stats.pending * (0.4 + (index * 0.12)));
                        const rejectedCount = Math.round(stats.rejected * (0.6 + (index * 0.08)));
                        
                        return {
                            month,
                            active: activeCount,
                            pending: pendingCount,
                            rejected: rejectedCount
                        };
                    });
                    
                    // Update state with the processed data
                    this.state.campaigns = {
                        ...this.state.campaigns,
                        ...stats,
                        recentCampaigns,
                        monthlyData,
                        totalFunding
                    };
                    
                    return {
                        stats,
                        recentCampaigns,
                        monthlyData,
                        totalFunding
                    };
                } catch (error) {
                    console.error('Error loading campaigns data:', error);
                    
                    // Fallback to initial state
                    this.state.campaigns = {
                        ...this.state.campaigns,
                        total: 0,
                        active: 0,
                        pending: 0,
                        rejected: 0,
                        recentCampaigns: [],
                        monthlyData: [],
                        totalFunding: 0
                    };
                    
                    throw error;
                }
            },

            // Load activity data from the real API
            async loadActivityData() {
                try {
                    // Get the admin token for authorization
                    const adminToken = localStorage.getItem('adminToken');
                    
                    if (!adminToken) {
                        throw new Error('Admin authentication required');
                    }
                    
                    // In a real implementation, you would fetch activity data from a dedicated endpoint
                    // Since we don't have a specific activity endpoint, we'll create activity data
                    // based on recent users and campaigns
                    
                    // Generate activity data from recent users and campaigns
                    const activity = [];
                    
                    // Add user registrations to activity
                    if (this.state.users.recentUsers && this.state.users.recentUsers.length > 0) {
                        this.state.users.recentUsers.forEach(user => {
                            activity.push({
                                type: 'user_joined',
                                title: 'New user registered',
                                details: user.displayName || user.username || 'New User',
                                timestamp: user.created || user.createdAt || new Date().toISOString()
                            });
                        });
                    }
                    
                    // Add campaign activities
                    if (this.state.campaigns.recentCampaigns && this.state.campaigns.recentCampaigns.length > 0) {
                        this.state.campaigns.recentCampaigns.forEach(campaign => {
                            // Campaign creation
                            activity.push({
                                type: 'campaign_created',
                                title: 'New campaign created',
                                details: campaign.title || 'Untitled Campaign',
                                user: campaign.creatorName || 'Campaign Creator',
                                timestamp: campaign.createdAt || new Date().toISOString()
                            });
                            
                            // Add campaign status changes if available
                            if (campaign.reviewedAt) {
                                activity.push({
                                    type: campaign.status === 'active' ? 'campaign_approved' : 'campaign_rejected',
                                    title: campaign.status === 'active' ? 'Campaign approved' : 'Campaign rejected',
                                    details: campaign.title || 'Untitled Campaign',
                                    user: campaign.reviewedBy || 'Admin User',
                                    timestamp: campaign.reviewedAt
                                });
                            }
                        });
                    }
                    
                    // Sort activities by timestamp (newest first)
                    activity.sort((a, b) => {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
                    
                    // Take only the 6 most recent activities
                    const recentActivity = activity.slice(0, 6);
                    
                    // Update state with the activity data
                    this.state.activity = recentActivity;
                    
                    return recentActivity;
                } catch (error) {
                    console.error('Error loading activity data:', error);
                    
                    // Fallback to empty activity
                    this.state.activity = [];
                    
                    throw error;
                }
            },

            // Render dashboard elements
            renderDashboard() {
                // Update count cards
                this.updateCountCards();
                
                // Render charts
                this.renderCharts();
                
                // Render tables
                this.renderRecentCampaigns();
                this.renderRecentUsers();
                
                // Render activity list
                this.renderRecentActivity();
            },

            // Update count cards with current stats
            updateCountCards() {
                document.getElementById('total-users-count').textContent = this.state.users.total;
                document.getElementById('active-campaigns-count').textContent = this.state.campaigns.active;
                document.getElementById('pending-count').textContent = this.state.campaigns.pending;
                document.getElementById('total-funding').textContent = this.formatCurrency(this.state.campaigns.totalFunding);
            },

            // Render dashboard charts
            renderCharts() {
                this.renderCampaignsChart();
                this.renderUsersChart();
            },

            // Render campaigns chart
            renderCampaignsChart() {
                const ctx = document.getElementById('campaigns-chart').getContext('2d');
                
                const monthlyData = this.state.campaigns.monthlyData || [];
                
                // Destroy existing chart if it exists
                if (this.state.charts.campaignsChart) {
                    this.state.charts.campaignsChart.destroy();
                }
                
                // Create new chart
                this.state.charts.campaignsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: monthlyData.map(item => item.month),
                        datasets: [
                            {
                                label: 'Active',
                                data: monthlyData.map(item => item.active),
                                backgroundColor: this.config.chartColors.success
                            },
                            {
                                label: 'Pending',
                                data: monthlyData.map(item => item.pending),
                                backgroundColor: this.config.chartColors.warning
                            },
                            {
                                label: 'Rejected',
                                data: monthlyData.map(item => item.rejected),
                                backgroundColor: this.config.chartColors.danger
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            },

            // Render users chart
            renderUsersChart() {
                const ctx = document.getElementById('users-chart').getContext('2d');
                
                const growthData = this.state.users.growth || [];
                
                // Destroy existing chart if it exists
                if (this.state.charts.usersChart) {
                    this.state.charts.usersChart.destroy();
                }
                
                // Create new chart
                this.state.charts.usersChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: growthData.map(item => item.month),
                        datasets: [{
                            label: 'Total Users',
                            data: growthData.map(item => item.users),
                            fill: true,
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderColor: this.config.chartColors.primary,
                            tension: 0.4,
                            pointBackgroundColor: 'white',
                            pointBorderColor: this.config.chartColors.primary,
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            },

            // Render recent campaigns table
            renderRecentCampaigns() {
                const tableBody = document.getElementById('recent-campaigns-table');
                tableBody.innerHTML = '';
                
                if (!this.state.campaigns.recentCampaigns || this.state.campaigns.recentCampaigns.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `<td colspan="5" style="text-align: center; padding: 1.5rem;">No recent campaigns</td>`;
                    tableBody.appendChild(emptyRow);
                    return;
                }
                
                // Create rows for recent campaigns
                this.state.campaigns.recentCampaigns.slice(0, 5).forEach(campaign => {
                    const row = document.createElement('tr');
                    
                    // Determine status badge class
                    let badgeClass = 'badge-pending';
                    if (campaign.status === 'active') {
                        badgeClass = 'badge-active';
                    } else if (campaign.status === 'rejected') {
                        badgeClass = 'badge-rejected';
                    }
                    
                    // Format date
                    const createdDate = new Date(campaign.createdAt).toLocaleDateString();
                    
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500;">${campaign.title}</div>
                            <div style="font-size: 0.75rem; color: var(--gray-600);">${this.formatCurrency(campaign.fundingGoal)} goal</div>
                        </td>
                        <td>${campaign.creatorName}</td>
                        <td><span class="badge ${badgeClass}">${this.capitalizeFirstLetter(campaign.status)}</span></td>
                        <td>${createdDate}</td>
                        <td>
                            <a href="campaigns.html?id=${campaign._id}" class="btn btn-sm btn-outline">
                                Review
                            </a>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            },

            // Render recent users table
            renderRecentUsers() {
                const tableBody = document.getElementById('recent-users-table');
                tableBody.innerHTML = '';
                
                if (!this.state.users.recentUsers || this.state.users.recentUsers.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `<td colspan="3" style="text-align: center; padding: 1.5rem;">No recent users</td>`;
                    tableBody.appendChild(emptyRow);
                    return;
                }
                
                // Create rows for recent users
                this.state.users.recentUsers.slice(0, 4).forEach(user => {
                    const row = document.createElement('tr');
                    
                    // Create user initials for avatar
                    const initials = (user.personalInfo.firstName && user.personalInfo.lastName) ? user.personalInfo.firstName[0] + user.personalInfo.lastName[0] : '??';

                    
                    // Determine status class
                    let statusClass = 'user-status pending';
                    if (user.status === 'active') {
                        statusClass = 'user-status active';
                    } else if (user.status === 'suspended') {
                        statusClass = 'user-status suspended';
                    }
                    
                    row.innerHTML = `
                        <td>
                            <div class="user-name-cell">
                                <div class="user-avatar">${initials}</div>
                                <div>
                                    <div class="user-name">${user.displayName}</div>
                                    <div class="user-email">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="${statusClass}">${this.capitalizeFirstLetter(user.status)}</span></td>
                        <td>
                            <a href="users.html?id=${user._id}" class="btn btn-sm btn-outline">
                                View
                            </a>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            },

            // Render recent activity list
            renderRecentActivity() {
                const activityList = document.getElementById('recent-activity-list');
                activityList.innerHTML = '';
                
                if (!this.state.activity || this.state.activity.length === 0) {
                    activityList.innerHTML = `<div style="text-align: center; padding: 1rem; color: var(--gray-600);">No recent activity</div>`;
                    return;
                }
                
                // Create activity items
                this.state.activity.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    // Determine icon based on activity type
                    let iconSvg = '';
                    switch (activity.type) {
                        case 'campaign_created':
                        case 'campaign_updated':
                        case 'campaign_approved':
                            iconSvg = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>';
                            break;
                        case 'user_joined':
                        case 'user_status_changed':
                            iconSvg = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>';
                            break;
                        case 'donation_made':
                            iconSvg = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
                            break;
                        default:
                            iconSvg = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
                    }
                    
                    // Format timestamp
                    const timestamp = this.formatTimeAgo(new Date(activity.timestamp));
                    
                    // Create content
                    activityItem.innerHTML = `
                        <div class="activity-icon">
                            ${iconSvg}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-meta">
                                <span>${activity.details}</span>
                                <span>${timestamp}</span>
                            </div>
                            ${activity.user ? `<div style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.25rem;">by ${activity.user}</div>` : ''}
                        </div>
                    `;
                    
                    activityList.appendChild(activityItem);
                });
            },

            // Utility: Format currency
            formatCurrency(amount, currency = 'USD') {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currency,
                    maximumFractionDigits: 0
                }).format(amount);
            },

            // Utility: Format date
            formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            },

            // Utility: Format time ago
            formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                
                let interval = Math.floor(seconds / 31536000);
                if (interval >= 1) {
                    return interval === 1 ? '1 year ago' : `${interval} years ago`;
                }
                
                interval = Math.floor(seconds / 2592000);
                if (interval >= 1) {
                    return interval === 1 ? '1 month ago' : `${interval} months ago`;
                }
                
                interval = Math.floor(seconds / 86400);
                if (interval >= 1) {
                    return interval === 1 ? '1 day ago' : `${interval} days ago`;
                }
                
                interval = Math.floor(seconds / 3600);
                if (interval >= 1) {
                    return interval === 1 ? '1 hour ago' : `${interval} hours ago`;
                }
                
                interval = Math.floor(seconds / 60);
                if (interval >= 1) {
                    return interval === 1 ? '1 minute ago' : `${interval} minutes ago`;
                }
                
                return 'just now';
            },

            // Utility: Capitalize first letter
            capitalizeFirstLetter(string) {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
        };
    </script>
</body>
</html>
