<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Addresses - The Give Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..800&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #f4f4f9;
            --text-color: #333;
            --header-background: #666;
            --header-color: #fff;
            --primary-color: #2563eb;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            box-sizing: border-box;
            font-family: "Lexend", "Helvetica Neue", "Helvetica", sans-serif;
            font-size: 16px;
        }

        * {
            box-sizing: inherit;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Lexend", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
        }

        .header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .header h1 {
            color: var(--text-color);
            font-size: 1.75rem;
        }

        .add-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
        }

        .add-button:hover {
            background-color: var(--primary-hover);
        }

        .address-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .address-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            position: relative;
            transition: box-shadow 0.2s;
        }

        .address-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .address-type {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: var(--primary-color);
            color: white;
        }

        .default-badge {
            background-color: var(--success-color);
        }

        .address-content {
            margin-bottom: 1.5rem;
        }

        .address-line {
            margin-bottom: 0.25rem;
        }

        .address-line:last-child {
            margin-bottom: 0;
        }

        .address-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .action-button {
            padding: 0.5rem 0.75rem;
            background-color: #f3f4f6;
            color: var(--text-color);
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .action-button:hover {
            background-color: #e5e7eb;
        }

        .action-button.edit {
            background-color: var(--primary-color);
            color: white;
        }

        .action-button.edit:hover {
            background-color: var(--primary-hover);
        }

        .action-button.delete {
            background-color: var(--danger-color);
            color: white;
        }

        .action-button.delete:hover {
            background-color: #dc2626;
        }

        .empty-state {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            text-align: center;
            margin-top: 2rem;
        }

        .empty-state h2 {
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-col {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .validation-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .validation-error {
            background-color: #fee2e2;
            color: var(--danger-color);
        }

        .validation-success {
            background-color: #dcfce7;
            color: var(--success-color);
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #111827;
                --text-color: #f3f4f6;
                --primary-hover: #1d4ed8;
            }

            .address-card, .empty-state, .modal-content {
                background-color: #1f2937;
            }

            .action-button {
                background-color: #374151;
                color: #f3f4f6;
            }

            .action-button:hover {
                background-color: #4b5563;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Manage Addresses</h1>
            <button id="addAddressBtn" class="add-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add New Address
            </button>
        </div>

        <div id="addressesContainer" class="address-grid">
            <!-- Address cards will be populated here -->
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h2>No Addresses Found</h2>
            <p>You haven't added any addresses to your account yet.</p>
            <button id="emptyAddAddressBtn" class="add-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add Your First Address
            </button>
        </div>
    </div>

    <!-- Address Edit/Add Modal -->
    <div id="addressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Address</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <input type="hidden" id="addressId">
                    
                    <div class="form-group">
                        <label for="addressType">Address Type</label>
                        <select id="addressType" required>
                            <option value="home">Home</option>
                            <option value="work">Work</option>
                            <option value="shipping">Shipping</option>
                            <option value="billing">Billing</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="street">Street Address</label>
                        <input type="text" id="street" required>
                    </div>

                    <div class="form-group">
                        <label for="unit">Apartment/Suite/Unit (Optional)</label>
                        <input type="text" id="unit">
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="city">City</label>
                            <input type="text" id="city" required>
                        </div>

                        <div class="form-col">
                            <label for="state">State/Province/Region</label>
                            <input type="text" id="state">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="zip">ZIP/Postal Code</label>
                            <input type="text" id="zip">
                        </div>

                        <div class="form-col">
                            <label for="country">Country</label>
                            <select id="country" required>
                                <option value="">Select a country</option>
                                <option value="US">United States</option>
                                <option value="CA">Canada</option>
                                <option value="UK">United Kingdom</option>
                                <option value="AU">Australia</option>
                                <!-- Add more countries as needed -->
                            </select>
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="isDefault">
                        <label for="isDefault">Set as default address</label>
                    </div>

                    <div id="validationMessage" class="validation-message" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="validateAddressBtn" class="action-button edit">Validate Address</button>
                <button id="saveAddressBtn" class="action-button" disabled>Save Address</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px">
            <div class="modal-header">
                <h2 class="modal-title">Delete Address</h2>
                <button class="modal-close" id="deleteModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this address? This action cannot be undone.</p>
                <input type="hidden" id="deleteAddressId">
            </div>
            <div class="modal-footer">
                <button id="cancelDeleteBtn" class="action-button">Cancel</button>
                <button id="confirmDeleteBtn" class="action-button delete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const app = {
                data: {
                    addresses: [],
                    currentAddress: null,
                    addressValidated: false
                },
                elements: {
                    addressesContainer: document.getElementById('addressesContainer'),
                    emptyState: document.getElementById('emptyState'),
                    addressModal: document.getElementById('addressModal'),
                    deleteModal: document.getElementById('deleteModal'),
                    modalTitle: document.getElementById('modalTitle'),
                    addressForm: document.getElementById('addressForm'),
                    validationMessage: document.getElementById('validationMessage'),
                    // Form fields
                    addressId: document.getElementById('addressId'),
                    addressType: document.getElementById('addressType'),
                    street: document.getElementById('street'),
                    unit: document.getElementById('unit'),
                    city: document.getElementById('city'),
                    state: document.getElementById('state'),
                    zip: document.getElementById('zip'),
                    country: document.getElementById('country'),
                    isDefault: document.getElementById('isDefault'),
                    // Buttons
                    addAddressBtn: document.getElementById('addAddressBtn'),
                    emptyAddAddressBtn: document.getElementById('emptyAddAddressBtn'),
                    modalClose: document.getElementById('modalClose'),
                    validateAddressBtn: document.getElementById('validateAddressBtn'),
                    saveAddressBtn: document.getElementById('saveAddressBtn'),
                    deleteModalClose: document.getElementById('deleteModalClose'),
                    cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
                    confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
                    deleteAddressId: document.getElementById('deleteAddressId')
                },
                init() {
                    this.loadAddresses();
                    this.bindEvents();
                },
                bindEvents() {
                    // Add address buttons
                    this.elements.addAddressBtn.addEventListener('click', () => this.openAddModal());
                    this.elements.emptyAddAddressBtn.addEventListener('click', () => this.openAddModal());
                    
                    // Modal controls
                    this.elements.modalClose.addEventListener('click', () => this.closeModal('addressModal'));
                    this.elements.deleteModalClose.addEventListener('click', () => this.closeModal('deleteModal'));
                    this.elements.cancelDeleteBtn.addEventListener('click', () => this.closeModal('deleteModal'));
                    
                    // Form actions
                    this.elements.validateAddressBtn.addEventListener('click', () => this.validateAddress());
                    this.elements.saveAddressBtn.addEventListener('click', () => this.saveAddress());
                    this.elements.confirmDeleteBtn.addEventListener('click', () => this.deleteAddress());
                    
                    // Country change - adjust required fields
                    this.elements.country.addEventListener('change', () => this.setupCountrySpecificFields());
                },
                async loadAddresses() {
                    try {
                        const response = await fetch('/api/address/list', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to load addresses');
                        }
                        
                        const result = await response.json();
                        this.data.addresses = result.addresses || [];
                        
                        this.renderAddresses();
                    } catch (error) {
                        console.error('Error loading addresses:', error);
                        // Show error message to user
                    }
                },
                renderAddresses() {
                    const container = this.elements.addressesContainer;
                    container.innerHTML = '';
                    
                    if (!this.data.addresses.length) {
                        this.elements.emptyState.style.display = 'block';
                        return;
                    }
                    
                    this.elements.emptyState.style.display = 'none';
                    
                    this.data.addresses.forEach(address => {
                        const card = document.createElement('div');
                        card.className = 'address-card';
                        
                        // Address type badge
                        const typeBadge = document.createElement('div');
                        typeBadge.className = `address-type ${address.isDefault ? 'default-badge' : ''}`;
                        typeBadge.textContent = address.isDefault ? 'Default' : this.formatAddressType(address.type);
                        card.appendChild(typeBadge);
                        
                        // Address content
                        const content = document.createElement('div');
                        content.className = 'address-content';
                        
                        // Format the address
                        const formattedAddress = this.formatAddress(address);
                        formattedAddress.forEach(line => {
                            const addressLine = document.createElement('div');
                            addressLine.className = 'address-line';
                            addressLine.textContent = line;
                            content.appendChild(addressLine);
                        });
                        
                        card.appendChild(content);
                        
                        // Address actions
                        const actions = document.createElement('div');
                        actions.className = 'address-actions';
                        
                        const editBtn = document.createElement('button');
                        editBtn.className = 'action-button edit';
                        editBtn.textContent = 'Edit';
                        editBtn.addEventListener('click', () => this.openEditModal(address));
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'action-button delete';
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.addEventListener('click', () => this.openDeleteModal(address));
                        
                        if (!address.isDefault) {
                            const setDefaultBtn = document.createElement('button');
                            setDefaultBtn.className = 'action-button';
                            setDefaultBtn.textContent = 'Set as Default';
                            setDefaultBtn.addEventListener('click', () => this.setDefaultAddress(address._id));
                            actions.appendChild(setDefaultBtn);
                        }
                        
                        actions.appendChild(editBtn);
                        actions.appendChild(deleteBtn);
                        
                        card.appendChild(actions);
                        
                        container.appendChild(card);
                    });
                },
                formatAddressType(type) {
                    const types = {
                        'home': 'Home',
                        'work': 'Work',
                        'shipping': 'Shipping',
                        'billing': 'Billing',
                        'other': 'Other'
                    };
                    
                    return types[type] || 'Address';
                },
                formatAddress(address) {
                    const lines = [];
                    
                    // Line 1: Street + Unit
                    let line1 = address.street || '';
                    if (address.unit) {
                        line1 += `, ${address.unit}`;
                    }
                    lines.push(line1);
                    
                    // Line 2: City, State ZIP
                    let line2 = address.city || '';
                    if (address.state) {
                        line2 += `, ${address.state}`;
                    }
                    if (address.zip) {
                        line2 += ` ${address.zip}`;
                    }
                    lines.push(line2);
                    
                    // Line 3: Country
                    if (address.country) {
                        const countries = {
                            'US': 'United States',
                            'CA': 'Canada',
                            'UK': 'United Kingdom',
                            'AU': 'Australia'
                        };
                        
                        lines.push(countries[address.country] || address.country);
                    }
                    
                    return lines;
                },
                openAddModal() {
                    this.resetForm();
                    this.elements.modalTitle.textContent = 'Add New Address';
                    this.elements.addressId.value = '';
                    this.elements.addressModal.classList.add('open');
                    this.setupCountrySpecificFields();
                },
                openEditModal(address) {
                    this.resetForm();
                    this.elements.modalTitle.textContent = 'Edit Address';
                    
                    // Populate form
                    this.elements.addressId.value = address._id;
                    this.elements.addressType.value = address.type || 'home';
                    this.elements.street.value = address.street || '';
                    this.elements.unit.value = address.unit || '';
                    this.elements.city.value = address.city || '';
                    this.elements.state.value = address.state || '';
                    this.elements.zip.value = address.zip || '';
                    this.elements.country.value = address.country || '';
                    this.elements.isDefault.checked = address.isDefault || false;
                    
                    // Store current address for validation comparison
                    this.data.currentAddress = { ...address };
                    
                    // If the address is already validated, enable save button
                    this.data.addressValidated = true;
                    this.elements.saveAddressBtn.disabled = false;
                    
                    this.setupCountrySpecificFields();
                    this.elements.addressModal.classList.add('open');
                },
                openDeleteModal(address) {
                    this.elements.deleteAddressId.value = address._id;
                    this.elements.deleteModal.classList.add('open');
                },
                closeModal(modalId) {
                    this.elements[modalId].classList.remove('open');
                },
                resetForm() {
                    this.elements.addressForm.reset();
                    this.elements.validationMessage.style.display = 'none';
                    this.elements.saveAddressBtn.disabled = true;
                    this.data.addressValidated = false;
                },
                setupCountrySpecificFields() {
                    const country = this.elements.country.value;
                    const stateLabel = document.querySelector('label[for="state"]');
                    const zipLabel = document.querySelector('label[for="zip"]');
                    
                    // Reset required attributes
                    this.elements.state.required = false;
                    this.elements.zip.required = false;
                    
                    // Adjust field names and requirements based on country
                    switch (country) {
                        case 'US':
                            stateLabel.textContent = 'State';
                            zipLabel.textContent = 'ZIP Code';
                            this.elements.state.required = true;
                            this.elements.zip.required = true;
                            this.elements.zip.placeholder = '12345';
                            break;
                            
                        case 'CA':
                            stateLabel.textContent = 'Province';
                            zipLabel.textContent = 'Postal Code';
                            this.elements.state.required = true;
                            this.elements.zip.required = true;
                            this.elements.zip.placeholder = 'A1A 1A1';
                            break;
                            
                        case 'UK':
                            stateLabel.textContent = 'County (Optional)';
                            zipLabel.textContent = 'Postcode';
                            this.elements.zip.required = true;
                            this.elements.zip.placeholder = '';
                            break;
                            
                        case 'AU':
                            stateLabel.textContent = 'State/Territory';
                            zipLabel.textContent = 'Postcode';
                            this.elements.state.required = true;
                            this.elements.zip.required = true;
                            this.elements.zip.placeholder = '1234';
                            break;
                            
                        default:
                            stateLabel.textContent = 'State/Province/Region';
                            zipLabel.textContent = 'ZIP/Postal Code';
                            this.elements.zip.placeholder = '';
                    }
                },
                async validateAddress() {
                    try {
                        // Reset validation message
                        this.elements.validationMessage.style.display = 'none';
                        this.elements.validationMessage.textContent = '';
                        this.elements.validationMessage.className = 'validation-message';
                        
                        // Collect address data
                        const addressData = {
                            street: this.elements.street.value,
                            unit: this.elements.unit.value,
                            city: this.elements.city.value,
                            state: this.elements.state.value,
                            zip: this.elements.zip.value,
                            country: this.elements.country.value
                        };
                        
                        // Basic form validation
                        if (!addressData.street || !addressData.city || !addressData.country) {
                            this.showValidationMessage('Please fill out all required fields', 'error');
                            return;
                        }
                        
                        // If form matches existing validated address, skip validation
                        if (this.data.currentAddress) {
                            const isUnchanged = 
                                this.data.currentAddress.street === addressData.street &&
                                this.data.currentAddress.unit === addressData.unit &&
                                this.data.currentAddress.city === addressData.city &&
                                this.data.currentAddress.state === addressData.state &&
                                this.data.currentAddress.zip === addressData.zip &&
                                this.data.currentAddress.country === addressData.country;
                            
                            if (isUnchanged) {
                                this.data.addressValidated = true;
                                this.elements.saveAddressBtn.disabled = false;
                                this.showValidationMessage('Address is valid', 'success');
                                return;
                            }
                        }
                        
                        // Send validation request
                        const response = await fetch('/api/address/validate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                            },
                            body: JSON.stringify(addressData)
                        });
                        
                        if (!response.ok) {
                            throw new Error('Validation service unavailable');
                        }
                        
                        const result = await response.json();
                        
                        if (result.valid) {
                            // Address is valid - update form with normalized address
                            if (result.normalized) {
                                this.elements.street.value = result.normalized.street || addressData.street;
                                this.elements.unit.value = result.normalized.unit || addressData.unit;
                                this.elements.city.value = result.normalized.city || addressData.city;
                                this.elements.state.value = result.normalized.state || addressData.state;
                                this.elements.zip.value = result.normalized.zip || addressData.zip;
                                
                                if (result.normalized.country) {
                                    this.elements.country.value = result.normalized.country;
                                    this.setupCountrySpecificFields();
                                }
                            }
                            
                            this.data.addressValidated = true;
                            this.elements.saveAddressBtn.disabled = false;
                            this.showValidationMessage('Address validated successfully', 'success');
                        } else {
                            // Handle validation errors
                            if (result.errors) {
                                const errorMessage = Object.values(result.errors).join(', ');
                                this.showValidationMessage(errorMessage, 'error');
                            } else {
                                this.showValidationMessage('Unable to validate address', 'error');
                            }
                            
                            this.data.addressValidated = false;
                            this.elements.saveAddressBtn.disabled = true;
                        }
                    } catch (error) {
                        console.error('Address validation error:', error);
                        this.showValidationMessage('Error validating address. Please try again.', 'error');
                    }
                },
                showValidationMessage(message, type) {
                    this.elements.validationMessage.textContent = message;
                    this.elements.validationMessage.className = `validation-message validation-${type}`;
                    this.elements.validationMessage.style.display = 'block';
                },
                async saveAddress() {
                    if (!this.data.addressValidated) {
                        this.showValidationMessage('Please validate the address first', 'error');
                        return;
                    }
                    
                    try {
                        const addressId = this.elements.addressId.value;
                        const isNewAddress = !addressId;
                        
                        const addressData = {
                            type: this.elements.addressType.value,
                            street: this.elements.street.value,
                            unit: this.elements.unit.value,
                            city: this.elements.city.value,
                            state: this.elements.state.value,
                            zip: this.elements.zip.value,
                            country: this.elements.country.value,
                            isDefault: this.elements.isDefault.checked
                        };
                        
                        if (!isNewAddress) {
                            addressData._id = addressId;
                        }
                        
                        const endpoint = isNewAddress ? '/api/address/add' : '/api/address/update';
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                            },
                            body: JSON.stringify(addressData)
                        });
                        
                        if (!response.ok) {
                            throw new Error(isNewAddress ? 'Failed to add address' : 'Failed to update address');
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Reload addresses and close modal
                            await this.loadAddresses();
                            this.closeModal('addressModal');
                        } else {
                            throw new Error(result.error || 'Operation failed');
                        }
                    } catch (error) {
                        console.error('Error saving address:', error);
                        this.showValidationMessage(error.message, 'error');
                    }
                },
                async deleteAddress() {
                    try {
                        const addressId = this.elements.deleteAddressId.value;
                        
                        if (!addressId) {
                            throw new Error('No address selected for deletion');
                        }
                        
                        const response = await fetch(`/api/address/delete?id=${addressId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to delete address');
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Reload addresses and close modal
                            await this.loadAddresses();
                            this.closeModal('deleteModal');
                        } else {
                            throw new Error(result.error || 'Deletion failed');
                        }
                    } catch (error) {
                        console.error('Error deleting address:', error);
                        // Show error message
                    }
                },
                async setDefaultAddress(addressId) {
                    try {
                        const response = await fetch(`/api/address/set-default?id=${addressId}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to set default address');
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Reload addresses
                            await this.loadAddresses();
                        } else {
                            throw new Error(result.error || 'Operation failed');
                        }
                    } catch (error) {
                        console.error('Error setting default address:', error);
                        // Show error message
                    }
                }
            };
            
            // Initialize the app
            app.init();
        });
    </script>
</body>
</html>
