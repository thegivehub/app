<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Browser</title>
    <script src="/lib/APIConfig.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        h1 {
            color: #333;
            margin: 20px;
        }
        .campaign-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            width: 90%;
            max-width: 1200px;
            margin-bottom: 20px;
        }
        .campaign-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-decoration: none;
            color: inherit;
            transition: box-shadow 0.2s;
        }
        .campaign-card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .campaign-image-container {
            width: 100%;
            height: 150px;
            overflow: hidden;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f0f0f0;
        }
        .campaign-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .campaign-title {
            font-size: 1.2em;
            margin: 0 0 10px;
            color: #333;
        }
        .campaign-location, .campaign-goal, .campaign-progress {
            font-size: 0.9em;
            margin: 5px 0;
            color: #555;
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar div {
            height: 10px;
            background-color: #4caf50;
        }
        .view-more {
            margin-top: auto;
            font-size: 0.9em;
            color: #0066cc;
            text-align: right;
            width: 100%;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background-color: #f0f0f0;
        }
        .pagination button:disabled {
            background-color: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }
        .pagination .current-page {
            padding: 8px 12px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .loading {
            display: none;
            margin: 20px 0;
        }
        .loading.active {
            display: block;
        }
        .error-message {
            color: #dc3545;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>

<h1>Browse Campaigns</h1>
<div class="loading">Loading campaigns...</div>
<div class="campaign-grid" id="campaign-grid"></div>
<div class="pagination" id="pagination">
    <button id="prev-page" disabled>Previous</button>
    <span class="current-page">Page <span id="current-page-num">1</span></span>
    <button id="next-page">Next</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // State management
    const state = {
        currentPage: 1,
        itemsPerPage: 8,
        totalItems: 0,
        isLoading: false
    };

    // DOM elements
    const campaignGrid = document.getElementById('campaign-grid');
    const loadingElement = document.querySelector('.loading');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const currentPageNum = document.getElementById('current-page-num');

    // Show/hide loading state
    const setLoading = (loading) => {
        state.isLoading = loading;
        loadingElement.classList.toggle('active', loading);
        prevPageBtn.disabled = loading || state.currentPage === 1;
        nextPageBtn.disabled = loading;
    };

    // Fetch campaigns for the current page
    const fetchCampaigns = async () => {
        try {
            setLoading(true);
            
            // Check if app.api is available for authenticated requests
            if (window.app && window.app.api) {
                // Use the fetchWithAuth helper
                const data = await window.app.api.fetchWithAuth(`/campaign?page=${state.currentPage}&limit=${state.itemsPerPage}&sort=-createdAt`);
                
                // Update total items if provided in response
                if (data.total !== undefined) {
                    state.totalItems = data.total;
                }
                
                // Get the campaigns array (handle both array and object responses)
                const campaigns = Array.isArray(data) ? data : (data.campaigns || []);
                
                renderCampaigns(campaigns);
            } else {
                // Fallback to direct fetch with Authorization header
                const token = localStorage.getItem('accessToken');
                
                const fetchOptions = {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json"
                    }
                };
                
                // Add token to Authorization header if available
                if (token) {
                    fetchOptions.headers["Authorization"] = `Bearer ${token}`;
                }
                
                const response = await fetch(`/api/campaign?page=${state.currentPage}&limit=${state.itemsPerPage}&sort=-createdAt`, fetchOptions);
                
                if (!response.ok) {
                    throw new Error(`Failed to load campaigns: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Update total items if provided in response
                if (data.total !== undefined) {
                    state.totalItems = data.total;
                }
                
                // Get the campaigns array (handle both array and object responses)
                const campaigns = Array.isArray(data) ? data : (data.campaigns || []);
                
                renderCampaigns(campaigns);
            }
        } catch (error) {
            console.error("Error fetching campaigns:", error);
            campaignGrid.innerHTML = '<p class="error-message">Failed to load campaigns. Please try again later.</p>';
        } finally {
            setLoading(false);
        }
    };
    
    // Render campaign cards
    const renderCampaigns = (campaigns) => {
        // Clear existing campaigns
        campaignGrid.innerHTML = '';
        
        campaigns.forEach(campaign => {
            try {
                // Create card element
                const card = document.createElement('div');
                card.classList.add('campaign-card');

                // Campaign image
                const imageContainer = document.createElement('div');
                imageContainer.classList.add('campaign-image-container');
                
                const image = document.createElement('img');
                image.classList.add('campaign-image');
                
                // Check for image in different possible locations in the data structure
                let imageUrl = '/images/placeholder-campaign.jpg'; // Default placeholder
                
                if (campaign.images && campaign.images.length > 0) {
                    imageUrl = campaign.images[0].url || campaign.images[0];
                } else if (campaign.image) {
                    imageUrl = campaign.image;
                } else if (campaign.media && campaign.media.images && campaign.media.images.length > 0) {
                    imageUrl = campaign.media.images[0].url || campaign.media.images[0];
                } else if (campaign.featuredImage) {
                    imageUrl = campaign.featuredImage;
                } else if (campaign.images && campaign.images.image) {
                    imageUrl = campaign.images.image;
                } else if (campaign.image) {
                    imageUrl = campaign.image;
                }
                
                // Handle relative vs absolute URLs
                if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                    //imageUrl = '/images/' + imageUrl;
                }
                
                image.src = imageUrl;
                image.alt = campaign.title || "Campaign image";
                image.onerror = function() {
                    this.src = '/images/placeholder-campaign.jpg';
                    this.onerror = null; // Prevent infinite loop if placeholder also fails
                };
                
                imageContainer.appendChild(image);
                card.appendChild(imageContainer);

                // Campaign title
                const title = document.createElement('h2');
                title.classList.add('campaign-title');
                title.textContent = campaign.title || "Untitled Campaign";
                card.appendChild(title);

                // Campaign location
                const location = document.createElement('p');
                location.classList.add('campaign-location');
                
                // Safely access location properties
                if (campaign.location && campaign.location.region && campaign.location.country) {
                    location.textContent = `Location: ${campaign.location.region}, ${campaign.location.country}`;
                } else if (campaign.location && campaign.location.region) {
                    location.textContent = `Location: ${campaign.location.region}`;
                } else if (campaign.location && campaign.location.country) {
                    location.textContent = `Location: ${campaign.location.country}`;
                } else {
                    location.textContent = 'Location: Not specified';
                }
                card.appendChild(location);

                // Campaign funding goal
                const goal = document.createElement('p');
                goal.classList.add('campaign-goal');
                
                // Safely access funding properties
                if (campaign.funding && campaign.funding.goalAmount !== undefined) {
                    const currency = campaign.funding.currency || 'USD';
                    let amt = new Intl.NumberFormat("en-US", { style: "currency", currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(campaign.funding.goalAmount);
                    goal.textContent = `Goal: ${amt}`;
                } else if (campaign.fundingGoal) {
                    const currency = 'USD';
                    let amt = new Intl.NumberFormat("en-US", { style: "currency", currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(campaign.fundingGoal);
                    goal.textContent = `Goal: ${amt}`;
                } else {
                    goal.textContent = 'Goal: Not specified';
                }
                card.appendChild(goal);

                // Campaign progress
                const progressText = document.createElement('p');
                progressText.classList.add('campaign-progress');
                
                // Progress bar
                const progressBar = document.createElement('div');
                progressBar.classList.add('progress-bar');
                const progressFill = document.createElement('div');
                
                // Safely calculate progress
                if (campaign.funding && 
                    campaign.funding.raisedAmount !== undefined && 
                    campaign.funding.goalAmount !== undefined && 
                    campaign.funding.goalAmount > 0) {
                    
                    const raisedAmount = campaign.funding.raisedAmount;
                    const goalAmount = campaign.funding.goalAmount;
                    const currency = campaign.funding.currency || 'USD';
                    const progress = (raisedAmount / goalAmount) * 100;
                    
                    progressText.textContent = `Progress: ${new Intl.NumberFormat("en-US", { style: "currency", currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0}).format(raisedAmount)} / ${new Intl.NumberFormat("en-US", { style: "currency", currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0}).format(goalAmount)}`;
                    progressFill.style.width = `${Math.min(progress, 100)}%`; // Cap at 100%
                } else if (campaign.funding && campaign.funding.raisedAmount !== undefined) {
                    const currency = campaign.funding.currency || 'USD';
                    progressText.textContent = `Raised: ${new Intl.NumberFormat("en-US", { style: "currency", currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0}).format(campaign.funding.raisedAmount)}`;
                    progressFill.style.width = '0%';
                } else {
                    progressText.textContent = 'Progress: No donations yet';
                    progressFill.style.width = '0%';
                }
                
                card.appendChild(progressText);
                progressBar.appendChild(progressFill);
                card.appendChild(progressBar);

                // View more link
                const viewMore = document.createElement('a');
                viewMore.classList.add('view-more');
                viewMore.href = `campaign-detail.html?id=${campaign._id || campaign.id || ''}`;
                viewMore.textContent = 'View More';
                card.appendChild(viewMore);

                // Append card to grid
                campaignGrid.appendChild(card);
                
            } catch (error) {
                console.error(`Error rendering campaign:`, campaign, error);
            }
        });

        // Update pagination controls
        updatePaginationControls();
    };

    // Update pagination controls
    const updatePaginationControls = () => {
        currentPageNum.textContent = state.currentPage;
        prevPageBtn.disabled = state.currentPage === 1;
        
        // If we have total items, we can determine if there are more pages
        if (state.totalItems) {
            const totalPages = Math.ceil(state.totalItems / state.itemsPerPage);
            nextPageBtn.disabled = state.currentPage >= totalPages;
        } else {
            // If we don't have total items, enable next if we got a full page of items
            const currentItems = campaignGrid.children.length;
            nextPageBtn.disabled = currentItems < state.itemsPerPage;
        }
    };

    // Event listeners for pagination
    prevPageBtn.addEventListener('click', () => {
        if (state.currentPage > 1 && !state.isLoading) {
            state.currentPage--;
            fetchCampaigns();
        }
    });

    nextPageBtn.addEventListener('click', () => {
        if (!state.isLoading) {
            state.currentPage++;
            fetchCampaigns();
        }
    });

    // Initial load
    fetchCampaigns();
});
</script>

</body>
</html>
