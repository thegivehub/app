<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="module" src="../lib/LocationBlock.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Account Settings</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..800&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet" href="/css/login.css" />
    <link rel="stylesheet" href="/css/settings.css" />
  </head>
  <body>
    <div class="container">
      <div class="settings-header">
        <h1>Account Settings</h1>
        <div id="saveStatus" class="success-message"></div>
      </div>

      <div class="settings-layout">
        <div class="settings-nav">
          <div class="nav-item active" data-section="profile">Profile</div>
          <div class="nav-item" data-section="location-block">Location</div>
          <div class="nav-item" data-section="notifications">Notifications</div>
          <div class="nav-item" data-section="payment">Payment Methods</div>
          <div class="nav-item" data-section="security">Security</div>
          <div class="nav-item" style='display:none' data-section="verification">
            Identity Verification
          </div>
        </div>

        <div class="settings-content">
          <!-- Profile Section -->
          <div class="settings-section active" id="profile">
            <form id="profileForm">
              <div style="display: flex;flex-direction: row;">
                <div style="flex: 1;">
                  <div class="form-group">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" required />
                  </div>
                  <div class="form-group" style="display: flex">
                    <span style="display: inline-block; width: 49%">
                      <label for="displayName">First Name</label>
                      <input
                        style="width: 98%; display: inline-block"
                        type="text"
                        id="first_name"
                        name="first_name"
                        required />
                    </span>
                    <span
                      style="display: inline-block; width: -webkit-fill-available">
                      <label for="displayName">Last Name</label>
                      <input
                        style="width: 100%; display: inline-block"
                        type="text"
                        id="last_name"
                        name="last_name"
                        required />
                    </span>
                  </div>
                  <div class="form-group">
                    <label for="email">Phone</label>
                    <input type="tel" id="phone" name="phone" required />
                  </div>
                  <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required />
                  </div>
                </div>
                <div style="flex: 1;" id="avatarDiv">
                  <h1>Profile Image</h1>
                  <img id="avatarImg" src="../images/color-logo.svg" alt="Profile Image" />
                  <div style="margin-top: 1rem">
                    <button class="btn btn-primary" id="changeImage">Change Image</button>
                    <!-- <button id="removeImage"
                      class="btn btn-danger"
                      style="margin-left: 1rem">
                      Remove Image
                    </button> -->
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="bio">Bio</label>
                <textarea id="bio" rows="4"></textarea>
              </div>
              <button id="saveChangesBtn" class="btn btn-primary">Save Changes</button>
            </form>
          </div>

          <div class="settings-section" id="location-block">
            <location-block />
          </div>

          <!-- Notifications Section -->
          <div class="settings-section" id="notifications">
            <div class="form-group">
              <h3>Email Notifications: Choose which to receive</h3>
              <div style="margin-top: 1rem">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 1rem;
                  ">
                  <span>Campaign Updates</span>
                  <label class="switch">
                    <input type="checkbox" checked id="notifCampaign" />
                    <span class="slider"></span>
                  </label>
                </div>
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 1rem;
                  ">
                  <span>New Donations</span>
                  <label class="switch">
                    <input type="checkbox" checked id="notifDonations" />
                    <span class="slider"></span>
                  </label>
                </div>
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 1rem;
                  ">
                  <span>Campaign Milestones</span>
                  <label class="switch">
                    <input type="checkbox" checked id="notifMilestones" />
                    <span class="slider"></span>
                  </label>
                </div>
                <div style="display: flex; justify-content: space-between">
                  <span>Marketing Updates</span>
                  <label class="switch">
                    <input type="checkbox" id="notifMarketing" />
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Methods Section -->
          <div class="settings-section" id="payment">
            <div class="payment-method">
              <div>
                <strong>Visa ending in 4242</strong>
                <div style="color: var(--gray-600)">Expires 12/24</div>
              </div>
              <button class="btn btn-primary">Edit</button>
            </div>
            <div class="payment-method">
              <div>
                <strong>PayPal</strong>
                <div style="color: var(--gray-600)">example@email.com</div>
              </div>
              <button class="btn btn-primary">Edit</button>
            </div>
            <button class="btn btn-primary" style="margin-top: 1rem">
              Add Payment Method
            </button>
          </div>

          <!-- Security Section -->
          <div class="settings-section" id="security">
            <div class="form-group">
              <label for="currentPassword">Current Password</label>
              <input type="password" id="currentPassword" />
            </div>
            <div class="form-group">
              <label for="newPassword">New Password</label>
              <input type="password" id="newPassword" />
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm New Password</label>
              <input type="password" id="confirmPassword" />
            </div>
            <button class="btn btn-primary">Update Password</button>

            <hr style="margin: 2rem 0" />

            <h3 style="color: var(--red-500); margin-bottom: 1rem">
              Danger Zone
            </h3>
            <button class="btn btn-danger">Delete Account</button>
          </div>

          <!-- Identity Verification Section -->
          <div class="settings-section" id="verification">
            <h2>Identity Verification</h2>
            <p class="section-description">
              Verify your identity to gain full access to The Give Hub. This
              helps us maintain a trusted community and comply with regulations.
            </p>

            <div class="verification-status-container">
              <div class="verification-status" id="verificationStatus">
                <div class="status-icon pending">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                  </svg>
                </div>
                <div class="status-text">
                  <h3>Verification Pending</h3>
                  <p>Please complete the verification process below.</p>
                </div>
              </div>
            </div>

            <div class="verification-steps" id="verificationSteps">
              <div class="step-indicator">
                <div class="step-number">1</div>
                <span>Upload ID</span>
              </div>
              <div class="step-divider"></div>
              <div class="step-indicator">
                <div class="step-number">2</div>
                <span>Take Selfie</span>
              </div>
              <div class="step-divider"></div>
              <div class="step-indicator">
                <div class="step-number">3</div>
                <span>Review</span>
              </div>
            </div>

            <div class="verification-step-content" id="verificationStepContent">
              <!-- Step 1: ID Document Upload -->
              <div class="step-content active" data-step="1">
                <h3>Upload an identification document</h3>
                <p>
                  Please provide a clear photo of your government-issued ID
                  (passport, driver's license, or ID card).
                </p>

                <div class="document-upload-container">
                  <div class="upload-area" id="idDocumentUpload">
                    <div class="upload-icon">
                      <svg
                        width="48"
                        height="48"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <path
                          d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                      </svg>
                    </div>
                    <p>
                      Drag and drop your ID document here or click to browse
                    </p>
                    <input
                      type="file"
                      id="idDocumentInput"
                      accept="image/*"
                      style="display: none" />
                  </div>
                  <div
                    class="document-preview"
                    id="idDocumentPreview"
                    style="display: none">
                    <img src="" alt="ID Document Preview" />
                    <button
                      type="button"
                      class="remove-button"
                      id="removeIdDocument">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="document-type-selection">
                  <label for="documentType">Document Type</label>
                  <select id="documentType" required>
                    <option value="">Select document type</option>
                    <option value="passport">Passport</option>
                    <option value="drivers_license">Driver's License</option>
                    <option value="id_card">Government ID Card</option>
                  </select>
                </div>

                <div class="form-buttons">
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="nextToSelfie"
                    disabled>
                    Continue
                  </button>
                </div>
              </div>

              <!-- Step 2: Selfie Capture -->
              <div class="step-content" data-step="2">
                <h3>Take a Selfie</h3>
                <p>
                  Please take a clear photo of your face. Make sure you're in a
                  well-lit area and your face is clearly visible.
                </p>

                <div class="selfie-capture-container">
                  <div class="video-container" id="videoContainer">
                    <video id="selfieVideo" autoplay playsinline></video>
                    <div class="face-outline"></div>
                    <button
                      type="button"
                      class="capture-button"
                      id="captureSelfie">
                      <svg
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                  </div>
                  <div
                    class="selfie-preview"
                    id="selfiePreview"
                    style="display: none">
                    <img src="" alt="Selfie Preview" />
                    <button
                      type="button"
                      class="remove-button"
                      id="removeSelfie">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="upload-alternative">
                  <p>Or upload a selfie:</p>
                  <div class="upload-area small" id="selfieUpload">
                    <div class="upload-icon small">
                      <svg
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <path
                          d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                      </svg>
                    </div>
                    <p>Click to upload</p>
                    <input
                      type="file"
                      id="selfieInput"
                      accept="image/*"
                      style="display: none" />
                  </div>
                </div>

                <div class="form-buttons">
                  <button type="button" class="btn" id="backToDocument">
                    Back
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="nextToReview"
                    disabled>
                    Continue
                  </button>
                </div>
              </div>

              <!-- Step 3: Review and Submit -->
              <div class="step-content" data-step="3">
                <h3>Review Information</h3>
                <p>Please review your information before submitting.</p>

                <div class="review-container">
                  <div class="review-item">
                    <h4>ID Document</h4>
                    <div
                      class="review-preview"
                      id="reviewDocumentPreview"></div>
                    <div class="review-details">
                      <p>
                        <strong>Document Type:</strong>
                        <span id="reviewDocumentType"></span>
                      </p>
                    </div>
                  </div>
                  <div class="review-item">
                    <h4>Selfie</h4>
                    <div class="review-preview" id="reviewSelfiePreview"></div>
                  </div>
                </div>

                <div class="verification-disclaimer">
                  <p>By submitting this information, you confirm that:</p>
                  <ul>
                    <li>
                      The ID document provided is valid and belongs to you
                    </li>
                    <li>
                      The selfie provided is current and shows your face clearly
                    </li>
                    <li>
                      You consent to The Give Hub verifying your identity using
                      this information
                    </li>
                  </ul>
                </div>

                <div class="form-buttons">
                  <button type="button" class="btn" id="backToSelfie">
                    Back
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="submitVerification">
                    Submit Verification
                  </button>
                </div>
              </div>

              <!-- Success State -->
              <div class="step-content" data-step="success">
                <div class="success-message">
                  <svg
                    class="success-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <h3>Verification Submitted</h3>
                  <p>
                    Your identity verification request has been submitted
                    successfully. We'll review your information and update your
                    verification status shortly.
                  </p>
                  <p class="review-time">
                    This process typically takes 1-2 business days.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      id="kyc-verification-reminder"
      class="verification-reminder"
      style="display: none">
      <div class="alert alert-warning">
        <h4>Identity Verification Required</h4>
        <p>
          To protect our community and comply with regulations, we need to
          verify your identity.
        </p>
        <p>This is a simple process that takes only a few minutes.</p>
        <button id="start-verification-btn" class="btn btn-primary">
          Start Verification
        </button>
      </div>
    </div>

    <script>
      (function () {
        const $ = (str) => document.querySelector(str);
        const $$ = (str) => document.querySelectorAll(str);

        const app = {
          data: {
            user: null,
            preferences: null,
            paymentMethods: [],
          },
          state: {
            currentSection: 'profile',
            loading: false,
            saveStatus: null,
          },
          config: {
            apiBase: location.protocol + "//" + location.hostname + '/api',
          },
          init() {
            // First check if user is authenticated
            const token = localStorage.getItem('accessToken');
            if (!token) {
              // window.location.href = '/pages/login.html';
              console.log("No token in init");
              return;
            }

            this.bindEvents();
            this.loadUserData();
          },
          bindEvents() {
            // Navigation
            $$('.nav-item').forEach((item) => {
              item.addEventListener('click', () => {
                this.changeSection(item.dataset.section);
              });
            });

            // Remove the form event listener and just use the button click
            const saveButton = $('button#saveChangesBtn');
            if (saveButton) {
              saveButton.addEventListener('click', (e) => {
                e.preventDefault();
                this.saveProfile();
              });
            }
            // Notification toggles
            $$('input[type="checkbox"]').forEach((toggle) => {
              toggle.addEventListener('change', () => {
                this.savePreferences();
              });
            });

            // Profile image change
            $('#changeImage').addEventListener('click', (e) => {
              e.preventDefault();
              this.setupAvatarUpload();
              // Logic to change the profile image
              // alert('Change image functionality not implemented yet.');
            });
            
            // Identity verification file uploads
            $('#idDocumentUpload').addEventListener('click', function() {
              $('#idDocumentInput').click();
            });
            
            $('#selfieUpload').addEventListener('click', function() {
              $('#selfieInput').click();
            });
            
            // Handle file selection for ID document
            $('#idDocumentInput').addEventListener('change', function(e) {
              if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                  $('#idDocumentPreview').style.display = 'block';
                  $('#idDocumentPreview img').src = e.target.result;
                  $('#nextToSelfie').disabled = false;
                };
                
                reader.readAsDataURL(file);
              }
            });
            
            // Handle file selection for selfie
            $('#selfieInput').addEventListener('change', function(e) {
              if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                  $('#selfiePreview').style.display = 'block';
                  $('#selfieVideo').style.display = 'none';
                  $('#selfiePreview img').src = e.target.result;
                  $('#nextToReview').disabled = false;
                };
                
                reader.readAsDataURL(file);
              }
            });
            
            // Handle remove buttons for uploaded files
            $('#removeIdDocument').addEventListener('click', function() {
              $('#idDocumentPreview').style.display = 'none';
              $('#idDocumentInput').value = '';
              $('#nextToSelfie').disabled = true;
            });
            
            $('#removeSelfie').addEventListener('click', function() {
              $('#selfiePreview').style.display = 'none';
              $('#selfieVideo').style.display = 'block';
              $('#selfieInput').value = '';
              $('#nextToReview').disabled = true;
            });
            
            // Step navigation for verification process
            $('#nextToSelfie').addEventListener('click', function() {
              $('.step-content[data-step="1"]').classList.remove('active');
              $('.step-content[data-step="2"]').classList.add('active');
              
              // Update step indicators
              $$('.step-indicator')[0].classList.add('completed');
              $$('.step-indicator')[1].classList.add('active');
              $$('.step-divider')[0].classList.add('completed');
              
              // Initialize webcam if available
              if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                  .then(function(stream) {
                    $('#selfieVideo').srcObject = stream;
                  })
                  .catch(function(error) {
                    console.error("Could not access camera:", error);
                  });
              }
            });
            
            $('#backToDocument').addEventListener('click', function() {
              $('.step-content[data-step="2"]').classList.remove('active');
              $('.step-content[data-step="1"]').classList.add('active');
              
              // Update step indicators
              $$('.step-indicator')[0].classList.remove('completed');
              $$('.step-indicator')[1].classList.remove('active');
              $$('.step-divider')[0].classList.remove('completed');
              
              // Stop webcam if it's running
              if ($('#selfieVideo').srcObject) {
                $('#selfieVideo').srcObject.getTracks().forEach(track => track.stop());
              }
            });
            
            $('#nextToReview').addEventListener('click', function() {
              $('.step-content[data-step="2"]').classList.remove('active');
              $('.step-content[data-step="3"]').classList.add('active');
              
              // Update step indicators
              $$('.step-indicator')[1].classList.add('completed');
              $$('.step-indicator')[2].classList.add('active');
              $$('.step-divider')[1].classList.add('completed');
              
              // Stop webcam if it's running
              if ($('#selfieVideo').srcObject) {
                $('#selfieVideo').srcObject.getTracks().forEach(track => track.stop());
              }
              
              // Show review images
              $('#reviewDocumentPreview').innerHTML = $('#idDocumentPreview').innerHTML;
              $('#reviewSelfiePreview').innerHTML = $('#selfiePreview').innerHTML;
              $('#reviewDocumentType').textContent = $('#documentType').value;
            });
            
            $('#backToSelfie').addEventListener('click', function() {
              $('.step-content[data-step="3"]').classList.remove('active');
              $('.step-content[data-step="2"]').classList.add('active');
              
              // Update step indicators
              $$('.step-indicator')[1].classList.remove('completed');
              $$('.step-indicator')[2].classList.remove('active');
              $$('.step-divider')[1].classList.remove('completed');
              
              // Re-initialize webcam
              if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                  .then(function(stream) {
                    $('#selfieVideo').srcObject = stream;
                  });
              }
            });
            
            // Handle selfie capture button
            $('#captureSelfie').addEventListener('click', function() {
              const canvas = document.createElement('canvas');
              const video = $('#selfieVideo');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              canvas.getContext('2d').drawImage(video, 0, 0);
              
              const dataUrl = canvas.toDataURL('image/png');
              $('#selfiePreview').style.display = 'block';
              $('#selfiePreview img').src = dataUrl;
              $('#videoContainer').style.display = 'none';
              $('#nextToReview').disabled = false;
            });
            
            // Submit verification
            $('#submitVerification').addEventListener('click', function() {
              $('.step-content[data-step="3"]').classList.remove('active');
              $('.step-content[data-step="success"]').classList.add('active');
              
              // Update verification status
              $('#verificationStatus .status-icon').classList.remove('pending');
              $('#verificationStatus .status-icon').classList.add('verified');
              $('#verificationStatus .status-icon').innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
              $('#verificationStatus .status-text h3').textContent = 'Verification Submitted';
              $('#verificationStatus .status-text p').textContent = 'We\'re reviewing your information. This typically takes 1-2 business days.';
              
              // Simulate API call to submit verification
              console.log('Verification submitted:', {
                documentType: $('#documentType').value,
                documentImage: $('#idDocumentPreview img').src,
                selfieImage: $('#selfiePreview img').src
              });
            });
          },
          setupAvatarUpload() {
              const input = document.createElement('input');
              input.type = 'file';
              input.accept = 'image/*';
              input.onchange = (e) => this.handleAvatarUpload(e);
              input.click();
          },
          async handleAvatarUpload(event) {
              const file = event.target.files[0];
              if (!file) return;

              if (!file.type.startsWith('image/')) {
                  this.showError('avatarError', 'Please select an image file');
                  return;
              }

              console.log('handleAvatarUload');

              try {
                  // Show preview
                  const reader = new FileReader();
                  reader.onload = (e) => {
                      document.getElementById('avatarImg').src = e.target.result;
                      document.getElementById('avatarImg').style.display = 'block';
                      document.getElementById('avatarImg').value = e.target.result;
                  };
                  reader.readAsDataURL(file);
                  console.log('prefetch1')

                  // Upload to server
                  const formData = new FormData();
                  formData.append('avatar', file);
                  formData.append('username', this.data.user.username);
                  formData.append('email', this.data.user.email);

                  console.log('prefetch')

                  const response = await fetch('/api/auth/upload-avatar', {
                      method: 'POST',
                      body: formData
                  });

                  console.log('response', response);

                  const result = await response.json();
                  if (!result.success) {
                      throw new Error(result.error || 'Failed to upload avatar');
                  }
                  
                  console.log('Avatar uploaded successfully:', result);

                  // Store the returned avatar URL
                  // document.getElementById('avatarImg').value = result.filename || result.url;
                  document.getElementById('avatarImg').src = result.url;
              } catch (error) {
                  this.showError('avatarError', error.message);
              }
          },          
          async loadUserData() {
            try {
              this.state.loading = true;
              // this.render();

              // Use our manager classes for consistent SDK handling
              const [user] = await Promise.all([
                app.settingsManager.getUserProfile()
              ]);

              const [preferences] = await Promise.all([
                app.settingsManager.getPreferences()
              ]);

              if (!user) {
                throw new Error('Failed to load user data');
              }

              console.log('Loaded user data:', user);
              console.log('Loaded preferences:', preferences);

              this.data.user = user;
              this.data.preferences = preferences;

              this.state.loading = false;
              this.render();
            } catch (error) {
              console.error('Error loading user data:', error);
              this.showError('Failed to load user data');

              // If token is invalid/missing, redirect to login
              if (error.message.includes('No authentication token')) {
                // window.location.href = '/pages/login.html';
                console.error("No token in loadUserData");
              }
            }
          },

          async fetchData(collection, id) {
            const url = `${this.config.apiBase}/${collection}${
              id ? `?id=${id}` : ''
            }`;
            const response = await fetch(url);
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
          },

          async saveProfile(evt) {
            try {
              if (evt) evt.preventDefault();

              const formData = {
                displayName: $('#displayName').value,
                personalInfo: {
                  firstName: $('#first_name').value,
                  lastName: $('#last_name').value,
                  phone: $('#phone')?.value,
                  email: $('#email')?.value,
                  location: $('#location')?.value,
                },
                email: $('#email').value,
                profile: {
                  bio: $('#bio').value,
                  avatar: $('#avatarImg').src.includes('color-logo.svg')
                    ? null
                    : $('#avatarImg').src.split('/').pop(), // Extract filename
                },
              };
            
              if ($("#location")) {
                  formData.personalInfo.localtion = $("#location").value;
              }
              console.log('Saving profile:', formData);
              await app.settingsManager.updateProfile(formData);
              this.showSuccess('Profile updated successfully');

              // Reload user data to ensure we have latest state
              await this.loadUserData();
            } catch (error) {
              console.error('Error saving profile:', error);
              this.showError('Failed to save profile');
            }

            return false;
          },

          async savePreferences() {
            try {
              const preferences = {
                emailNotifications: {
                  campaignUpdates: $('#notifCampaign').checked,
                  newDonations: $('#notifDonations').checked,
                  milestones: $('#notifMilestones').checked,
                  marketing: $('#notifMarketing').checked,
                },
              };

              await app.settingsManager.updatePreferences(preferences);
              this.showSuccess('Preferences updated successfully');
            } catch (error) {
              console.error('Error saving preferences:', error);
              this.showError('Failed to save preferences');
            }
          },

          async updateData(collection, id, data) {
            const url = `${this.config.apiBase}/${collection}?id=${id}`;
            const response = await fetch(url, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            });
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
          },

          changeSection(section) {
            this.state.currentSection = section;
            this.render();
          },

          getCurrentUserId() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
              window.location.href = '/pages/login.html';
              return null;
            }

            const decoded = app.api.decodeToken(token);
            return decoded?.sub; // 'sub' is the standard JWT claim for user ID
          },
          showSuccess(message) {
            this.state.saveStatus = { type: 'success', message };
            this.render();
            setTimeout(() => {
              this.state.saveStatus = null;
              this.render();
            }, 3000);
          },
          showError(message) {
            this.state.saveStatus = { type: 'error', message };
            this.render();
          },
          render() {
            // Update active section
            $$('.nav-item').forEach((item) => {
              item.classList.toggle(
                'active',
                item.dataset.section === this.state.currentSection
              );
            });
            $$('.settings-section').forEach((section) => {
              section.classList.toggle(
                'active',
                section.id === this.state.currentSection
              );
            });

            // Update save status message
            const statusEl = $('#saveStatus');
            if (this.state.saveStatus) {
              statusEl.textContent = this.state.saveStatus.message;
              statusEl.className = `success-message ${this.state.saveStatus.type}`;
              statusEl.style.display = 'block';
            } else {
              statusEl.style.display = 'none';
            }

            // Update form fields if data is loaded
            if (this.data.user && !this.state.loading) {
              $('#displayName').value = this.data.user.username || '';
              $('#first_name').value =
                this.data.user.personalInfo?.firstName || '';
              $('#last_name').value =
                this.data.user.personalInfo?.lastName || '';
              $('#phone').value = this.data.user.personalInfo?.phone || '';
              $('#email').value = this.data.user.email || '';
              $('#bio').value = this.data.user.profile?.bio || '';
              $('#avatarImg').src = this.data.user.profile?.avatar ? `../img/avatars/${this.data.user.profile?.avatar}`
                 :
                '../images/color-logo.svg';
            }

            // Update loading state
            document.body.classList.toggle('loading', this.state.loading);
          },
          // Check if KYC verification is required and show the reminder if needed
          async checkKycVerification() {
            try {
              // Only proceed if we have the KYC manager module
              if (!window.app || !window.app.kycManager) {
                return;
              }

              // Check if verification is required
              const isRequired =
                await window.app.kycManager.isVerificationRequired();

              if (isRequired) {
                document.getElementById(
                  'kyc-verification-reminder'
                ).style.display = 'block';

                // Add event listener to the verification button
                document
                  .getElementById('start-verification-btn')
                  .addEventListener('click', function () {
                    window.location.href = '/verification.html';
                    // pages/kyc-verification.html  ??
                  });
              }
            } catch (error) {
              console.error('Error checking KYC verification status:', error);
            }
          },
        };

        window.app = app;
        document.addEventListener('DOMContentLoaded', () => app.init());
        document.addEventListener('DOMContentLoaded', app.checkKycVerification);
      })();
    </script>
    <script src="/lib/APIConfig.js"></script>
    <script src="/lib/UserManager.js"></script>
    <script src="/lib/SettingsManager.js"></script>
  </body>
</html>
