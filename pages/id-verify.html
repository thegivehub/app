<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="module" src="../lib/LocationBlock.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Account Settings</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..800&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet" href="/css/login.css" />
    <link rel="stylesheet" href="/css/settings.css" />
    <style>
      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus {
        border-color: #4A90E2;
        outline: none;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
      }

      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
      }

      .review-details {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1rem 0;
      }

      .review-details h4 {
        color: #2c3e50;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
      }

      .review-details p {
        margin: 0.5rem 0;
        color: #495057;
      }

      .review-details strong {
        color: #2c3e50;
        font-weight: 500;
      }

      .step-indicator {
        position: relative;
        display: flex;
        align-items: center;
        padding: 0 1rem;
      }

      .step-indicator .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e9ecef;
        color: #495057;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 0.75rem;
        transition: all 0.3s;
      }

      .step-indicator.active .step-number {
        background: #4A90E2;
        color: white;
      }

      .step-indicator.completed .step-number {
        background: #28a745;
        color: white;
      }

      .step-divider {
        flex: 1;
        height: 2px;
        background: #e9ecef;
        margin: 0 1rem;
      }

      .step-divider.completed {
        background: #28a745;
      }

      /* Verification Report Styles */
      .verification-report {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        margin: 2rem 0;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
      }

      .verification-report h4 {
        color: #2c3e50;
        margin-bottom: 1.5rem;
        text-align: center;
        font-size: 1.5rem;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 1rem;
      }

      .report-section {
        margin-bottom: 2rem;
      }

      .report-section h5 {
        color: #4A90E2;
        margin-bottom: 1rem;
        font-size: 1.1rem;
      }

      .report-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
      }

      .report-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 6px;
      }

      .report-item .label {
        display: block;
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
      }

      .report-item .value {
        font-weight: 500;
        color: #343a40;
      }

      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        background: #ffc107;
        color: #212529;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .status-badge.approved {
        background: #28a745;
        color: white;
      }

      .status-badge.rejected {
        background: #dc3545;
        color: white;
      }

      .status-badge.pending {
        background: #ffc107;
        color: #212529;
      }

      .report-images {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }

      .report-image-container {
        text-align: center;
      }

      .report-image-container h5 {
        margin-bottom: 0.75rem;
      }

      .report-image {
        height: 200px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }

      .report-note {
        margin-top: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-left: 4px solid #4A90E2;
        border-radius: 4px;
      }

      .report-note p {
        margin: 0;
        font-size: 0.9rem;
        color: #495057;
      }
    </style>
  </head>
  <body>
    <div class="container">

      <div class="settings-content">
        <div id="saveStatus" class="success-message"></div>
          <!-- Identity Verification Section -->
          <div class="settings-section" id="verification">
            <h2>Identity Verification</h2>
            <p class="section-description">
              Verify your identity to gain full access to The Give Hub. This
              helps us maintain a trusted community and comply with regulations.
            </p>

            <div class="verification-status-container">
              <div class="verification-status" id="verificationStatus">
                <div class="status-icon pending">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                  </svg>
                </div>
                <div class="status-text">
                  <h3>Verification Pending</h3>
                  <p>Please complete the verification process below.</p>
                </div>
              </div>
            </div>

            <div class="verification-steps" id="verificationSteps">
              <div class="step-indicator">
                <div class="step-number">1</div>
                <span>Personal Information</span>
              </div>
              <div class="step-divider"></div>
              <div class="step-indicator">
                <div class="step-number">2</div>
                <span>Upload ID</span>
              </div>
              <div class="step-divider"></div>
              <div class="step-indicator">
                <div class="step-number">3</div>
                <span>Take Selfie</span>
              </div>
              <div class="step-divider"></div>
              <div class="step-indicator">
                <div class="step-number">4</div>
                <span>Review</span>
              </div>
            </div>

            <div class="verification-step-content" id="verificationStepContent">
              <!-- Step 1: Personal Information -->
              <div class="step-content active" data-step="1">
                <h3>Personal Information</h3>
                <p>Please provide your personal details exactly as they appear on your ID document.</p>

                <div class="form-group">
                  <label for="firstName">Legal First Name</label>
                  <input type="text" id="firstName" required>
                </div>

                <div class="form-group">
                  <label for="lastName">Legal Last Name</label>
                  <input type="text" id="lastName" required>
                </div>

                <div class="form-group">
                  <label for="dateOfBirth">Date of Birth</label>
                  <input type="date" id="dateOfBirth" required>
                </div>

                <div class="form-group">
                  <label for="address">Street Address</label>
                  <input type="text" id="address" required>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="city">City</label>
                    <input type="text" id="city" required>
                  </div>

                  <div class="form-group">
                    <label for="state">State/Province</label>
                    <input type="text" id="state" required>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="postalCode">Postal Code</label>
                    <input type="text" id="postalCode" required>
                  </div>

                  <div class="form-group">
                    <label for="country">Country</label>
                    <select id="country" required>
                      <option value="">Select country</option>
                      <option value="US">United States</option>
                      <option value="CA">Canada</option>
                      <!-- Add more countries as needed -->
                    </select>
                  </div>
                </div>

                <div class="form-buttons">
                  <button type="button" class="btn btn-primary" id="nextToDocument">
                    Continue
                  </button>
                </div>
              </div>

              <!-- Step 2: ID Document Upload -->
              <div class="step-content" data-step="2">
                <h3>Upload an identification document</h3>
                <p>
                  Please provide a clear photo of your government-issued ID
                  (passport, driver's license, or ID card).
                </p>

                <div class="document-type-selection">
                  <label for="documentType">Document Type</label>
                  <select id="documentType" required>
                    <option value="">Select document type</option>
                    <option value="passport">Passport</option>
                    <option value="drivers_license">Driver's License</option>
                    <option value="national_id">Government ID Card</option>
                    <option value="residence_permit">Residence Permit</option>
                  </select>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="documentNumber">Document Number</label>
                    <input type="text" id="documentNumber" required placeholder="Enter the ID number from your document">
                  </div>

                  <div class="form-group">
                    <label for="documentExpiry">Document Expiry Date</label>
                    <input type="date" id="documentExpiry" required>
                  </div>
                </div>

                <div class="document-upload-container">
                  <div class="upload-area" id="idDocumentUpload">
                    <div class="upload-icon">
                      <svg
                        width="48"
                        height="48"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <path
                          d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                      </svg>
                    </div>
                    <p>
                      Drag and drop your ID document here or click to browse
                    </p>
                    <input
                      type="file"
                      id="idDocumentInput"
                      name="document"
                      accept="image/*"
                      style="display: none" />
                  </div>
                  <div
                    class="document-preview"
                    id="idDocumentPreview"
                    style="display: none">
                    <img src="" alt="ID Document Preview" />
                    <button
                      type="button"
                      class="remove-button"
                      id="removeIdDocument">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="form-buttons">
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="nextToSelfie"
                    disabled>
                    Continue
                  </button>
                </div>
              </div>

              <!-- Step 3: Selfie Capture -->
              <div class="step-content" data-step="3">
                <h3>Take a Selfie</h3>
                <p>
                  Please take a clear photo of your face. Make sure you're in a
                  well-lit area and your face is clearly visible.
                </p>

                <div class="selfie-capture-container">
                  <div class="video-container" id="videoContainer">
                    <video id="selfieVideo" autoplay playsinline></video>
                    <div class="face-outline"></div>
                    <button
                      type="button"
                      class="capture-button"
                      id="captureSelfie">
                      <svg
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                  </div>
                  <div
                    class="selfie-preview"
                    id="selfiePreview"
                    style="display: none">
                    <img src="" alt="Selfie Preview" />
                    <button
                      type="button"
                      class="remove-button"
                      id="removeSelfie">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="upload-alternative">
                  <p>Or upload a selfie:</p>
                  <div class="upload-area small" id="selfieUpload">
                    <div class="upload-icon small">
                      <svg
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2">
                        <path
                          d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                      </svg>
                    </div>
                    <p>Click to upload</p>
                    <input
                      type="file"
                      id="selfieInput"
                      name="selfie"
                      accept="image/*"
                      style="display: none" />
                  </div>
                </div>

                <div class="form-buttons">
                  <button type="button" class="btn" id="backToDocument">
                    Back
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="nextToReview"
                    disabled>
                    Continue
                  </button>
                </div>
              </div>

              <!-- Step 4: Review and Submit -->
              <div class="step-content" data-step="4">
                <h3>Review Information</h3>
                <p>Please review your information before submitting.</p>

                <div class="review-container">
                  <div class="review-item">
                    <h4>ID Document</h4>
                    <div
                      class="review-preview"
                      id="reviewDocumentPreview"></div>
                    <div class="review-details">
                      <p>
                        <strong>Document Type:</strong>
                        <span id="reviewDocumentType"></span>
                      </p>
                    </div>
                  </div>
                  <div class="review-item">
                    <h4>Selfie</h4>
                    <div class="review-preview" id="reviewSelfiePreview"></div>
                  </div>
                </div>

                <div class="verification-disclaimer">
                  <p>By submitting this information, you confirm that:</p>
                  <ul>
                    <li>
                      The ID document provided is valid and belongs to you
                    </li>
                    <li>
                      The selfie provided is current and shows your face clearly
                    </li>
                    <li>
                      You consent to The Give Hub verifying your identity using
                      this information
                    </li>
                  </ul>
                </div>

                <div class="form-buttons">
                  <button type="button" class="btn" id="backToSelfie">
                    Back
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="submitVerification">
                    Submit Verification
                  </button>
                </div>
              </div>

              <!-- Success State -->
              <div class="step-content" data-step="success">
                <div class="success-message">
                  <svg
                    class="success-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <h3>Verification Submitted</h3>
                  <p>
                    Your identity verification request has been submitted
                    successfully. We'll review your information and update your
                    verification status shortly.
                  </p>
                  <p class="review-time">
                    This process typically takes 1-2 business days.
                  </p>
                </div>
                
                <div class="verification-report" id="verification-report">
                  <h4>Verification Report</h4>
                  <div class="report-section">
                    <h5>Personal Information</h5>
                    <div class="report-grid">
                      <div class="report-item">
                        <span class="label">Name:</span>
                        <span class="value" id="report-name"></span>
                      </div>
                      <div class="report-item">
                        <span class="label">Date of Birth:</span>
                        <span class="value" id="report-dob"></span>
                      </div>
                      <div class="report-item">
                        <span class="label">Address:</span>
                        <span class="value" id="report-address"></span>
                      </div>
                      <div class="report-item">
                        <span class="label">Location:</span>
                        <span class="value" id="report-location"></span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="report-section">
                    <h5>Document Information</h5>
                    <div class="report-grid">
                      <div class="report-item">
                        <span class="label">Document Type:</span>
                        <span class="value" id="report-doc-type"></span>
                      </div>
                      <div class="report-item">
                        <span class="label">Document Number:</span>
                        <span class="value" id="report-doc-number"></span>
                      </div>
                      <div class="report-item">
                        <span class="label">Expiry Date:</span>
                        <span class="value" id="report-doc-expiry"></span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="report-section">
                    <h5>Verification Status</h5>
                    <div class="report-grid">
                      <div class="report-item">
                        <span class="label">Status:</span>
                        <span class="value status-badge" id="report-status">Submitted</span>
                      </div>
                      <div class="report-item">
                        <span class="label">Submission Date:</span>
                        <span class="value" id="report-date"></span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="report-section">
                    <h5>Face Comparison Results</h5>
                    <div class="report-grid">
                      <div class="report-item">
                        <span class="label">Face Match Score:</span>
                        <span class="value" id="report-face-match"></span>
                      </div>
                      <div class="report-item">
                        <span class="label">Confidence Score:</span>
                        <span class="value" id="report-confidence"></span>
                      </div>
                      <div class="report-item">
                        <span class="label">Liveness Score:</span>
                        <span class="value" id="report-liveness"></span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="report-images">
                    <div class="report-image-container">
                      <h5>ID Document</h5>
                      <div class="report-image" id="report-doc-image"></div>
                    </div>
                    <div class="report-image-container">
                      <h5>Selfie</h5>
                      <div class="report-image" id="report-selfie-image"></div>
                    </div>
                  </div>
                  
                  <div class="report-note">
                    <p>
                      <strong>Note:</strong> Your verification information is secure and encrypted. It will only be used for the purpose of identity verification and will be handled according to our privacy policy.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      id="kyc-verification-reminder"
      class="verification-reminder"
      style="display: none">
      <div class="alert alert-warning">
        <h4>Identity Verification Required</h4>
        <p>
          To protect our community and comply with regulations, we need to
          verify your identity.
        </p>
        <p>This is a simple process that takes only a few minutes.</p>
        <button id="start-verification-btn" class="btn btn-primary">
          Start Verification
        </button>
      </div>
    </div>

    <script>
      (function () {
        const $ = (str) => document.querySelector(str);
        const $$ = (str) => document.querySelectorAll(str);

        const app = {
          data: {
            user: null,
            preferences: null,
            paymentMethods: [],
            capturedSelfie: null,
            documentId: null,
            verificationComplete: false
          },
          state: {
            currentSection: 'verification',
            loading: false,
            saveStatus: null,
          },
          config: {
            apiBase: location.protocol + "//" + location.hostname + '/api',
          },
          init() {
            // First check if user is authenticated
            const token = localStorage.getItem('accessToken');
            if (!token) {
              window.location.href = '/pages/login.html';
              return;
            }

            this.bindEvents();
            this.loadUserData();
          },
          bindEvents() {
            // Navigation
            $$('.nav-item').forEach((item) => {
              item.addEventListener('click', () => {
                this.changeSection(item.dataset.section);
              });
            });

            // Remove the form event listener and just use the button click
            const saveButton = $('button#saveChangesBtn');
            if (saveButton) {
              saveButton.addEventListener('click', (e) => {
                e.preventDefault();
                this.saveProfile();
              });
            }
            // Notification toggles
            $$('input[type="checkbox"]').forEach((toggle) => {
              toggle.addEventListener('change', () => {
                this.savePreferences();
              });
            });

            // Identity verification file uploads
            $('#idDocumentUpload').addEventListener('click', function() {
              $('#idDocumentInput').click();
            });
            
            $('#selfieUpload').addEventListener('click', function() {
              $('#selfieInput').click();
            });
            
            // Handle file selection for ID document
            $('#idDocumentInput').addEventListener('change', function(e) {
              if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                  $('#idDocumentPreview').style.display = 'block';
                  $('#idDocumentPreview img').src = e.target.result;
                  $('#nextToSelfie').disabled = false;
                };
                
                reader.readAsDataURL(file);
              }
            });
            
            // Handle file selection for selfie
            $('#selfieInput').addEventListener('change', function(e) {
              if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                  $('#selfiePreview').style.display = 'block';
                  $('#selfieVideo').style.display = 'none';
                  $('#selfiePreview img').src = e.target.result;
                  $('#nextToReview').disabled = false;
                };
                
                reader.readAsDataURL(file);
              }
            });
            
            // Handle remove buttons for uploaded files
            $('#removeIdDocument').addEventListener('click', function() {
              $('#idDocumentPreview').style.display = 'none';
              $('#idDocumentInput').value = '';
              $('#nextToSelfie').disabled = true;
            });
            
            $('#removeSelfie').addEventListener('click', function() {
              $('#selfiePreview').style.display = 'none';
              $('#selfieVideo').style.display = 'block';
              $('#selfieInput').value = '';
              $('#nextToReview').disabled = true;
            });
            
            // Add navigation between personal info and document upload
            $('#nextToDocument').addEventListener('click', async function() {
              // Validate personal information
              const requiredFields = ['firstName', 'lastName', 'dateOfBirth', 'address', 'city', 'state', 'postalCode', 'country'];
              const missingFields = requiredFields.filter(field => !$('#' + field).value);
              
              if (missingFields.length > 0) {
                alert('Please fill in all required fields: ' + missingFields.join(', '));
                return;
              }

              try {
                // Disable button while processing
                $('#nextToDocument').disabled = true;
                $('#nextToDocument').textContent = 'Processing...';
                
                // Collect personal information
                const personalInfo = {
                  firstName: $('#firstName').value,
                  lastName: $('#lastName').value,
                  dateOfBirth: $('#dateOfBirth').value,
                  address: $('#address').value,
                  city: $('#city').value,
                  state: $('#state').value,
                  postalCode: $('#postalCode').value,
                  country: $('#country').value,
                  status: 'pending'
                };
                
                console.log('Submitting personal info:', personalInfo);
                
                // Upload personal info and get document ID
                const result = await app.uploadPersonalInfo(personalInfo);
                if (result.documentId) {
                  app.data.documentId = result.documentId;
                  console.log('Personal info saved, document ID:', app.data.documentId);
                  
                  // Show success message (optional)
                  const statusMsg = document.createElement('div');
                  statusMsg.className = 'success-message';
                  statusMsg.textContent = 'Personal information saved successfully!';
                  statusMsg.style.marginBottom = '15px';
                  $('.step-content[data-step="1"]').appendChild(statusMsg);
                  
                  // Set a timeout to remove the message
                  setTimeout(() => {
                    if (statusMsg.parentNode) {
                      statusMsg.parentNode.removeChild(statusMsg);
                    }
                  }, 3000);
                } else {
                  throw new Error('Failed to get document ID from server');
                }
                
                // Proceed to next step
                $('.step-content[data-step="1"]').classList.remove('active');
                $('.step-content[data-step="2"]').classList.add('active');
                
                // Update step indicators
                $$('.step-indicator')[0].classList.add('completed');
                $$('.step-indicator')[1].classList.add('active');
                $$('.step-divider')[0].classList.add('completed');
              } catch (error) {
                console.error('Error saving personal information:', error);
                alert(error.message || 'Failed to save personal information');
              } finally {
                $('#nextToDocument').disabled = false;
                $('#nextToDocument').textContent = 'Continue';
              }
            });
            
            // Step navigation for verification process
            $('#nextToSelfie').addEventListener('click', async function() {
              // Validate document information
              const requiredFields = ['documentType', 'documentNumber', 'documentExpiry'];
              const missingFields = requiredFields.filter(field => !$('#' + field).value);
              
              if (missingFields.length > 0) {
                alert('Please fill in all required fields: ' + missingFields.join(', '));
                return;
              }

              if (!$('#idDocumentInput').files[0]) {
                alert('Please upload your ID document');
                return;
              }

              try {
                // Disable button while processing
                $('#nextToSelfie').disabled = true;
                
                // Upload the document
                const documentFile = $('#idDocumentInput').files[0];
                const documentInfo = {
                  documentType: $('#documentType').value,
                  documentNumber: $('#documentNumber').value,
                  documentExpiry: $('#documentExpiry').value
                };
                
                const result = await app.uploadDocumentFile(documentFile, documentInfo);
                console.log('Document upload result:', result);
                
                // Proceed to next step
                $('.step-content[data-step="2"]').classList.remove('active');
                $('.step-content[data-step="3"]').classList.add('active');
                
                // Update step indicators
                $$('.step-indicator')[1].classList.add('completed');
                $$('.step-indicator')[2].classList.add('active');
                $$('.step-divider')[1].classList.add('completed');
                
                // Initialize webcam
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                  navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                      $('#selfieVideo').srcObject = stream;
                    })
                    .catch(function(error) {
                      console.error("Could not access camera:", error);
                    });
                }
              } catch (error) {
                console.error('Error uploading document:', error);
                alert(error.message || 'Failed to upload document');
              } finally {
                $('#nextToSelfie').disabled = false;
              }
            });
            
            $('#nextToReview').addEventListener('click', async function() {
              try {
                // Disable button while processing
                $('#nextToReview').disabled = true;
                
                // Check if we have a selfie to upload
                const selfieFile = app.data.capturedSelfie || $('#selfieInput').files[0];
                if (!selfieFile) {
                  throw new Error('Please take or upload a selfie');
                }
                
                // Upload the selfie
                console.log('Uploading selfie...', selfieFile);
                const selfieResult = await app.uploadSelfie(selfieFile, app.data.documentId);
                console.log('Selfie upload result:', selfieResult);
                
                // Proceed to review step
                $('.step-content[data-step="3"]').classList.remove('active');
                $('.step-content[data-step="4"]').classList.add('active');
                
                // Update step indicators
                $$('.step-indicator')[2].classList.add('completed');
                $$('.step-indicator')[3].classList.add('active');
                $$('.step-divider')[2].classList.add('completed');
                
                // Stop webcam
                if ($('#selfieVideo').srcObject) {
                  $('#selfieVideo').srcObject.getTracks().forEach(track => track.stop());
                }
                
                // Update review section with all collected information
                $('#reviewDocumentPreview').innerHTML = $('#idDocumentPreview').innerHTML;
                $('#reviewSelfiePreview').innerHTML = $('#selfiePreview').innerHTML;
                $('#reviewDocumentType').textContent = $('#documentType').value;

                // Add personal information to review
                const reviewDetails = document.createElement('div');
                reviewDetails.classList.add('review-details');
                reviewDetails.innerHTML = `
                  <h4>Personal Information</h4>
                  <p><strong>Name:</strong> ${$('#firstName').value} ${$('#lastName').value}</p>
                  <p><strong>Date of Birth:</strong> ${$('#dateOfBirth').value}</p>
                  <p><strong>Address:</strong> ${$('#address').value}</p>
                  <p><strong>City:</strong> ${$('#city').value}</p>
                  <p><strong>State:</strong> ${$('#state').value}</p>
                  <p><strong>Postal Code:</strong> ${$('#postalCode').value}</p>
                  <p><strong>Country:</strong> ${$('#country').value}</p>
                  <h4>Document Information</h4>
                  <p><strong>Document Type:</strong> ${$('#documentType').value}</p>
                  <p><strong>Document Number:</strong> ${$('#documentNumber').value}</p>
                  <p><strong>Expiry Date:</strong> ${$('#documentExpiry').value}</p>
                `;
                $('.review-container').appendChild(reviewDetails);
              } catch (error) {
                console.error('Error uploading selfie:', error);
                alert(error.message || 'Failed to upload selfie');
              } finally {
                $('#nextToReview').disabled = false;
              }
            });
            
            // Submit verification
            $('#submitVerification').addEventListener('click', async function() {
              try {
                $('#submitVerification').disabled = true;
                
                // Mark verification as reviewed/complete
                const result = await app.completeVerification(app.data.documentId);
                console.log('Verification completed:', result);
                
                // Show success state
                $('.step-content[data-step="4"]').classList.remove('active');
                $('.step-content[data-step="success"]').classList.add('active');
                
                app.data.verificationComplete = true;
                
              } catch (error) {
                console.error('Verification completion error:', error);
                alert(error.message || 'Failed to complete verification');
              } finally {
                $('#submitVerification').disabled = false;
              }
            });

            // Back navigation
            $('#backToDocument').addEventListener('click', function() {
              $('.step-content[data-step="3"]').classList.remove('active');
              $('.step-content[data-step="2"]').classList.add('active');
              
              // Update step indicators
              $$('.step-indicator')[1].classList.remove('completed');
              $$('.step-indicator')[2].classList.remove('active');
              $$('.step-divider')[1].classList.remove('completed');
              
              // Stop webcam
              if ($('#selfieVideo').srcObject) {
                $('#selfieVideo').srcObject.getTracks().forEach(track => track.stop());
              }
            });
            
            // Handle selfie capture button
            $('#captureSelfie').addEventListener('click', function() {
              const canvas = document.createElement('canvas');
              const video = $('#selfieVideo');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              canvas.getContext('2d').drawImage(video, 0, 0);
              
              // Convert the canvas to a blob and store globally
              canvas.toBlob(function(blob) {
                // Create a File object from the blob
                const capturedFile = new File([blob], "selfie.png", { type: "image/png" });
                
                // Store the file in the app data object instead of on the input element
                app.data.capturedSelfie = capturedFile;
                console.log("Selfie captured:", capturedFile);
                
                // Update the preview
                const dataUrl = canvas.toDataURL('image/png');
                $('#selfiePreview').style.display = 'block';
                $('#selfiePreview img').src = dataUrl;
                $('#videoContainer').style.display = 'none';
                $('#nextToReview').disabled = false;
              }, 'image/png');
            });
          },
          setupAvatarUpload() {
              const input = document.createElement('input');
              input.type = 'file';
              input.accept = 'image/*';
              input.onchange = (e) => this.handleAvatarUpload(e);
              input.click();
          },
          async handleAvatarUpload(event) {
              const file = event.target.files[0];
              if (!file) return;

              if (!file.type.startsWith('image/')) {
                  this.showError('avatarError', 'Please select an image file');
                  return;
              }

              console.log('handleAvatarUload');

              try {
                  // Show preview
                  const reader = new FileReader();
                  reader.onload = (e) => {
                      document.getElementById('avatarImg').src = e.target.result;
                      document.getElementById('avatarImg').style.display = 'block';
                      document.getElementById('avatarImg').value = e.target.result;
                  };
                  reader.readAsDataURL(file);
                  console.log('prefetch1')

                  // Upload to server
                  const formData = new FormData();
                  formData.append('avatar', file);
                  formData.append('username', this.data.user.username);
                  formData.append('email', this.data.user.email);

                  console.log('prefetch')

                  const response = await fetch('/api/auth/upload-avatar', {
                      method: 'POST',
                      headers: {
                          'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                      },
                      body: formData
                  });

                  console.log('response', response);

                  const result = await response.json();
                  if (!result.success) {
                      throw new Error(result.error || 'Failed to upload avatar');
                  }
                  
                  console.log('Avatar uploaded successfully:', result);

                  // Store the returned avatar URL
                  // document.getElementById('avatarImg').value = result.filename || result.url;
                  document.getElementById('avatarImg').src = result.url;
              } catch (error) {
                  this.showError('avatarError', error.message);
              }
          },          
          async loadUserData() {
            try {
              this.state.loading = true;
              // this.render();

              // Use our manager classes for consistent SDK handling
              const [user] = await Promise.all([
                app.settingsManager.getUserProfile()
              ]);

              const [preferences] = await Promise.all([
                app.settingsManager.getPreferences()
              ]);

              if (!user) {
                throw new Error('Failed to load user data');
              }

              console.log('Loaded user data:', user);
              console.log('Loaded preferences:', preferences);

              this.data.user = user;
              this.data.preferences = preferences;

              this.state.loading = false;
              this.render();
            } catch (error) {
              console.error('Error loading user data:', error);
              this.showError('Failed to load user data');

              // If token is invalid/missing, redirect to login
              if (error.message.includes('No authentication token')) {
                window.location.href = '/pages/login.html';
              }
            }
          },

          async fetchData(collection, id) {
            const url = `${this.config.apiBase}/${collection}${
              id ? `?id=${id}` : ''
            }`;
            const response = await fetch(url, {
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
              }
            });
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
          },

          async saveProfile(evt) {
            try {
              if (evt) evt.preventDefault();

              const formData = {
                displayName: $('#displayName').value,
                personalInfo: {
                  firstName: $('#first_name').value,
                  lastName: $('#last_name').value,
                  phone: $('#phone').value,
                  email: $('#email').value,
                  location: $('#location').value,
                },
                email: $('#email').value,
                profile: {
                  bio: $('#bio').value,
                  avatar: $('#avatarImg').src.includes('color-logo.svg')
                    ? null
                    : $('#avatarImg').src.split('/').pop(), // Extract filename
                },
              };

              console.log('Saving profile:', formData);
              await app.settingsManager.updateProfile(formData);
              this.showSuccess('Profile updated successfully');

              // Reload user data to ensure we have latest state
              await this.loadUserData();
            } catch (error) {
              console.error('Error saving profile:', error);
              this.showError('Failed to save profile');
            }

            return false;
          },

          async savePreferences() {
            try {
              const preferences = {
                emailNotifications: {
                  campaignUpdates: $('#notifCampaign').checked,
                  newDonations: $('#notifDonations').checked,
                  milestones: $('#notifMilestones').checked,
                  marketing: $('#notifMarketing').checked,
                },
              };

              await app.settingsManager.updatePreferences(preferences);
              this.showSuccess('Preferences updated successfully');
            } catch (error) {
              console.error('Error saving preferences:', error);
              this.showError('Failed to save preferences');
            }
          },

          async updateData(collection, id, data) {
            const url = `${this.config.apiBase}/${collection}?id=${id}`;
            const response = await fetch(url, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
              },
              body: JSON.stringify(data),
            });
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
          },

          changeSection(section) {
            this.state.currentSection = section;
            this.render();
          },

          getCurrentUserId() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
              window.location.href = '/pages/login.html';
              return null;
            }

            const decoded = app.api.decodeToken(token);
            return decoded?.sub; // 'sub' is the standard JWT claim for user ID
          },
          showSuccess(message) {
            this.state.saveStatus = { type: 'success', message };
            this.render();
            setTimeout(() => {
              this.state.saveStatus = null;
              this.render();
            }, 3000);
          },
          showError(message) {
            this.state.saveStatus = { type: 'error', message };
            this.render();
          },
          render() {
            // Update active section
            $$('.nav-item').forEach((item) => {
              item.classList.toggle(
                'active',
                item.dataset.section === this.state.currentSection
              );
            });
            $$('.settings-section').forEach((section) => {
              section.classList.toggle(
                'active',
                section.id === this.state.currentSection
              );
            });

            // Update save status message
            const statusEl = $('#saveStatus');
            if (this.state.saveStatus) {
              statusEl.textContent = this.state.saveStatus.message;
              statusEl.className = `success-message ${this.state.saveStatus.type}`;
              statusEl.style.display = 'block';
            } else {
              statusEl.style.display = 'none';
            }

           // Update loading state
            document.body.classList.toggle('loading', this.state.loading);
          },
          // Check if KYC verification is required and show the reminder if needed
          async checkKycVerification() {
            try {
              // Only proceed if we have the KYC manager module
              if (!window.app || !window.app.kycManager) {
                return;
              }

              // Check if verification is required
              const isRequired =
                await window.app.kycManager.isVerificationRequired();

              if (isRequired) {
                document.getElementById(
                  'kyc-verification-reminder'
                ).style.display = 'block';

                // Add event listener to the verification button
                document
                  .getElementById('start-verification-btn')
                  .addEventListener('click', function () {
                    window.location.href = '/verification.html';
                    // pages/kyc-verification.html  ??
                  });
              }
            } catch (error) {
              console.error('Error checking KYC verification status:', error);
            }
          },
          async uploadPersonalInfo(personalData) {
            try {
              // Store personal data in the application state for later use
              Object.assign(this.data, personalData);
              
              // Format the date correctly for MongoDB
              const formattedData = {
                ...personalData,
                status: "pending"
              };

              console.log('Sending document data:', formattedData);

              // Send the data to the server
              const response = await fetch(this.config.apiBase + '/document/create', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                },
                body: JSON.stringify(formattedData)
              });

              // Log the raw response for debugging
              const responseText = await response.text();
              console.log('Server response text:', responseText);
              
              // Parse the response as JSON
              let result;
              try {
                result = JSON.parse(responseText);
              } catch (e) {
                console.error('Failed to parse response as JSON:', e);
                throw new Error(`Invalid server response: ${responseText}`);
              }

              if (!result.success) {
                throw new Error(result.error || 'Failed to save personal information');
              }

              // Store document ID for next steps
              const documentId = result.documentId;
              if (!documentId) {
                throw new Error('No document ID returned from server');
              }

              console.log('Personal info saved, document ID:', documentId);

              // Return object with documentId directly as required by nextToDocument handler
              return {
                success: true,
                documentId: documentId
              };
            } catch (error) {
              console.error('Error processing personal information:', error);
              throw error;
            }
          },

          async uploadDocumentFile(file, documentInfo) {
            const formData = new FormData();
            
            // Add the file
            formData.append('document', file);
            
            // Add document type parameter to match backend expectation
            formData.append('type', 'document');
            formData.append('documentType', documentInfo.documentType);
            
            // Add document ID from previous step 
            if (this.data.documentId) {
              formData.append('documentId', this.data.documentId);
              console.log('Including document ID in upload:', this.data.documentId);
            } else {
              console.error('No document ID available for document upload');
            }
            
            // Add document metadata
            if (documentInfo.documentNumber) formData.append('documentNumber', documentInfo.documentNumber);
            if (documentInfo.documentExpiry) formData.append('documentExpiry', documentInfo.documentExpiry);

            try {
              console.log('Uploading document with form data...');
              
              // Log FormData for debugging
              for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + (pair[1] instanceof File ? pair[1].name + ' (' + pair[1].size + ' bytes)' : pair[1]));
              }
              
              const response = await fetch(this.config.apiBase + '/document/upload', {
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                },
                body: formData
              });

              // Get the full response text for debugging
              const responseText = await response.text();
              console.log('Document upload response:', responseText);
              
              // Try to parse as JSON
              let result;
              try {
                result = JSON.parse(responseText);
              } catch (e) {
                console.error('Failed to parse response as JSON:', e);
                throw new Error(`Invalid server response: ${responseText}`);
              }

              if (!result.success) {
                throw new Error(result.error || 'Failed to upload document');
              }

              // Store document ID for selfie upload if not already set
              if (result.documentId && !this.data.documentId) {
                this.data.documentId = result.documentId;
                console.log('Document uploaded, ID:', this.data.documentId);
              }

              return result;
            } catch (error) {
              console.error('Error uploading document:', error);
              throw error;
            }
          },

          async uploadSelfie(file, documentId) {
            // Use document ID from parameter or app data
            const docId = documentId || this.data.documentId;
            if (!docId) {
              throw new Error('Document ID is required to upload selfie');
            }

            const formData = new FormData();
            
            // Debug the file object
            console.log("uploadSelfie received file:", file);
            console.log("File name:", file.name);
            console.log("File type:", file.type);
            console.log("File size:", file.size);
            
            // Use the correct field name that the server expects
            formData.append('selfie', file);
            
            // Set type to selfie for backend
            formData.append('type', 'selfie');
            
            // Add the document ID 
            formData.append('documentId', docId);

            try {
              // Log FormData for debugging
              console.log('FormData entries:');
              for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + (pair[1] instanceof File ? pair[1].name + ' (' + pair[1].size + ' bytes)' : pair[1]));
              }
              
              const response = await fetch(this.config.apiBase + '/document/upload', {
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                },
                body: formData
              });
              
              // Get full response text for debugging
              const responseText = await response.text();
              console.log('Selfie upload response:', responseText);
              
              // Try to parse the response as JSON
              let result;
              try {
                result = JSON.parse(responseText);
              } catch (e) {
                console.error('Failed to parse response as JSON:', e);
                throw new Error(`Invalid server response: ${responseText}`);
              }
              
              if (!result.success) {
                throw new Error(result.error || 'Failed to upload selfie');
              }

              console.log('Selfie upload successful:', result);
              return result;
            } catch (error) {
              console.error('Error uploading selfie:', error);
              throw error;
            }
          },
          
          async completeVerification(documentId) {
            try {
              if (!documentId) {
                throw new Error('Document ID is required to complete verification');
              }
              
              console.log('Completing verification for document ID:', documentId);
              
              // First try the reviewed parameter approach
              try {
                const response = await fetch(this.config.apiBase + '/document/verify', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                  },
                  body: JSON.stringify({
                    documentId: documentId,
                    reviewed: true
                  })
                });

                // Get full response text for debugging
                const responseText = await response.text();
                console.log('Verification completion response:', responseText);
                
                // Try to parse response as JSON
                let result;
                try {
                  result = JSON.parse(responseText);
                } catch (e) {
                  console.error('Failed to parse response as JSON:', e);
                  throw new Error(`Invalid server response: ${responseText}`);
                }

                if (!result.success) {
                  throw new Error(result.error || 'Failed to complete verification');
                }

                console.log('Verification completed successfully:', result);
                
                // Populate the verification report with user's data
                this.populateVerificationReport(documentId);
                
                return result;
              } catch (error) {
                console.error('First verification attempt failed:', error);
                
                // If the first approach fails, try the direct verification approach
                console.log('Trying direct verification approach');
                
                const response = await fetch(this.config.apiBase + '/document/verify/' + documentId, {
                  method: 'GET',
                  headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                  }
                });
                
                const responseText = await response.text();
                console.log('Direct verification response:', responseText);
                
                let result;
                try {
                  result = JSON.parse(responseText);
                } catch (e) {
                  console.error('Failed to parse direct verification response as JSON:', e);
                  throw new Error(`Invalid server response: ${responseText}`);
                }
                
                if (!result.success) {
                  throw new Error(result.error || 'Failed to complete verification');
                }
                
                // Populate the verification report with user's data
                this.populateVerificationReport(documentId);
                
                return result;
              }
            } catch (error) {
              console.error('Error completing verification:', error);
              throw error;
            }
          },
          
          // New function to populate the verification report
          populateVerificationReport(documentId) {
            try {
              // Get the values from the form elements
              const firstName = $('#firstName').value;
              const lastName = $('#lastName').value;
              const dateOfBirth = $('#dateOfBirth').value;
              const address = $('#address').value;
              const city = $('#city').value;
              const state = $('#state').value;
              const postalCode = $('#postalCode').value;
              const country = $('#country').value;
              const documentType = $('#documentType').value;
              const documentNumber = $('#documentNumber').value;
              const documentExpiry = $('#documentExpiry').value;
              
              // Format the date of birth nicely
              const dob = new Date(dateOfBirth);
              const formattedDob = dob.toLocaleDateString('en-US', {
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
              });
              
              // Format document type to be more readable
              const documentTypeMap = {
                'passport': 'Passport',
                'drivers_license': 'Driver\'s License',
                'national_id': 'National ID Card',
                'residence_permit': 'Residence Permit'
              };
              
              const formattedDocType = documentTypeMap[documentType] || documentType;
              
              // Format document expiry date
              const expiry = new Date(documentExpiry);
              const formattedExpiry = expiry.toLocaleDateString('en-US', {
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
              });
              
              // Format submission date (current date)
              const now = new Date();
              const formattedSubmissionDate = now.toLocaleDateString('en-US', {
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
              
              // Populate the report fields
              $('#report-name').textContent = `${firstName} ${lastName}`;
              $('#report-dob').textContent = formattedDob;
              $('#report-address').textContent = address;
              $('#report-location').textContent = `${city}, ${state} ${postalCode}, ${country}`;
              
              $('#report-doc-type').textContent = formattedDocType;
              $('#report-doc-number').textContent = documentNumber;
              $('#report-doc-expiry').textContent = formattedExpiry;
              
              $('#report-status').textContent = 'Submitted';
              $('#report-status').classList.add('pending');
              $('#report-date').textContent = formattedSubmissionDate;
              
              // Get the document and selfie image previews
              const docImgSrc = $('#idDocumentPreview img').src;
              const selfieImgSrc = $('#selfiePreview img').src;
              
              // Set the background images for the report
              $('#report-doc-image').style.backgroundImage = `url(${docImgSrc})`;
              $('#report-selfie-image').style.backgroundImage = `url(${selfieImgSrc})`;
              
              // Add face comparison results if available
              if (result.verificationResult) {
                const faceMatch = result.verificationResult.similarity 
                  ? `${Math.round(result.verificationResult.similarity * 100)}%` 
                  : 'N/A';
                const confidence = result.verificationResult.confidence 
                  ? `${Math.round(result.verificationResult.confidence * 100)}%` 
                  : 'N/A';
                const liveness = result.verificationResult.liveness 
                  ? `${Math.round(result.verificationResult.liveness * 100)}%` 
                  : 'N/A';
                
                $('#report-face-match').textContent = faceMatch;
                $('#report-confidence').textContent = confidence;
                $('#report-liveness').textContent = liveness;
              } else {
                $('#report-face-match').textContent = 'N/A';
                $('#report-confidence').textContent = 'N/A';
                $('#report-liveness').textContent = 'N/A';
              }
              
              console.log('Verification report populated successfully');
            } catch (error) {
              console.error('Error populating verification report:', error);
            }
          },
        };

        window.app = app;
        document.addEventListener('DOMContentLoaded', () => app.init());
        document.addEventListener('DOMContentLoaded', app.checkKycVerification);
      })();
    </script>
    <script src="/lib/APIConfig.js"></script>
    <script src="/lib/UserManager.js"></script>
    <script src="/lib/SettingsManager.js"></script>
  </body>
</html>
